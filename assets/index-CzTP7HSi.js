import{aF as e,aG as z,aH as T,aI as Q,aC as d,aJ as j,aK as b,aL as S,aM as V,aN as $,aO as P,aP as K,aQ as Y,aR as R,aS as J,aT as G,aU as H,aV as _,az as N,aW as U,aX as W,aY as X,aZ as Z,a_ as ee,a$ as B,b0 as te,b1 as se}from"./react-LYHHyQqO.js";import{u as g,a as L,b as ne,c as oe,w as ae,i as ce,d as re,e as ie,f as le,W as de}from"./web3-CX8zFCq4.js";import"./walletconnect-B01gpFfU.js";(function(){const s=document.createElement("link").relList;if(s&&s.supports&&s.supports("modulepreload"))return;for(const c of document.querySelectorAll('link[rel="modulepreload"]'))n(c);new MutationObserver(c=>{for(const o of c)if(o.type==="childList")for(const u of o.addedNodes)u.tagName==="LINK"&&u.rel==="modulepreload"&&n(u)}).observe(document,{childList:!0,subtree:!0});function r(c){const o={};return c.integrity&&(o.integrity=c.integrity),c.referrerPolicy&&(o.referrerPolicy=c.referrerPolicy),c.crossOrigin==="use-credentials"?o.credentials="include":c.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function n(c){if(c.ep)return;c.ep=!0;const o=r(c);fetch(c.href,o)}})();const D=({eth:t})=>e.jsx("div",{children:e.jsx("img",{src:`https://effigy.im/a/${t}.svg`,alt:"Profile picture",className:"profilePic"})});function ue(){const{address:t}=g();return e.jsx("div",{className:"ChatSidebar",children:e.jsx("div",{className:"profilePicture",children:t&&e.jsx(D,{eth:t})})})}const he={apiKey:"AIzaSyBRDBbrJbmLwb3YTI_YBmMdTjLEd8KjS2E",authDomain:"tokenchat-b8673.firebaseapp.com",projectId:"tokenchat-b8673",storageBucket:"tokenchat-b8673.appspot.com",messagingSenderId:"593980787293",appId:"1:593980787293:web:7c58ff7656a3fa31b19bb4",measurementId:"G-RB9WJLVQC0"},k=z(he);T(k);const C=Q(k);function fe({setSelectedChatId:t,users:s,getWalletById:r}){const{address:n}=g(),[c,o]=d.useState([]),[u,h]=d.useState(null);d.useEffect(()=>{if(!n)return;(async()=>{try{const m=j(C,"privateChats"),F=(await b(m)).docs.map(M=>{const q=M.data();return{id:M.id,pid:q.pid||[]}});o(F)}catch(m){h("Failed to fetch data. Please check your internet connection."),console.error("Fetch error:",m)}})()},[n]);const a=s.find(l=>l.wallet===n),i=a?c.filter(l=>l.pid.includes(a.id)):[],f=l=>{const m=s.find(I=>I.id===l);return m?m.name:l},x=l=>a&&l.find(m=>m!==a.id)||"",p=l=>{const m=x(l);return f(m)},v=l=>{t(l)};return e.jsxs("div",{className:"chatSelector",children:[u&&e.jsx("p",{className:"error",children:u}),i.length>0?i.map(l=>e.jsxs("div",{className:"contactBox",onClick:()=>v(l.id),children:[e.jsx(D,{eth:r(x(l.pid))}),e.jsxs("div",{className:"contactTextBox",children:[e.jsx("h3",{children:p(l.pid)}),e.jsx("h3",{children:"latest message"})]})]},l.id)):e.jsx("p",{children:"No chatrooms available"})]})}const A=d.createContext(void 0),me=({children:t})=>{const[s,r]=d.useState(void 0);return e.jsx(A.Provider,{value:{currentUser:s,setCurrentUser:r},children:t})},E=()=>{const t=d.useContext(A);if(!t)throw new Error("useUser must be used within a UserProvider");return t},pe=async(t,s,r)=>{try{const n=j(C,"privateChats",r,"msg");await $(n,{txt:t,from:s,ts:new Date}),console.log("Message sent successfully")}catch(n){console.error("Error sending message:",n)}},ge=({selectedChatId:t})=>{const[s,r]=S.useState(""),{currentUser:n}=E(),c=u=>{r(u.target.value)},o=()=>{if(!t||!n||!s.trim()){console.error("Missing required data:",{selectedChatId:t,currentUser:n,inputValue:s});return}pe(s,n.id,t),r("")};return e.jsxs("div",{className:"chatBottomBar",children:[e.jsx("input",{type:"text",className:"messageInput",placeholder:"Type your message",value:s,onChange:c}),e.jsx("button",{className:"sendMessageButton",onClick:o,disabled:!t||!n,title:"Send message",children:e.jsx(V,{size:20})})]})};function xe({children:t,selectedChatId:s}){return e.jsxs("div",{className:"chatWindow",children:[e.jsx("div",{className:"chatContent",children:t})," ",e.jsx(ge,{selectedChatId:s})]})}const je=({text:t,timeStamp:s,from:r,own:n})=>e.jsx("div",{className:"messageBox",children:e.jsxs("div",{className:`message ${n?"own":""}`,children:[e.jsx("p",{className:"message-text",children:t}),e.jsx("p",{className:"message-timestamp",children:new Date(s).toLocaleString()})]})});function Ce({selectedChatId:t,users:s,getWalletById:r}){const[n,c]=d.useState([]);g();const{currentUser:o}=E(),u=d.useRef(null),h=()=>{var a;(a=u.current)==null||a.scrollIntoView({behavior:"smooth"})};return d.useEffect(()=>{h()},[n]),d.useEffect(()=>{if(!t)return;const a=j(C,"privateChats",t,"msg"),i=P(a,K("ts","asc")),f=Y(i,x=>{const p=[];x.forEach(v=>{const l=v.data();l.txt&&l.ts&&l.from?p.push(l):console.log("Missing fields in document:",v.id)}),console.log("Real-time Messages Update:",p),c(p)},x=>{console.error("Error fetching messages:",x)});return()=>f()},[t]),e.jsxs("div",{className:"chatContent",children:[n.map((a,i)=>{const f=o!=null&&o.id?a.from===o.id:!1;return e.jsx(je,{text:a.txt,timeStamp:a.ts.toMillis(),from:a.from,own:f},i)}),e.jsx("div",{ref:u})," "]})}function ve(){const{address:t}=g(),[s,r]=d.useState(null),[n,c]=d.useState([]),{setCurrentUser:o}=E();d.useEffect(()=>{(async()=>{const i=j(C,"users"),x=(await b(i)).docs.map(p=>({id:p.id,name:p.data().name,wallet:p.data().wallet}));c(x)})()},[]),d.useEffect(()=>{if(n.length>0&&t){const a=n.find(i=>i.wallet===t);console.log("Current User:",a),o(a)}},[n,t,o]);const u=a=>{r(a)},h=a=>{const i=n.find(f=>f.id===a);return i?i.wallet:""};return e.jsxs("div",{className:"chat",children:[e.jsx(ue,{}),e.jsx(fe,{setSelectedChatId:u,users:n,getWalletById:h}),e.jsx(xe,{selectedChatId:s||void 0,children:s&&e.jsx(Ce,{selectedChatId:s,users:n,getWalletById:h})})]})}function we(){const{address:t}=g(),[s,r]=d.useState(null),n=R(),c=async o=>{const u=j(C,"users"),h=P(u,G("wallet","==",o));try{const i=!(await b(h)).empty;console.log("User found:",i),r(i),n(i?"/chat":"/signup")}catch(a){console.error("Error checking user:",a),r(!1),n("/signup")}};return e.jsxs("div",{children:[e.jsxs("button",{className:"proceedButton",onClick:()=>{t?c(t):console.error("Address is undefined")},children:[e.jsx(J,{size:28}),e.jsx("span",{children:"Proceed"})]}),s!==null&&e.jsx("p",{children:s?"User exists":"User does not exist"})]})}function ye(){const{address:t,isConnected:s}=g(),{disconnect:r}=L(),n=async()=>{localStorage.removeItem("walletconnect"),localStorage.removeItem("walletConnected"),localStorage.removeItem("connectorId"),r()};return e.jsx("div",{className:"wallet-button",children:s&&t?e.jsxs("div",{className:"walletBubble",children:[e.jsxs("div",{className:"address",children:[t.slice(0,6),"...",t.slice(-4)]}),e.jsx("button",{onClick:n,children:e.jsx(H,{size:25})})]}):e.jsx("w3m-connect-button",{})})}function be(){const{address:t,isConnected:s,connector:r}=g(),{connect:n,connectors:c}=ne();L();const[o,u]=d.useState(s);return R(),d.useEffect(()=>{if(localStorage.getItem("walletConnected")==="true"&&!s){console.log("Attempting to reconnect wallet automatically...");const a=localStorage.getItem("connectorId");if(console.log("Last used connector:",a),a){const i=c.find(f=>f.id===a);i&&(console.log("Reconnecting with saved connector:",a),n({connector:i}))}else{const i=c.find(f=>f.id==="injected");i&&(console.log("No saved connector, trying injected..."),n({connector:i}))}}},[n,c,s]),d.useEffect(()=>{console.log("Connection state changed:",s?"connected":"disconnected"),console.log("Current connector:",r==null?void 0:r.id),u(s),s&&!o&&console.log("Wallet newly connected:",t),!s&&o&&console.log("Wallet disconnected")},[s,t,o,r]),d.useEffect(()=>{const h=()=>{o&&!s&&(console.log("Connection lost while page was inactive, updating UI"),u(!1))};return window.addEventListener("focus",h),()=>{window.removeEventListener("focus",h)}},[o,s]),e.jsxs("div",{className:"homepage",children:[e.jsxs("div",{className:"title",children:[e.jsx("h1",{children:"Chat 3.0 is here."}),e.jsx("h2",{children:"Your personal web3 companion."})]}),e.jsx("div",{children:e.jsxs("div",{className:"login",children:[e.jsx("h3",{children:o?`Connected ${r!=null&&r.id?`(${r.id})`:""}`:"Connect your wallet"}),e.jsx(ye,{}),o&&e.jsx(we,{})]})})]})}const Se=new _,y="02ee764d5cc25cff6387d6d3f7943fd6",w={name:"TokenChat",description:"Web3 Chat Application",url:"https://c4ctus96.github.io/tokenchat",icons:["https://avatars.githubusercontent.com/u/37784886"]},Ne=[N,W],O=oe({chains:Ne,transports:{[N.id]:U(),[W.id]:U()},connectors:[ae({projectId:y,metadata:w,showQrModal:!1}),ce({shimDisconnect:!0}),re({appName:w.name,appLogoUrl:w.icons[0]}),ie({options:{projectId:y},socials:["google","x","github","discord","apple"],showWallets:!0,email:!0,walletFeatures:!1})]});le({wagmiConfig:O,projectId:y,defaultChain:N,themeMode:"dark",enableAnalytics:!0,enableOnramp:!1});function Ee({children:t}){const{isConnected:s}=g();return s?e.jsx(e.Fragment,{children:t}):e.jsx(te,{to:"/"})}function Ie(){const{isConnected:t}=g();return d.useEffect(()=>{console.log("App initialized, connection status:",t),typeof window.ethereum>"u"&&console.log("MetaMask not detected, but WalletConnect can still be used")},[t]),null}function Me(){return e.jsx(S.StrictMode,{children:e.jsx(de,{config:O,children:e.jsx(X,{client:Se,children:e.jsxs(me,{children:[e.jsx(Ie,{}),e.jsx(Z,{children:e.jsxs(ee,{children:[e.jsx(B,{path:"/",element:e.jsx(be,{})}),e.jsx(B,{path:"/chat",element:e.jsx(Ee,{children:e.jsx(ve,{})})})]})})]})})})})}const Ue=document.getElementById("root"),Be=se(Ue);Be.render(e.jsx(S.StrictMode,{children:e.jsx(Me,{})}));
//# sourceMappingURL=index-CzTP7HSi.js.map
