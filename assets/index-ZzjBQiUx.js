import{aH as e,aI as J,aJ as _,aK as G,aE as l,aL as v,aM as M,aN as T,aO as X,aP as B,aQ as N,aR as z,aS as K,aT as Z,aU as E,aV as A,aW as q,aX as F,aY as ee,aZ as D,a_ as te,a$ as U,b0 as se,b1 as ne,b2 as Q,b3 as O,aC as W,b4 as ae,b5 as re,b6 as oe,b7 as R,b8 as ce,b9 as ie}from"./react-DXMD1Rfz.js";import{u as S,a as Y,b as le,c as de,w as ue,i as he,d as ge,e as fe,f as me,W as pe}from"./web3-CHTXMhTX.js";import"./walletconnect-CVZl8Tic.js";(function(){const s=document.createElement("link").relList;if(s&&s.supports&&s.supports("modulepreload"))return;for(const d of document.querySelectorAll('link[rel="modulepreload"]'))a(d);new MutationObserver(d=>{for(const o of d)if(o.type==="childList")for(const i of o.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&a(i)}).observe(document,{childList:!0,subtree:!0});function r(d){const o={};return d.integrity&&(o.integrity=d.integrity),d.referrerPolicy&&(o.referrerPolicy=d.referrerPolicy),d.crossOrigin==="use-credentials"?o.credentials="include":d.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function a(d){if(d.ep)return;d.ep=!0;const o=r(d);fetch(d.href,o)}})();const L=({eth:t})=>e.jsx("div",{children:e.jsx("img",{src:`https://effigy.im/a/${t}.svg`,alt:"Profile picture",className:"profilePic"})});function xe(){const{address:t}=S();return e.jsx("div",{className:"ChatSidebar",children:e.jsx("div",{className:"profilePicture",children:t&&e.jsx(L,{eth:t})})})}const je={apiKey:"AIzaSyBRDBbrJbmLwb3YTI_YBmMdTjLEd8KjS2E",authDomain:"tokenchat-b8673.firebaseapp.com",projectId:"tokenchat-b8673",storageBucket:"tokenchat-b8673.appspot.com",messagingSenderId:"593980787293",appId:"1:593980787293:web:7c58ff7656a3fa31b19bb4",measurementId:"G-RB9WJLVQC0"},V=J(je);_(V);const C=G(V);function ye({setSelectedChatId:t,users:s,getWalletById:r}){const{address:a}=S(),[d,o]=l.useState([]),[i,g]=l.useState(null);l.useEffect(()=>{if(!a)return;const n=v(C,"privateChats"),c=M(n,p=>{try{const w=p.docs.map(j=>{const b=j.data();return{id:j.id,pid:b.pid||[]}});console.log("Real-time chatrooms update:",w),o(w),g(null)}catch(w){g("Failed to fetch chat data. Please check your internet connection."),console.error("Snapshot error:",w)}},p=>{g("Failed to fetch data. Please check your internet connection."),console.error("Fetch error:",p)});return()=>c()},[a]);const f=s.find(n=>n.wallet===a),u=f?d.filter(n=>n.pid.includes(f.id)):[],m=n=>{const c=s.find(p=>p.id===n);return c?c.name:n},x=n=>f&&n.find(c=>c!==f.id)||"",y=n=>{const c=x(n);return m(c)},h=n=>{t(n)};return e.jsxs("div",{className:"chatSelector",children:[i&&e.jsx("p",{className:"error",children:i}),u.length>0?u.map(n=>e.jsxs("div",{className:"contactBox",onClick:()=>h(n.id),children:[e.jsx(L,{eth:r(x(n.pid))}),e.jsxs("div",{className:"contactTextBox",children:[e.jsx("h3",{children:y(n.pid)}),e.jsx("h3",{children:"latest message"})]})]},n.id)):e.jsx("p",{children:"No chatrooms available"})]})}const $=l.createContext(void 0),we=({children:t})=>{const[s,r]=l.useState(void 0);return e.jsx($.Provider,{value:{currentUser:s,setCurrentUser:r},children:t})},k=()=>{const t=l.useContext($);if(!t)throw new Error("useUser must be used within a UserProvider");return t},be=async(t,s,r)=>{try{const a=v(C,"privateChats",r,"msg");await B(a,{txt:t,from:s,ts:new Date}),console.log("Message sent successfully")}catch(a){console.error("Error sending message:",a)}},Ce=({selectedChatId:t})=>{const[s,r]=T.useState(""),{currentUser:a}=k(),d=g=>{r(g.target.value)},o=()=>{if(!t||!a||!s.trim()){console.error("Missing required data:",{selectedChatId:t,currentUser:a,inputValue:s});return}be(s,a.id,t),r("")},i=g=>{g.key==="Enter"&&o()};return e.jsxs("div",{className:"chatBottomBar",children:[e.jsx("input",{type:"text",className:"messageInput",placeholder:"Type your message",value:s,onChange:d,onKeyDown:i}),e.jsx("button",{className:"sendMessageButton",onClick:o,disabled:!t||!a,title:"Send message",children:e.jsx(X,{size:20})})]})};function ve({children:t,selectedChatId:s}){return e.jsxs("div",{className:"chatWindow",children:[e.jsx("div",{className:"chatContent",children:t})," ",e.jsx(Ce,{selectedChatId:s})]})}const Se=({text:t,timeStamp:s,from:r,own:a})=>e.jsx("div",{className:"messageBox",children:e.jsxs("div",{className:`message ${a?"own":""}`,children:[e.jsx("p",{className:"message-text",children:t}),e.jsx("p",{className:"message-timestamp",children:new Date(s).toLocaleString()})]})});function Ne({selectedChatId:t,users:s,getWalletById:r}){const[a,d]=l.useState([]),{address:o}=S(),{currentUser:i}=k(),g=l.useRef(null),f=()=>{var u;(u=g.current)==null||u.scrollIntoView({behavior:"smooth"})};return l.useEffect(()=>{f()},[a]),l.useEffect(()=>{if(!t)return;const u=v(C,"privateChats",t,"msg"),m=N(u,z("ts","asc")),x=M(m,y=>{const h=[];y.forEach(n=>{const c=n.data();c.txt&&c.ts&&c.from?h.push(c):console.log("Missing fields in document:",n.id)}),console.log("Real-time Messages Update:",h),d(h)},y=>{console.error("Error fetching messages:",y)});return()=>x()},[t]),e.jsxs("div",{className:"chatContent",children:[a.map((u,m)=>{const x=i!=null&&i.id?u.from===i.id:!1;return e.jsx(Se,{text:u.txt,timeStamp:u.ts.toMillis(),from:u.from,own:x},m)}),e.jsx("div",{ref:g})," "]})}const Ee=({onClose:t,onChatCreated:s})=>{const[r,a]=l.useState([]),[d,o]=l.useState(!0),[i,g]=l.useState(null),[f,u]=l.useState(null),{currentUser:m}=k();l.useEffect(()=>{(async()=>{try{o(!0);const n=v(C,"users"),p=(await E(n)).docs.map(j=>({id:j.id,name:j.data().name,wallet:j.data().wallet,chats:j.data().chats||[]})),w=m?p.filter(j=>j.id!==m.id):p;a(w)}catch(n){console.error("Error fetching users:",n),u("Failed to load users. Please try again.")}finally{o(!1)}})()},[m]);const x=async h=>{if(!m)return null;try{const n=v(C,"privateChats"),c=N(n),p=await E(c);for(const w of p.docs){const b=w.data().pid||[];if(b.includes(m.id)&&b.includes(h))return w.id}return null}catch(n){return console.error("Error checking existing chat:",n),null}},y=async h=>{if(!m){u("You must be logged in to create a chat");return}g(h.id),u(null);try{const n=await x(h.id);if(n){console.log("Chat already exists:",n),s&&s(n),t();return}const c=v(C,"privateChats"),p=await B(c,{pid:[m.id,h.id],createdAt:new Date,lastActivity:new Date});console.log("Created new chat with ID:",p.id);const w=A(C,"users",m.id),j=A(C,"users",h.id);await Promise.all([q(w,{chats:F(p.id)}),q(j,{chats:F(p.id)})]),console.log("Updated users' chat lists"),s&&s(p.id),t()}catch(n){console.error("Error creating chat:",n),u("Failed to create chat. Please try again.")}finally{g(null)}};return e.jsx("div",{className:"modalOverlay",children:e.jsxs("div",{className:"modalContent",children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"20px"},children:[e.jsx("h2",{children:"Start New Chat"}),e.jsx("button",{className:"closeButton",onClick:t,style:{background:"transparent",border:"none",color:"#fff",cursor:"pointer",padding:"5px"},children:e.jsx(K,{size:20})})]}),f&&e.jsx("div",{style:{color:"#ff4444",marginBottom:"15px",padding:"10px",background:"rgba(255, 68, 68, 0.1)",borderRadius:"8px"},children:f}),d?e.jsx("div",{style:{textAlign:"center",padding:"20px"},children:e.jsx("p",{children:"Loading users..."})}):r.length===0?e.jsx("div",{style:{textAlign:"center",padding:"20px"},children:e.jsx("p",{children:"No other users found."})}):e.jsxs("div",{style:{maxHeight:"400px",overflowY:"auto",scrollbarWidth:"thin",scrollbarColor:"rgba(255, 255, 255, 0.2) transparent",paddingRight:"8px"},className:"modal-scroll-area",children:[e.jsx("p",{style:{marginBottom:"15px",color:"#ccc"},children:"Select a user to start chatting:"}),e.jsx("div",{style:{display:"flex",flexDirection:"column",gap:"10px"},children:r.map(h=>e.jsxs("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between",padding:"12px",background:"rgba(255, 255, 255, 0.05)",borderRadius:"8px",border:"1px solid rgba(255, 255, 255, 0.1)"},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"12px"},children:[e.jsx(L,{eth:h.wallet}),e.jsxs("div",{children:[e.jsx("h4",{style:{margin:0,fontSize:"16px"},children:h.name}),e.jsxs("p",{style:{margin:0,fontSize:"12px",color:"#ccc",fontFamily:"monospace"},children:[h.wallet.slice(0,6),"...",h.wallet.slice(-4)]})]})]}),e.jsx("button",{onClick:()=>y(h),disabled:i===h.id,style:{background:i===h.id?"#666":"#50b458",border:"none",borderRadius:"50%",width:"40px",height:"40px",display:"flex",alignItems:"center",justifyContent:"center",cursor:i===h.id?"not-allowed":"pointer",color:"#fff",transition:"all 0.2s ease"},onMouseEnter:n=>{i!==h.id&&(n.target.style.background="#5bc464",n.target.style.transform="scale(1.05)")},onMouseLeave:n=>{i!==h.id&&(n.target.style.background="#50b458",n.target.style.transform="scale(1)")},children:i===h.id?e.jsx("div",{style:{width:"16px",height:"16px",border:"2px solid #fff",borderTop:"2px solid transparent",borderRadius:"50%",animation:"spin 1s linear infinite"}}):e.jsx(Z,{size:18})})]},h.id))})]}),e.jsx("style",{children:`
          @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
          }
          
          .modal-scroll-area::-webkit-scrollbar {
            width: 6px;
          }
          
          .modal-scroll-area::-webkit-scrollbar-track {
            background: transparent;
          }
          
          .modal-scroll-area::-webkit-scrollbar-thumb {
            background-color: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
          }
        `})]})})};function Ue(){const{address:t}=S(),[s,r]=l.useState(null),[a,d]=l.useState([]),{setCurrentUser:o}=k(),[i,g]=l.useState(!1);l.useEffect(()=>{(async()=>{const y=v(C,"users"),n=(await E(y)).docs.map(c=>({id:c.id,name:c.data().name,wallet:c.data().wallet}));d(n)})()},[]),l.useEffect(()=>{if(a.length>0&&t){const x=a.find(y=>y.wallet===t);console.log("Current User:",x),o(x)}},[a,t,o]);const f=x=>{r(x)},u=x=>{console.log("New chat created with ID:",x),r(x)},m=x=>{const y=a.find(h=>h.id===x);return y?y.wallet:""};return e.jsxs("div",{className:"chat",children:[e.jsx(xe,{}),e.jsx(ye,{setSelectedChatId:f,users:a,getWalletById:m}),e.jsx(ve,{selectedChatId:s||void 0,children:s&&e.jsx(Ne,{selectedChatId:s,users:a,getWalletById:m})}),e.jsx("button",{className:"createChatButton",onClick:()=>g(!0),title:"Start new chat",children:e.jsx(ee,{size:32})}),i&&e.jsx(Ee,{onClose:()=>g(!1),onChatCreated:u})]})}function ke(){const{address:t}=S(),[s,r]=l.useState(null),a=D(),d=async o=>{const i=v(C,"users"),g=N(i,U("wallet","==",o));try{const u=!(await E(g)).empty;console.log("User found:",u),r(u),a(u?"/chat":"/signup")}catch(f){console.error("Error checking user:",f),r(!1),a("/signup")}};return e.jsxs("div",{children:[e.jsxs("button",{className:"proceedButton",onClick:()=>{t?d(t):console.error("Address is undefined")},children:[e.jsx(te,{size:28}),e.jsx("span",{children:"Proceed"})]}),s!==null&&e.jsx("p",{children:s?"User exists":"User does not exist"})]})}function Re(){const{address:t,isConnected:s}=S(),{disconnect:r}=Y(),a=async()=>{localStorage.removeItem("walletconnect"),localStorage.removeItem("walletConnected"),localStorage.removeItem("connectorId"),r()};return e.jsx("div",{className:"wallet-button",children:s&&t?e.jsxs("div",{className:"walletBubble",children:[e.jsxs("div",{className:"address",children:[t.slice(0,6),"...",t.slice(-4)]}),e.jsx("button",{onClick:a,children:e.jsx(K,{size:25})})]}):e.jsx("w3m-connect-button",{})})}function Ie(){const{address:t,isConnected:s,connector:r}=S(),{connect:a,connectors:d}=le();Y();const[o,i]=l.useState(s);return D(),l.useEffect(()=>{if(localStorage.getItem("walletConnected")==="true"&&!s){console.log("Attempting to reconnect wallet automatically...");const f=localStorage.getItem("connectorId");if(console.log("Last used connector:",f),f){const u=d.find(m=>m.id===f);u&&(console.log("Reconnecting with saved connector:",f),a({connector:u}))}else{const u=d.find(m=>m.id==="injected");u&&(console.log("No saved connector, trying injected..."),a({connector:u}))}}},[a,d,s]),l.useEffect(()=>{console.log("Connection state changed:",s?"connected":"disconnected"),console.log("Current connector:",r==null?void 0:r.id),i(s),s&&!o&&console.log("Wallet newly connected:",t),!s&&o&&console.log("Wallet disconnected")},[s,t,o,r]),l.useEffect(()=>{const g=()=>{o&&!s&&(console.log("Connection lost while page was inactive, updating UI"),i(!1))};return window.addEventListener("focus",g),()=>{window.removeEventListener("focus",g)}},[o,s]),e.jsxs("div",{className:"homepage",children:[e.jsxs("div",{className:"title",children:[e.jsx("h1",{children:"Chat 3.0 is here."}),e.jsx("h2",{children:"Your personal web3 companion."})]}),e.jsx("div",{children:e.jsxs("div",{className:"login",children:[e.jsx("h3",{children:o?`Connected ${r!=null&&r.id?`(${r.id})`:""}`:"Connect your wallet"}),e.jsx(Re,{}),o&&e.jsx(ke,{})]})})]})}function Pe(){const{address:t}=S(),s=D(),[r,a]=l.useState(""),[d,o]=l.useState(null),[i,g]=l.useState(!1),[f,u]=l.useState(!1),[m,x]=l.useState(!0);l.useEffect(()=>{(async()=>{if(t){x(!0);try{const p=v(C,"users"),w=N(p,U("wallet","==",t)),b=!(await E(w)).empty;u(b),b&&(console.log("User already exists, redirecting to chat"),s("/chat"))}catch(p){console.error("Error checking if user exists:",p)}finally{x(!1)}}})()},[t,s]);const y=async()=>{const c=v(C,"users"),p=N(c,z("name"),se(10)),j=(await E(p)).docs.map(b=>({id:b.id,...b.data()}));o({users:j}),console.log("Fetched data:",j)};l.useEffect(()=>{y()},[]);const h=async()=>{if(!t||!r.trim()){console.error("Missing required data: address or name");return}if(f){console.log("User already exists, cannot register again");return}g(!0),console.log("Writing data:",t,r);try{const c=v(C,"users"),p=N(c,U("wallet","==",t));if(!(await E(p)).empty){console.log("User already exists, cannot register"),u(!0),g(!1),s("/chat");return}const j=M(N(c,U("wallet","==",t)),b=>{b.empty||(console.log("User successfully registered, redirecting to chat"),j(),s("/chat"))},b=>{console.error("Error in onSnapshot listener:",b),g(!1)});await B(c,{wallet:t,name:r.trim()}),console.log("Data written successfully"),setTimeout(()=>{j(),i&&(g(!1),console.log("Registration timeout, stopped listening"))},1e4)}catch(c){console.error("Error writing data:",c),g(!1)}},n=c=>{c.key==="Enter"&&!i&&!f&&r.trim()&&h()};return m?e.jsx("div",{className:"centered-signup",children:e.jsxs("div",{className:"welcomeText",children:[e.jsx("h1",{children:"Checking registration status..."}),e.jsx("h2",{children:"Please wait"})]})}):f?e.jsxs("div",{className:"centered-signup",children:[e.jsxs("div",{className:"welcomeText",children:[e.jsx("h1",{children:"Already Registered"}),e.jsx("h2",{children:"You're already signed up! Redirecting to chat..."})]}),e.jsxs("p",{children:["Wallet Address: ",t]})]}):e.jsxs("div",{className:"centered-signup",children:[e.jsxs("div",{className:"welcomeText",children:[e.jsx("h1",{children:"Welcome to Chat 3.0"}),e.jsx("h2",{children:"One last step to start chatting"})]}),e.jsxs("p",{children:["Wallet Address: ",t]}),e.jsxs("div",{className:"signupBox",children:[e.jsx("input",{type:"text",placeholder:"Enter name",value:r,onChange:c=>a(c.target.value),onKeyPress:n,disabled:i,maxLength:50}),e.jsx("button",{onClick:h,disabled:i||!r.trim(),children:i?"Registering...":"Register"})]}),i&&e.jsx("p",{style:{color:"#50b458",marginTop:"10px"},children:"Creating your account, please wait..."})]})}const Me=new ne,P="02ee764d5cc25cff6387d6d3f7943fd6",I={name:"TokenChat",description:"Web3 Chat Application",url:"https://c4ctus96.github.io/tokenchat",icons:["https://avatars.githubusercontent.com/u/37784886"]},Be=[W,Q],H=de({chains:Be,transports:{[W.id]:O("https://eth-mainnet.g.alchemy.com/v2/demo"),[Q.id]:O("https://arb-mainnet.g.alchemy.com/v2/demo")},connectors:[ue({projectId:P,metadata:I,showQrModal:!1}),he({shimDisconnect:!0}),ge({appName:I.name,appLogoUrl:I.icons[0]}),fe({options:{projectId:P},socials:["google","x","github","discord","apple"],showWallets:!0,email:!0,walletFeatures:!1})]});me({wagmiConfig:H,projectId:P,defaultChain:W,themeMode:"dark",enableAnalytics:!0,enableOnramp:!1,themeVariables:{"--w3m-accent":"#50b458","--w3m-color-mix":"#210059","--w3m-color-mix-strength":30}});function De({children:t}){const{isConnected:s}=S();return s?e.jsx(e.Fragment,{children:t}):e.jsx(ce,{to:"/"})}function We(){const{isConnected:t}=S();return l.useEffect(()=>{console.log("App initialized, connection status:",t),typeof window.ethereum>"u"&&console.log("MetaMask not detected, but WalletConnect can still be used")},[t]),null}function Le(){return e.jsx(pe,{config:H,children:e.jsx(ae,{client:Me,children:e.jsx(we,{children:e.jsxs(re,{basename:"/tokenchat",children:[e.jsx(We,{}),e.jsxs(oe,{children:[e.jsx(R,{path:"/",element:e.jsx(Ie,{})}),e.jsx(R,{path:"/chat",element:e.jsx(De,{children:e.jsx(Ue,{})})}),e.jsx(R,{path:"/signup",element:e.jsx(Pe,{})})]})]})})})})}const Ae=document.getElementById("root"),qe=ie(Ae);qe.render(e.jsx(T.StrictMode,{children:e.jsx(Le,{})}));
//# sourceMappingURL=index-ZzjBQiUx.js.map
