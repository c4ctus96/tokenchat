import{aI as be,aJ as ye,aK as ve,aL as e,aE as i,aM as B,aN as W,aO as A,aP as Q,aQ as q,aR as U,aS as de,aT as Ne,aU as G,aV as J,aW as ee,aX as Ce,aY as Se,aZ as ke,a_ as _,a$ as Ee,b0 as Y,b1 as se,b2 as te,b3 as Te,b4 as Me,b5 as ne,b6 as Ie,b7 as X,b8 as De,b9 as L,ba as Re,bb as ue,bc as ae,aC as Z,bd as Be,be as Pe,bf as Ae,bg as O,bh as Ue,bi as Fe}from"./react-CQBx--mm.js";import{u as P,a as ze,b as Le,c as We,d as qe,e as he,f as He,g as Oe,w as $e,i as Ve,h as Qe,j as Ye,k as Ke,W as Ge}from"./web3-B-JEOUY4.js";import"./walletconnect-C3c6QnuQ.js";(function(){const s=document.createElement("link").relList;if(s&&s.supports&&s.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))n(r);new MutationObserver(r=>{for(const a of r)if(a.type==="childList")for(const d of a.addedNodes)d.tagName==="LINK"&&d.rel==="modulepreload"&&n(d)}).observe(document,{childList:!0,subtree:!0});function o(r){const a={};return r.integrity&&(a.integrity=r.integrity),r.referrerPolicy&&(a.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?a.credentials="include":r.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function n(r){if(r.ep)return;r.ep=!0;const a=o(r);fetch(r.href,a)}})();const Je={apiKey:"AIzaSyBRDBbrJbmLwb3YTI_YBmMdTjLEd8KjS2E",authDomain:"tokenchat-b8673.firebaseapp.com",projectId:"tokenchat-b8673",storageBucket:"tokenchat-b8673.appspot.com",messagingSenderId:"593980787293",appId:"1:593980787293:web:7c58ff7656a3fa31b19bb4",measurementId:"G-RB9WJLVQC0"},me=be(Je);ye(me);const M=ve(me),H=({eth:t})=>e.jsx("div",{children:e.jsx("img",{src:`https://effigy.im/a/${t}.svg`,alt:"Profile picture",className:"profilePic"})});function oe({setSelectedChatId:t,users:s,getWalletById:o,selectedChatId:n}){const{address:r}=P(),[a,d]=i.useState([]),[y,p]=i.useState(null);i.useEffect(()=>{if(!r)return;const c=B(M,"privateChats"),f=W(c,async u=>{var I;try{const D=[];for(const k of u.docs){const T=k.data(),S={id:k.id,pid:T.pid||[]};try{const x=B(M,"privateChats",k.id,"msg"),v=A(x,q("ts","desc"),Q(1)),E=await U(v);if(E.empty)S.lastMessage="No messages yet",S.lastMessageTime=new Date(0);else{const R=E.docs[0].data();S.lastMessage=R.txt||"",S.lastMessageTime=((I=R.ts)==null?void 0:I.toDate())||new Date}}catch(x){console.error(`Error fetching messages for chat ${k.id}:`,x),S.lastMessage="Failed to load",S.lastMessageTime=new Date(0)}D.push(S)}D.sort((k,T)=>{var v,E;const S=((v=k.lastMessageTime)==null?void 0:v.getTime())||0;return(((E=T.lastMessageTime)==null?void 0:E.getTime())||0)-S}),console.log("Real-time chatrooms update:",D),d(D),p(null)}catch(D){p("Failed to fetch chat data. Please check your internet connection."),console.error("Snapshot error:",D)}},u=>{p("Failed to fetch data. Please check your internet connection."),console.error("Fetch error:",u)});return()=>f()},[r]),i.useEffect(()=>{(async()=>{if("Notification"in window&&Notification.permission==="default"){const f=await Notification.requestPermission();console.log("Notification permission:",f)}})()},[]),i.useEffect(()=>{if(!r||a.length===0)return;const c=s.find(u=>u.wallet===r);if(!c)return;const f=[];return a.forEach(u=>{if(u.pid.includes(c.id)){const I=B(M,"privateChats",u.id,"msg"),D=A(I,q("ts","desc"),Q(1)),k=W(D,T=>{if(!T.empty&&u.id!==n){const S=T.docs[0].data();if(S.from!==c.id){const x=C(S.from);w(x,S.txt)}}});f.push(k)}}),()=>{f.forEach(u=>u())}},[a,r,s,n]);const w=(c,f)=>{if("Notification"in window&&Notification.permission==="granted"){const u=f.length>50?f.substring(0,50)+"...":f;new Notification(`New message from ${c}`,{body:u,icon:"/favicon.ico",badge:"/favicon.ico",tag:"new-message"})}},g=s.find(c=>c.wallet===r),h=g?a.filter(c=>c.pid.includes(g.id)):[],C=c=>{const f=s.find(u=>u.id===c);return f?f.name:c},m=c=>g&&c.find(f=>f!==g.id)||"",j=c=>{const f=m(c);return C(f)},b=(c,f=40)=>c.length<=f?c:c.substring(0,f)+"...",l=c=>{t(c)};return e.jsxs("div",{className:"chatSelector",children:[y&&e.jsx("p",{className:"error",children:y}),h.length>0?h.map(c=>e.jsxs("div",{className:"contactBox",onClick:()=>l(c.id),style:{backgroundColor:c.id===n?"#003344":"#002233",cursor:"pointer"},children:[e.jsx(H,{eth:o(m(c.pid))}),e.jsxs("div",{className:"contactTextBox",children:[e.jsx("h3",{style:{fontSize:"16px",fontWeight:"bold"},children:j(c.pid)}),e.jsx("p",{style:{margin:0,fontSize:"14px",color:"#ccc",opacity:.8,lineHeight:"1.2"},children:b(c.lastMessage||"No messages yet")})]})]},c.id)):e.jsxs("div",{style:{padding:"20px",textAlign:"center",color:"#ccc"},children:[e.jsx("p",{children:"No chats yet"}),e.jsx("p",{style:{fontSize:"14px",marginTop:"10px"},children:"Click the + button to start a new conversation"})]})]})}const fe=i.createContext(void 0),_e=({children:t})=>{const[s,o]=i.useState(void 0);return e.jsx(fe.Provider,{value:{currentUser:s,setCurrentUser:o},children:t})},z=()=>{const t=i.useContext(fe);if(!t)throw new Error("useUser must be used within a UserProvider");return t},Xe=async(t,s,o,n="text",r)=>{try{const a=B(M,"privateChats",o,"msg");await J(a,{txt:t,from:s,ts:new Date,type:n}),console.log("Message sent successfully")}catch(a){console.error("Error sending message:",a)}},Ze=({selectedChatId:t,onSendTransaction:s,recipientUser:o})=>{const[n,r]=de.useState(""),{currentUser:a}=z(),d=g=>{r(g.target.value)},y=()=>{if(!t||!a||!n.trim()){console.error("Missing required data:",{selectedChatId:t,currentUser:a,inputValue:n});return}Xe(n,a.id,t),r("")},p=()=>{if(!o||!s){console.error("Missing recipient data for transaction");return}s(o)},w=g=>{g.key==="Enter"&&y()};return e.jsxs("div",{className:"chatBottomBar",children:[e.jsx("input",{type:"text",className:"messageInput",placeholder:"Type your message",value:n,onChange:d,onKeyDown:w}),e.jsx("button",{className:"transactionButton",onClick:p,disabled:!t||!a||!o,title:"Send crypto",children:e.jsx(Ne,{size:20})}),e.jsx("button",{className:"sendMessageButton",onClick:y,disabled:!t||!a,title:"Send message",children:e.jsx(G,{size:20})})]})};function re({children:t,selectedChatId:s,onSendTransaction:o,recipientUser:n}){return e.jsxs("div",{className:"chatWindow",children:[e.jsx("div",{className:"chatContent",children:t}),e.jsx(Ze,{selectedChatId:s,onSendTransaction:o,recipientUser:n||void 0})]})}const es=({text:t,timeStamp:s,from:o,own:n})=>e.jsx("div",{className:"messageBox",children:e.jsxs("div",{className:`message ${n?"own":""}`,children:[e.jsx("p",{className:"message-text",children:t}),e.jsx("p",{className:"message-timestamp",children:new Date(s).toLocaleString()})]})}),ss=({transaction:t,own:s,timeStamp:o})=>{const r=(g=>{switch(g){case 1:return{name:"Ethereum",symbol:"ETH",color:"#627EEA"};case 137:return{name:"Polygon",symbol:"MATIC",color:"#8247E5"};case 42161:return{name:"Arbitrum",symbol:"ETH",color:"#28A0F0"};case 10:return{name:"Optimism",symbol:"ETH",color:"#FF0420"};case 8453:return{name:"Base",symbol:"ETH",color:"#0052FF"};default:return{name:"Unknown",symbol:"ETH",color:"#666"}}})(t.chainId),d=(()=>{switch(t.status){case"pending":return{icon:e.jsx(ee,{size:16}),text:"Pending",className:"pending"};case"confirmed":return{icon:e.jsx(Se,{size:16}),text:"Confirmed",className:"confirmed"};case"failed":return{icon:e.jsx(Ce,{size:16}),text:"Failed",className:"failed"};default:return{icon:e.jsx(ee,{size:16}),text:"Unknown",className:"unknown"}}})(),y=g=>{const h=parseFloat(g);return h<1e-4?h.toExponential(2):h<1?h.toFixed(6):h<1e3?h.toFixed(4):h.toFixed(2)},w=(()=>{const h={1:"https://etherscan.io/tx/",137:"https://polygonscan.com/tx/",42161:"https://arbiscan.io/tx/",10:"https://optimistic.etherscan.io/tx/",8453:"https://basescan.org/tx/"}[t.chainId];return h?`${h}${t.hash}`:null})();return e.jsx("div",{className:"messageBox",children:e.jsxs("div",{className:`message transaction-message ${s?"own":""}`,children:[e.jsxs("div",{className:"transaction-header",children:[e.jsx("div",{className:"transaction-icon",children:e.jsx(G,{size:20})}),e.jsx("div",{className:"transaction-title",children:e.jsx("span",{children:s?`Sent to ${t.recipientName}`:`Received from ${t.senderName}`})}),e.jsxs("div",{className:`transaction-status ${d.className}`,children:[d.icon,e.jsx("span",{children:d.text})]})]}),e.jsxs("div",{className:"transaction-amount",children:[e.jsxs("span",{className:"amount",children:[s?"-":"+",y(t.amount)]}),e.jsx("span",{className:"currency",children:r.symbol})]}),e.jsx("div",{className:"transaction-network",children:e.jsx("div",{className:"network-badge",style:{backgroundColor:r.color},children:r.name})}),e.jsxs("div",{className:"transaction-details",children:[e.jsxs("div",{className:"detail-row",children:[e.jsx("span",{className:"label",children:"Hash:"}),e.jsxs("span",{className:"value hash",children:[t.hash.slice(0,8),"...",t.hash.slice(-6)]})]}),w&&e.jsx("div",{className:"transaction-explorer",children:e.jsx("a",{href:w,target:"_blank",rel:"noopener noreferrer",className:"explorer-link",children:"View on Explorer →"})})]}),e.jsx("div",{className:"message-timestamp",children:new Date(o).toLocaleString()})]})})};function ce({selectedChatId:t,users:s,getWalletById:o,onSendTransaction:n,recipientUser:r}){const[a,d]=i.useState([]),{address:y}=P(),{currentUser:p}=z(),w=i.useRef(null),g=()=>{var h;(h=w.current)==null||h.scrollIntoView({behavior:"smooth"})};return i.useEffect(()=>{g()},[a]),i.useEffect(()=>{if(!t)return;const h=B(M,"privateChats",t,"msg"),C=A(h,q("ts","asc")),m=W(C,j=>{const b=[];j.forEach(l=>{const c=l.data();c.txt&&c.ts&&c.from?b.push(c):console.log("Missing fields in document:",l.id)}),console.log("Real-time Messages Update:",b),d(b)},j=>{console.error("Error fetching messages:",j)});return()=>m()},[t]),e.jsxs("div",{className:"chatContent",children:[a.map((h,C)=>{const m=p!=null&&p.id?h.from===p.id:!1;return h.type==="transaction"&&h.transactionData?e.jsx(ss,{transaction:h.transactionData,own:m,timeStamp:h.ts.toMillis()},C):e.jsx(es,{text:h.txt,timeStamp:h.ts.toMillis(),from:h.from,own:m},C)}),e.jsx("div",{ref:w})," "]})}const $=({chatName:t,onBack:s,showBackButton:o,showProfilePic:n=!1})=>{const{address:r}=P();return e.jsxs("div",{className:"chat-header",children:[e.jsxs("div",{className:"chat-header-left",children:[o&&e.jsx("button",{className:"back-button",onClick:s,title:"Go back",children:e.jsx(ke,{size:24})}),e.jsx("div",{className:"chat-header-info",children:e.jsx("h2",{className:"chat-header-title",children:t})})]}),e.jsx("div",{className:"chat-header-right",children:(n||!o)&&r&&e.jsx("div",{className:"header-profile-pic",children:e.jsx(H,{eth:r})})})]})},ie=({onClose:t,onChatCreated:s})=>{const[o,n]=i.useState([]),[r,a]=i.useState(!0),[d,y]=i.useState(null),[p,w]=i.useState(null),{currentUser:g}=z();i.useEffect(()=>{(async()=>{try{a(!0);const j=B(M,"users"),l=(await U(j)).docs.map(f=>({id:f.id,name:f.data().name,wallet:f.data().wallet,chats:f.data().chats||[]})),c=g?l.filter(f=>f.id!==g.id):l;n(c)}catch(j){console.error("Error fetching users:",j),w("Failed to load users. Please try again.")}finally{a(!1)}})()},[g]);const h=async m=>{if(!g)return null;try{const j=B(M,"privateChats"),b=A(j),l=await U(b);for(const c of l.docs){const u=c.data().pid||[];if(u.includes(g.id)&&u.includes(m))return c.id}return null}catch(j){return console.error("Error checking existing chat:",j),null}},C=async m=>{if(!g){w("You must be logged in to create a chat");return}y(m.id),w(null);try{const j=await h(m.id);if(j){console.log("Chat already exists:",j),s&&s(j),t();return}const b=B(M,"privateChats"),l=await J(b,{pid:[g.id,m.id],createdAt:new Date,lastActivity:new Date});console.log("Created new chat with ID:",l.id);const c=Y(M,"users",g.id),f=Y(M,"users",m.id);await Promise.all([se(c,{chats:te(l.id)}),se(f,{chats:te(l.id)})]),console.log("Updated users' chat lists"),s&&s(l.id),t()}catch(j){console.error("Error creating chat:",j),w("Failed to create chat. Please try again.")}finally{y(null)}};return e.jsx("div",{className:"modalOverlay",children:e.jsxs("div",{className:"modalContent",children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"20px"},children:[e.jsx("h2",{children:"Start New Chat"}),e.jsx("button",{className:"closeButton",onClick:t,style:{background:"transparent",border:"none",color:"#fff",cursor:"pointer",padding:"5px"},children:e.jsx(_,{size:20})})]}),p&&e.jsx("div",{style:{color:"#ff4444",marginBottom:"15px",padding:"10px",background:"rgba(255, 68, 68, 0.1)",borderRadius:"8px"},children:p}),r?e.jsx("div",{style:{textAlign:"center",padding:"20px"},children:e.jsx("p",{children:"Loading users..."})}):o.length===0?e.jsx("div",{style:{textAlign:"center",padding:"20px"},children:e.jsx("p",{children:"No other users found."})}):e.jsxs("div",{style:{maxHeight:"60vh",overflowY:"auto",scrollbarWidth:"thin",scrollbarColor:"rgba(255, 255, 255, 0.2) transparent",paddingRight:"8px"},className:"modal-scroll-area",children:[e.jsx("p",{style:{marginBottom:"15px",color:"#ccc"},children:"Select a user to start chatting:"}),e.jsx("div",{style:{display:"flex",flexDirection:"column",gap:"10px"},children:o.map(m=>e.jsxs("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between",padding:"12px",background:"rgba(255, 255, 255, 0.05)",borderRadius:"8px",border:"1px solid rgba(255, 255, 255, 0.1)"},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"12px"},children:[e.jsx(H,{eth:m.wallet}),e.jsxs("div",{children:[e.jsx("h4",{style:{margin:0,fontSize:"16px"},children:m.name}),e.jsxs("p",{style:{margin:0,fontSize:"12px",color:"#ccc",fontFamily:"monospace"},children:[m.wallet.slice(0,6),"...",m.wallet.slice(-4)]})]})]}),e.jsx("button",{onClick:()=>C(m),disabled:d===m.id,style:{background:d===m.id?"#666":"#50b458",border:"none",borderRadius:"50%",width:"40px",height:"40px",display:"flex",alignItems:"center",justifyContent:"center",cursor:d===m.id?"not-allowed":"pointer",color:"#fff",transition:"all 0.2s ease"},onMouseEnter:j=>{d!==m.id&&(j.target.style.background="#5bc464",j.target.style.transform="scale(1.05)")},onMouseLeave:j=>{d!==m.id&&(j.target.style.background="#50b458",j.target.style.transform="scale(1)")},children:d===m.id?e.jsx("div",{style:{width:"16px",height:"16px",border:"2px solid #fff",borderTop:"2px solid transparent",borderRadius:"50%",animation:"spin 1s linear infinite"}}):e.jsx(Ee,{size:18})})]},m.id))})]}),e.jsx("style",{children:`
          @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
          }
          
          .modal-scroll-area::-webkit-scrollbar {
            width: 6px;
          }
          
          .modal-scroll-area::-webkit-scrollbar-track {
            background: transparent;
          }
          
          .modal-scroll-area::-webkit-scrollbar-thumb {
            background-color: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
          }
        `})]})})},le=({onClose:t,recipientUser:s,onTransactionSent:o})=>{const{address:n}=P(),{currentUser:r}=z(),a=ze(),[d,y]=i.useState(""),[p,w]=i.useState((s==null?void 0:s.wallet)||""),[g,h]=i.useState(""),[C,m]=i.useState("form"),[j,b]=i.useState(null),{data:l,isLoading:c}=Le({address:n,chainId:a}),{sendTransaction:f,data:u,error:I,isPending:D}=We(),{isLoading:k,isSuccess:T,isError:S}=qe({hash:u});i.useEffect(()=>{D&&(m("confirming"),b(null))},[D]),i.useEffect(()=>{u&&!k&&!T&&m("pending")},[u,k,T]),i.useEffect(()=>{if(T&&u){m("success");const N={hash:u,to:p,amount:d,chainId:a,timestamp:new Date,from:n,recipientName:(s==null?void 0:s.name)||"Unknown",senderName:(r==null?void 0:r.name)||"You",status:"confirmed"};o&&o(N),setTimeout(()=>{t()},3e3)}},[T,u,p,d,a,n,s,r,o,t]),i.useEffect(()=>{(I||S)&&(m("error"),b((I==null?void 0:I.message)||"Transaction failed"))},[I,S]);const x=N=>{switch(N){case 1:return"Ethereum";case 137:return"Polygon";case 42161:return"Arbitrum";case 10:return"Optimism";case 8453:return"Base";default:return"Unknown Network"}},v=()=>{try{const N=parseFloat(d);return N>0&&N<=parseFloat((l==null?void 0:l.formatted)||"0")}catch{return!1}},E=()=>Te(p),R=()=>v()&&E()&&!D,F=async()=>{if(R())try{b(null),f({to:p,value:Me(d)})}catch(N){console.error("Transaction error:",N),b("Failed to send transaction"),m("error")}},pe=["0.001","0.01","0.1"],je=N=>{y(N)},we=()=>{switch(C){case"form":return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"transaction-form",children:[s&&e.jsxs("div",{className:"recipient-info",children:[e.jsx(H,{eth:s.wallet}),e.jsxs("div",{className:"recipient-details",children:[e.jsx("h4",{children:s.name}),e.jsxs("p",{className:"recipient-address",children:[s.wallet.slice(0,6),"...",s.wallet.slice(-4)]})]})]}),e.jsxs("div",{className:"form-group",children:[e.jsxs("label",{children:["Amount (",(l==null?void 0:l.symbol)||"ETH",")"]}),e.jsxs("div",{className:"amount-input-group",children:[e.jsx("input",{type:"number",value:d,onChange:N=>y(N.target.value),placeholder:"0.0",step:"0.0001",min:"0",max:(l==null?void 0:l.formatted)||"0"}),e.jsx("div",{className:"quick-amounts",children:pe.map(N=>e.jsx("button",{type:"button",className:"quick-amount-btn",onClick:()=>je(N),children:N},N))})]}),e.jsx("div",{className:"balance-info",children:c?e.jsx("span",{children:"Loading balance..."}):e.jsxs("span",{children:["Balance: ",l?`${parseFloat(l.formatted).toFixed(4)} ${l.symbol}`:"0"]})})]}),!s&&e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Recipient Address"}),e.jsx("input",{type:"text",value:p,onChange:N=>w(N.target.value),placeholder:"0x...",className:!E()&&p?"error":""}),p&&!E()&&e.jsx("span",{className:"error-text",children:"Invalid address"})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Message (optional)"}),e.jsx("textarea",{value:g,onChange:N=>h(N.target.value),placeholder:"What's this for?",maxLength:200,rows:3})]}),e.jsx("div",{className:"network-info",children:e.jsxs("span",{children:["Sending on ",x(a)]})})]}),e.jsxs("div",{className:"modal-footer",children:[e.jsx("button",{className:"cancel-btn",onClick:t,children:"Cancel"}),e.jsxs("button",{className:"send-btn",onClick:F,disabled:!R(),children:[e.jsx(G,{size:18}),"Send ",d||"0"," ",(l==null?void 0:l.symbol)||"ETH"]})]})]});case"confirming":return e.jsxs("div",{className:"transaction-status",children:[e.jsx("div",{className:"status-icon confirming",children:e.jsx("div",{className:"spinner"})}),e.jsx("h3",{children:"Confirm in Wallet"}),e.jsx("p",{children:"Please confirm the transaction in your wallet to continue."})]});case"pending":return e.jsxs("div",{className:"transaction-status",children:[e.jsx("div",{className:"status-icon pending",children:e.jsx("div",{className:"spinner"})}),e.jsx("h3",{children:"Transaction Pending"}),e.jsx("p",{children:"Your transaction is being processed on the blockchain."}),u&&e.jsxs("div",{className:"transaction-hash",children:[e.jsx("p",{children:"Transaction Hash:"}),e.jsxs("code",{children:[u.slice(0,10),"...",u.slice(-8)]})]})]});case"success":return e.jsxs("div",{className:"transaction-status",children:[e.jsx("div",{className:"status-icon success",children:"✓"}),e.jsx("h3",{children:"Transaction Sent!"}),e.jsxs("p",{children:["Successfully sent ",d," ",(l==null?void 0:l.symbol)||"ETH"," to ",(s==null?void 0:s.name)||"recipient"]}),u&&e.jsxs("div",{className:"transaction-hash",children:[e.jsx("p",{children:"Transaction Hash:"}),e.jsxs("code",{children:[u.slice(0,10),"...",u.slice(-8)]})]}),e.jsx("p",{className:"auto-close",children:"This window will close automatically..."})]});case"error":return e.jsxs("div",{className:"transaction-status",children:[e.jsx("div",{className:"status-icon error",children:"✕"}),e.jsx("h3",{children:"Transaction Failed"}),e.jsx("p",{className:"error-message",children:j}),e.jsxs("div",{className:"modal-footer",children:[e.jsx("button",{className:"cancel-btn",onClick:t,children:"Close"}),e.jsx("button",{className:"retry-btn",onClick:()=>m("form"),children:"Try Again"})]})]});default:return null}};return e.jsx("div",{className:"modalOverlay",children:e.jsxs("div",{className:"modalContent transaction-modal",children:[e.jsxs("div",{className:"modal-header",children:[e.jsx("h2",{children:"Send Crypto"}),C==="form"&&e.jsx("button",{className:"closeButton",onClick:t,children:e.jsx(_,{size:20})})]}),we()]})})},ge=()=>{const[t,s]=i.useState({width:typeof window<"u"?window.innerWidth:0,height:typeof window<"u"?window.innerHeight:0});i.useEffect(()=>{const a=()=>{s({width:window.innerWidth,height:window.innerHeight})};return window.addEventListener("resize",a),()=>window.removeEventListener("resize",a)},[]);const o=t.width<=768,n=t.width>768&&t.width<=1024,r=t.width>1024;return{isMobile:o,isTablet:n,isDesktop:r,windowSize:t}};function ts(){const{address:t}=P(),[s,o]=i.useState(null),[n,r]=i.useState([]),{setCurrentUser:a}=z(),[d,y]=i.useState(!1),[p,w]=i.useState(!1),[g,h]=i.useState(null),[C,m]=i.useState(null),{isMobile:j}=ge(),[b,l]=i.useState("list");i.useEffect(()=>{(async()=>{const v=B(M,"users"),R=(await U(v)).docs.map(F=>({id:F.id,name:F.data().name,wallet:F.data().wallet}));r(R),console.log("Fetched users:",R)})()},[]),i.useEffect(()=>{(async()=>{if(!s){m(null);return}try{const v=await Ie(Y(M,"privateChats",s));if(v.exists()){const E=v.data();m(E),console.log("Fetched chat data:",E)}else console.error("Chat document not found:",s),m(null)}catch(v){console.error("Error fetching chat data:",v),m(null)}})()},[s]),i.useEffect(()=>{if(n.length>0&&t){const x=n.find(v=>v.wallet===t);console.log("Current User:",x),a(x)}},[n,t,a]);const c=x=>{o(x),j&&l("chat")},f=()=>{j&&(l("list"),o(null))},u=x=>{console.log("New chat created with ID:",x),o(x),j&&l("chat")},I=x=>{const v=n.find(E=>E.id===x);return v?v.wallet:""},D=()=>{const x=k();return x?x.name:"Chat"},k=()=>{if(console.log("Getting recipient user..."),console.log("Selected chat ID:",s),console.log("Current chat data:",C),console.log("Current address:",t),console.log("Available users:",n),!s||!C||!t||n.length===0)return console.log("Missing required data for recipient detection"),null;const x=n.find(R=>R.wallet===t);if(!x)return console.log("Current user not found in users list"),null;console.log("Current user found:",x);const v=C.pid.find(R=>R!==x.id);if(!v)return console.log("Other participant ID not found in chat data"),null;console.log("Other participant ID:",v);const E=n.find(R=>R.id===v);return console.log("Recipient user found:",E),E||null},T=x=>{if(console.log("Handle send transaction called with:",x),!x||!x.wallet||!x.name){console.error("Invalid recipient user:",x);return}h(v=>(console.log("Setting recipient from",v,"to",x),x)),w(v=>(console.log("Setting modal visibility from",v,"to true"),!0))},S=x=>{console.log("Transaction sent:",x),w(!1),h(null)};return i.useEffect(()=>{const x=k();console.log("Recipient user updated:",x)},[s,C,n,t]),j?e.jsxs("div",{className:"chat mobile-chat",children:[b==="list"?e.jsxs("div",{className:"mobile-chat-list",children:[e.jsx($,{chatName:"Chats",onBack:f,showBackButton:!1,showProfilePic:!0}),e.jsx("div",{className:"mobile-chat-selector",children:e.jsx(oe,{setSelectedChatId:c,users:n,getWalletById:I,selectedChatId:s})}),e.jsx("button",{className:"createChatButton mobile-create-chat",onClick:()=>y(!0),title:"Start new chat",children:e.jsx(ne,{size:28})})]}):e.jsxs("div",{className:"mobile-chat-window",children:[e.jsx($,{chatName:D(),onBack:f,showBackButton:!0}),s&&e.jsx(re,{selectedChatId:s,onSendTransaction:T,recipientUser:k(),children:e.jsx(ce,{selectedChatId:s,users:n,getWalletById:I,onSendTransaction:T,recipientUser:k()})})]}),d&&e.jsx(ie,{onClose:()=>y(!1),onChatCreated:u}),p&&g&&e.jsx(le,{onClose:()=>{w(!1),h(null)},recipientUser:g,onTransactionSent:S})]}):e.jsxs("div",{className:"chat desktop-chat",children:[e.jsx(oe,{setSelectedChatId:c,users:n,getWalletById:I,selectedChatId:s}),e.jsx("div",{className:"desktop-chat-area",children:s?e.jsxs(e.Fragment,{children:[e.jsx($,{chatName:D(),onBack:f,showBackButton:!1}),e.jsx(re,{selectedChatId:s,onSendTransaction:T,recipientUser:k(),children:e.jsx(ce,{selectedChatId:s,users:n,getWalletById:I,onSendTransaction:T,recipientUser:k()})})]}):e.jsxs("div",{className:"desktop-chat-placeholder",children:[e.jsx("h2",{children:"Select a chat to start messaging"}),e.jsx("p",{children:"Choose a conversation from the sidebar or create a new one"})]})}),e.jsx("button",{className:"createChatButton desktop-create-chat",onClick:()=>y(!0),title:"Start new chat",children:e.jsx(ne,{size:24})}),d&&e.jsx(ie,{onClose:()=>y(!1),onChatCreated:u}),p&&g&&e.jsx(le,{onClose:()=>{w(!1),h(null)},recipientUser:g,onTransactionSent:S})]})}function ns(){const{address:t}=P(),[s,o]=i.useState(null),n=X(),r=async a=>{const d=B(M,"users"),y=A(d,L("wallet","==",a));try{const w=!(await U(y)).empty;console.log("User found:",w),o(w),n(w?"/chat":"/signup")}catch(p){console.error("Error checking user:",p),o(!1),n("/signup")}};return e.jsxs("div",{children:[e.jsxs("button",{className:"proceedButton",onClick:()=>{t?r(t):console.error("Address is undefined")},children:[e.jsx(De,{size:28}),e.jsx("span",{children:"Proceed"})]}),s!==null&&e.jsx("p",{children:s?"User exists":"User does not exist"})]})}function as(){const{address:t,isConnected:s}=P(),{disconnect:o}=he(),n=async()=>{localStorage.removeItem("walletconnect"),localStorage.removeItem("walletConnected"),localStorage.removeItem("connectorId"),o()};return e.jsx("div",{className:"wallet-button",children:s&&t?e.jsxs("div",{className:"walletBubble",children:[e.jsxs("div",{className:"address",children:[t.slice(0,6),"...",t.slice(-4)]}),e.jsx("button",{onClick:n,children:e.jsx(_,{size:25})})]}):e.jsx("w3m-connect-button",{})})}function os(){const{address:t,isConnected:s,connector:o}=P(),{connect:n,connectors:r}=He();he();const[a,d]=i.useState(s);X();const{isMobile:y}=ge();return i.useEffect(()=>{if(localStorage.getItem("walletConnected")==="true"&&!s){console.log("Attempting to reconnect wallet automatically...");const w=localStorage.getItem("connectorId");if(console.log("Last used connector:",w),w){const g=r.find(h=>h.id===w);g&&(console.log("Reconnecting with saved connector:",w),n({connector:g}))}else{const g=r.find(h=>h.id==="injected");g&&(console.log("No saved connector, trying injected..."),n({connector:g}))}}},[n,r,s]),i.useEffect(()=>{console.log("Connection state changed:",s?"connected":"disconnected"),console.log("Current connector:",o==null?void 0:o.id),d(s),s&&!a&&console.log("Wallet newly connected:",t),!s&&a&&console.log("Wallet disconnected")},[s,t,a,o]),i.useEffect(()=>{const p=()=>{a&&!s&&(console.log("Connection lost while page was inactive, updating UI"),d(!1))};return window.addEventListener("focus",p),()=>{window.removeEventListener("focus",p)}},[a,s]),e.jsxs("div",{className:`homepage ${y?"mobile-homepage":"desktop-homepage"}`,children:[e.jsxs("div",{className:"title",children:[e.jsx("h1",{children:"Chat 3.0 is here."}),e.jsx("h2",{children:"Your personal web3 companion."})]}),e.jsx("div",{children:e.jsxs("div",{className:"login",children:[e.jsx("h3",{children:a?`Connected ${o!=null&&o.id?`(${o.id})`:""}`:"Connect your wallet"}),e.jsx(as,{}),a&&e.jsx(ns,{})]})})]})}function rs(){const{address:t}=P(),s=X(),[o,n]=i.useState(""),[r,a]=i.useState(null),[d,y]=i.useState(!1),[p,w]=i.useState(!1),[g,h]=i.useState(!0);i.useEffect(()=>{(async()=>{if(t){h(!0);try{const l=B(M,"users"),c=A(l,L("wallet","==",t)),u=!(await U(c)).empty;w(u),u&&(console.log("User already exists, redirecting to chat"),s("/chat"))}catch(l){console.error("Error checking if user exists:",l)}finally{h(!1)}}})()},[t,s]);const C=async()=>{const b=B(M,"users"),l=A(b,q("name"),Q(10)),f=(await U(l)).docs.map(u=>({id:u.id,...u.data()}));a({users:f}),console.log("Fetched data:",f)};i.useEffect(()=>{C()},[]);const m=async()=>{if(!t||!o.trim()){console.error("Missing required data: address or name");return}if(p){console.log("User already exists, cannot register again");return}y(!0),console.log("Writing data:",t,o);try{const b=B(M,"users"),l=A(b,L("wallet","==",t));if(!(await U(l)).empty){console.log("User already exists, cannot register"),w(!0),y(!1),s("/chat");return}const f=W(A(b,L("wallet","==",t)),u=>{u.empty||(console.log("User successfully registered, redirecting to chat"),f(),s("/chat"))},u=>{console.error("Error in onSnapshot listener:",u),y(!1)});await J(b,{wallet:t,name:o.trim()}),console.log("Data written successfully"),setTimeout(()=>{f(),d&&(y(!1),console.log("Registration timeout, stopped listening"))},1e4)}catch(b){console.error("Error writing data:",b),y(!1)}},j=b=>{b.key==="Enter"&&!d&&!p&&o.trim()&&m()};return g?e.jsx("div",{className:"centered-signup",children:e.jsxs("div",{className:"welcomeText",children:[e.jsx("h1",{children:"Checking registration status..."}),e.jsx("h2",{children:"Please wait"})]})}):p?e.jsxs("div",{className:"centered-signup",children:[e.jsxs("div",{className:"welcomeText",children:[e.jsx("h1",{children:"Already Registered"}),e.jsx("h2",{children:"You're already signed up! Redirecting to chat..."})]}),e.jsxs("p",{children:["Wallet Address: ",t]})]}):e.jsxs("div",{className:"centered-signup",children:[e.jsxs("div",{className:"welcomeText",children:[e.jsx("h1",{children:"Welcome to Chat 3.0"}),e.jsx("h2",{children:"One last step to start chatting"})]}),e.jsxs("p",{children:["Wallet Address: ",t]}),e.jsxs("div",{className:"signupBox",children:[e.jsx("input",{type:"text",placeholder:"Enter name",value:o,onChange:b=>n(b.target.value),onKeyPress:j,disabled:d,maxLength:50}),e.jsx("button",{onClick:m,disabled:d||!o.trim(),children:d?"Registering...":"Register"})]}),d&&e.jsx("p",{style:{color:"#50b458",marginTop:"10px"},children:"Creating your account, please wait..."})]})}const cs=new Re,K="02ee764d5cc25cff6387d6d3f7943fd6",V={name:"TokenChat",description:"Web3 Chat Application",url:"https://c4ctus96.github.io/tokenchat",icons:["https://avatars.githubusercontent.com/u/37784886"]},is=[Z,ue],xe=Oe({chains:is,transports:{[Z.id]:ae("https://eth-mainnet.g.alchemy.com/v2/demo"),[ue.id]:ae("https://arb-mainnet.g.alchemy.com/v2/demo")},connectors:[$e({projectId:K,metadata:V,showQrModal:!1}),Ve({shimDisconnect:!0}),Qe({appName:V.name,appLogoUrl:V.icons[0]}),Ye({options:{projectId:K},socials:["google","x","github","discord","apple"],showWallets:!0,email:!0,walletFeatures:!1})]});Ke({wagmiConfig:xe,projectId:K,defaultChain:Z,themeMode:"dark",enableAnalytics:!0,enableOnramp:!1,themeVariables:{"--w3m-accent":"#50b458","--w3m-color-mix":"#210059","--w3m-color-mix-strength":30}});function ls({children:t}){const{isConnected:s}=P();return s?e.jsx(e.Fragment,{children:t}):e.jsx(Ue,{to:"/"})}function ds(){const{isConnected:t}=P();return i.useEffect(()=>{console.log("App initialized, connection status:",t),typeof window.ethereum>"u"&&console.log("MetaMask not detected, but WalletConnect can still be used")},[t]),null}function us(){return e.jsx(Ge,{config:xe,children:e.jsx(Be,{client:cs,children:e.jsx(_e,{children:e.jsxs(Pe,{basename:"/tokenchat",children:[e.jsx(ds,{}),e.jsxs(Ae,{children:[e.jsx(O,{path:"/",element:e.jsx(os,{})}),e.jsx(O,{path:"/chat",element:e.jsx(ls,{children:e.jsx(ts,{})})}),e.jsx(O,{path:"/signup",element:e.jsx(rs,{})})]})]})})})})}const hs=document.getElementById("root"),ms=Fe(hs);ms.render(e.jsx(de.StrictMode,{children:e.jsx(us,{})}));
//# sourceMappingURL=index-BGEbt2G4.js.map
