import{aL as mt,aM as ht,aN as gt,aO as e,aG as r,aP as H,aQ as me,aR as Q,aS as Se,aT as Ge,aU as ke,aV as ft,aW as Ne,aX as Ee,aY as Ue,aZ as pt,a_ as xt,a$ as wt,b0 as Te,b1 as bt,b2 as te,b3 as je,b4 as Me,b5 as De,b6 as ie,b7 as Be,b8 as yt,b9 as Pe,ba as Ct,bb as Ie,bc as jt,bd as ue,be as vt,bf as Ke,bg as se,bh as Ye,bi as _e,bj as Qe,bk as Xe,aE as Ae,bl as St,bm as kt,bn as Nt,bo as de,bp as Je,bq as Et}from"./react-CC1pSpuU.js";import{u as W,a as Tt,b as It,c as At,d as Ft,e as Rt,f as Ut,g as Mt,h as Fe,i as Dt,j as Bt,w as Pt,k as Lt,l as $t,m as Ht,n as Wt,W as zt}from"./web3-Cm8GGWMw.js";import"./walletconnect-BeEkp7-7.js";(function(){const n=document.createElement("link").relList;if(n&&n.supports&&n.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))s(a);new MutationObserver(a=>{for(const o of a)if(o.type==="childList")for(const l of o.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&s(l)}).observe(document,{childList:!0,subtree:!0});function i(a){const o={};return a.integrity&&(o.integrity=a.integrity),a.referrerPolicy&&(o.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?o.credentials="include":a.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function s(a){if(a.ep)return;a.ep=!0;const o=i(a);fetch(a.href,o)}})();const Ot={apiKey:"AIzaSyBRDBbrJbmLwb3YTI_YBmMdTjLEd8KjS2E",authDomain:"tokenchat-b8673.firebaseapp.com",projectId:"tokenchat-b8673",storageBucket:"tokenchat-b8673.appspot.com",messagingSenderId:"593980787293",appId:"1:593980787293:web:7c58ff7656a3fa31b19bb4",measurementId:"G-RB9WJLVQC0"},Ze=mt(Ot);ht(Ze);const D=gt(Ze),ge=({eth:t})=>e.jsx("div",{children:e.jsx("img",{src:`https://effigy.im/a/${t}.svg`,alt:"Profile picture",className:"profilePic"})});function Le({setSelectedChatId:t,users:n,getWalletById:i,selectedChatId:s}){const{address:a}=W(),[o,l]=r.useState([]),[c,f]=r.useState(null),h=r.useRef(null),g=r.useRef(new Map),d=r.useRef(!0),m=r.useRef(null),u=r.useRef(0),p=r.useCallback(()=>{console.log("Cleaning up ChatSelector listeners"),h.current&&(h.current(),h.current=null),g.current.forEach((C,y)=>{try{C()}catch(R){console.warn(`Error unsubscribing from chat ${y}:`,R)}}),g.current.clear(),m.current&&(clearTimeout(m.current),m.current=null)},[]),b=r.useCallback(async()=>{if(!a){console.log("No address available, skipping chat listener setup");return}try{console.log("Setting up chat listeners for address:",a),p();const C=H(D,"privateChats"),y=me(C,async R=>{try{console.log("Chat snapshot received, processing..."),u.current=Date.now();const v=[];g.current.forEach(w=>{try{w()}catch(A){console.warn("Error cleaning up message listener:",A)}}),g.current.clear();for(const w of R.docs){const A=w.data(),B={id:w.id,pid:A.pid||[]};try{const P=H(D,"privateChats",w.id,"msg"),oe=Q(P,Se("ts","desc"),Ge(1)),K=me(oe,z=>{try{if(z.empty)l(U=>U.map(T=>T.id===w.id?{...T,lastMessage:"No messages yet",lastMessageTime:new Date(0)}:T).sort((T,Y)=>{var X,_;const O=((X=T.lastMessageTime)==null?void 0:X.getTime())||0;return(((_=Y.lastMessageTime)==null?void 0:_.getTime())||0)-O}));else{const U=z.docs[0].data();l(T=>T.map(O=>{var q;return O.id===w.id?{...O,lastMessage:U.txt||"",lastMessageTime:((q=U.ts)==null?void 0:q.toDate())||new Date}:O}).sort((O,q)=>{var J,Z;const X=((J=O.lastMessageTime)==null?void 0:J.getTime())||0;return(((Z=q.lastMessageTime)==null?void 0:Z.getTime())||0)-X}));const re=n.find(T=>T.wallet===a);if(re&&U.from!==re.id&&w.id!==s&&d.current===!1){const T=k(U.from);N(T,U.txt)}}}catch(U){console.error(`Error processing message snapshot for chat ${w.id}:`,U)}},z=>{console.error(`Error in message listener for chat ${w.id}:`,z)});g.current.set(w.id,K)}catch(P){console.error(`Error setting up message listener for chat ${w.id}:`,P),B.lastMessage="Failed to load",B.lastMessageTime=new Date(0)}v.push(B)}v.sort((w,A)=>w.id.localeCompare(A.id)),console.log("Real-time chatrooms update:",v),l(v),f(null)}catch(v){f("Failed to fetch chat data. Please check your internet connection."),console.error("Snapshot processing error:",v)}},R=>{f("Failed to fetch data. Please check your internet connection."),console.error("Chat listener error:",R),d.current&&(console.log("Attempting to reconnect chat listeners in 5 seconds..."),m.current=window.setTimeout(()=>{b()},5e3))});h.current=y}catch(C){console.error("Error setting up chat listeners:",C),f("Failed to initialize chat data.")}},[a,n,s]);r.useEffect(()=>(a?b():(p(),l([])),p),[a,b]),r.useEffect(()=>{const C=()=>{const y=document.visibilityState==="visible";d.current=y,console.log(`Page visibility changed: ${y?"visible":"hidden"}`),y&&a&&Date.now()-u.current>3e4&&(console.log("Page became visible and listeners may be stale, reconnecting..."),setTimeout(()=>{b()},1e3))};return document.addEventListener("visibilitychange",C),()=>{document.removeEventListener("visibilitychange",C)}},[a,b]),r.useEffect(()=>{(async()=>{if("Notification"in window&&Notification.permission==="default")try{const y=await Notification.requestPermission();console.log("Notification permission:",y)}catch(y){console.warn("Error requesting notification permission:",y)}})()},[]);const N=r.useCallback((C,y)=>{if("Notification"in window&&Notification.permission==="granted")try{const R=y.length>50?y.substring(0,50)+"...":y,v=new Notification(`New message from ${C}`,{body:R,icon:"/favicon.ico",badge:"/favicon.ico",tag:"new-message",requireInteraction:!1});setTimeout(()=>{v.close()},5e3)}catch(R){console.warn("Error showing notification:",R)}},[]),j=n.find(C=>C.wallet===a),x=j?o.filter(C=>C.pid.includes(j.id)):[],k=r.useCallback(C=>{const y=n.find(R=>R.id===C);return y?y.name:C},[n]),I=r.useCallback(C=>j&&C.find(y=>y!==j.id)||"",[j]),E=r.useCallback(C=>{const y=I(C);return k(y)},[I,k]),F=r.useCallback((C,y=40)=>C.length<=y?C:C.substring(0,y)+"...",[]),M=r.useCallback(C=>{t(C)},[t]);return e.jsxs("div",{className:"chatSelector",children:[c&&e.jsx("p",{className:"error",children:c}),x.length>0?x.map(C=>e.jsxs("div",{className:"contactBox",onClick:()=>M(C.id),style:{backgroundColor:C.id===s?"#003344":"#002233",cursor:"pointer"},children:[e.jsx(ge,{eth:i(I(C.pid))}),e.jsxs("div",{className:"contactTextBox",children:[e.jsx("h3",{style:{fontSize:"16px",fontWeight:"bold"},children:E(C.pid)}),e.jsx("p",{style:{margin:0,fontSize:"14px",color:"#ccc",opacity:.8,lineHeight:"1.2"},children:F(C.lastMessage||"No messages yet")})]})]},C.id)):e.jsxs("div",{style:{padding:"20px",textAlign:"center",color:"#ccc"},children:[e.jsx("p",{children:"No chats yet"}),e.jsx("p",{style:{fontSize:"14px",marginTop:"10px"},children:"Click the + button to start a new conversation"})]})]})}const et=r.createContext(void 0),Vt=({children:t})=>{const[n,i]=r.useState(void 0);return e.jsx(et.Provider,{value:{currentUser:n,setCurrentUser:i},children:t})},ae=()=>{const t=r.useContext(et);if(!t)throw new Error("useUser must be used within a UserProvider");return t},tt=async(t,n,i,s="text",a)=>{try{const o=H(D,"privateChats",i,"msg"),l={txt:t,from:n,ts:new Date,type:s};s==="transaction"&&a&&(l.transactionData=a),await Ee(o,l),console.log("Message sent successfully")}catch(o){throw console.error("Error sending message:",o),o}},qt=({selectedChatId:t,onSendTransaction:n,recipientUser:i})=>{const[s,a]=ke.useState(""),{currentUser:o}=ae(),l=g=>{a(g.target.value)},c=async()=>{if(!t||!o||!s.trim()){console.error("Missing required data:",{selectedChatId:t,currentUser:o,inputValue:s});return}try{await tt(s.trim(),o.id,t),a("")}catch(g){console.error("Failed to send message:",g)}},f=()=>{if(!i||!n){console.error("Missing recipient data for transaction");return}n(i)},h=g=>{g.key==="Enter"&&!g.shiftKey&&(g.preventDefault(),c())};return e.jsxs("div",{className:"chatBottomBar",children:[e.jsx("input",{type:"text",className:"messageInput",placeholder:"Type your message...",value:s,onChange:l,onKeyDown:h}),e.jsx("button",{className:"transactionButton",onClick:f,disabled:!t||!o||!i,title:"Send crypto",children:e.jsx(ft,{size:20})}),e.jsx("button",{className:"sendMessageButton",onClick:c,disabled:!t||!o||!s.trim(),title:"Send message",children:e.jsx(Ne,{size:20})})]})},Gt=async(t,n,i)=>{try{let s=`Sent ${t.amount} ${Kt(t.chainId)} to ${t.recipientName}`;t.comment&&(s+=` - ${t.comment}`),await tt(s,i,n,"transaction",t),console.log("Transaction message sent to chat")}catch(s){throw console.error("Failed to send transaction message:",s),s}},Kt=t=>{switch(t){case 1:return"ETH";case 56:return"BNB";case 137:return"MATIC";case 42161:return"ETH";case 10:return"ETH";case 8453:return"ETH";case 43114:return"AVAX";case 250:return"FTM";default:return"ETH"}};function $e({children:t,selectedChatId:n,onSendTransaction:i,recipientUser:s}){return e.jsxs("div",{className:"chatWindow",children:[e.jsx("div",{className:"chatContent",children:t}),e.jsx(qt,{selectedChatId:n,onSendTransaction:i,recipientUser:s||void 0})]})}const Yt=({text:t,timeStamp:n,from:i,own:s})=>e.jsx("div",{className:"messageBox",children:e.jsxs("div",{className:`message ${s?"own":""}`,children:[e.jsx("p",{className:"message-text",children:t}),e.jsx("p",{className:"message-timestamp",children:new Date(n).toLocaleString()})]})}),we={1:{name:"Ethereum",symbol:"ETH",color:"#627EEA",explorerUrl:"https://etherscan.io",decimals:18},56:{name:"BNB Smart Chain",symbol:"BNB",color:"#F3BA2F",explorerUrl:"https://bscscan.com",decimals:18},137:{name:"Polygon",symbol:"MATIC",color:"#8247E5",explorerUrl:"https://polygonscan.com",decimals:18},42161:{name:"Arbitrum One",symbol:"ETH",color:"#28A0F0",explorerUrl:"https://arbiscan.io",decimals:18},10:{name:"Optimism",symbol:"ETH",color:"#FF0420",explorerUrl:"https://optimistic.etherscan.io",decimals:18},8453:{name:"Base",symbol:"ETH",color:"#0052FF",explorerUrl:"https://basescan.org",decimals:18},43114:{name:"Avalanche",symbol:"AVAX",color:"#E84142",explorerUrl:"https://snowscan.xyz",decimals:18},250:{name:"Fantom",symbol:"FTM",color:"#1969FF",explorerUrl:"https://ftmscan.com",decimals:18},25:{name:"Cronos",symbol:"CRO",color:"#002D74",explorerUrl:"https://cronoscan.com",decimals:18},100:{name:"Gnosis",symbol:"xDAI",color:"#04795B",explorerUrl:"https://gnosisscan.io",decimals:18},1284:{name:"Moonbeam",symbol:"GLMR",color:"#53CBC9",explorerUrl:"https://moonscan.io",decimals:18},1285:{name:"Moonriver",symbol:"MOVR",color:"#53CBC9",explorerUrl:"https://moonriver.moonscan.io",decimals:18},16666e5:{name:"Harmony",symbol:"ONE",color:"#00AEE9",explorerUrl:"https://explorer.harmony.one",decimals:18},42220:{name:"Celo",symbol:"CELO",color:"#35D07F",explorerUrl:"https://celoscan.io",decimals:18},1313161554:{name:"Aurora",symbol:"ETH",color:"#70D44B",explorerUrl:"https://aurorascan.dev",decimals:18},1088:{name:"Metis",symbol:"METIS",color:"#00DACC",explorerUrl:"https://andromeda-explorer.metis.io",decimals:18},288:{name:"Boba",symbol:"ETH",color:"#CBFF00",explorerUrl:"https://bobascan.com",decimals:18},2001:{name:"Milkomeda",symbol:"milkADA",color:"#4E6FF1",explorerUrl:"https://explorer-mainnet-cardano-evm.c1.milkomeda.com",decimals:18},321:{name:"KuCoin",symbol:"KCS",color:"#049C85",explorerUrl:"https://explorer.kcc.io",decimals:18},128:{name:"HECO",symbol:"HT",color:"#1253FC",explorerUrl:"https://hecoinfo.com",decimals:18},66:{name:"OKC",symbol:"OKT",color:"#000000",explorerUrl:"https://www.oklink.com/en/okc",decimals:18},106:{name:"Velas",symbol:"VLX",color:"#0088FF",explorerUrl:"https://evmexplorer.velas.com",decimals:18},122:{name:"Fuse",symbol:"FUSE",color:"#D2FF52",explorerUrl:"https://explorer.fuse.io",decimals:18},1313161555:{name:"Aurora Testnet",symbol:"ETH",color:"#70D44B",explorerUrl:"https://testnet.aurorascan.dev",decimals:18},3:{name:"Ethereum Ropsten",symbol:"ETH",color:"#627EEA",explorerUrl:"https://ropsten.etherscan.io",decimals:18},4:{name:"Ethereum Rinkeby",symbol:"ETH",color:"#627EEA",explorerUrl:"https://rinkeby.etherscan.io",decimals:18},5:{name:"Ethereum Goerli",symbol:"ETH",color:"#627EEA",explorerUrl:"https://goerli.etherscan.io",decimals:18},11155111:{name:"Ethereum Sepolia",symbol:"ETH",color:"#627EEA",explorerUrl:"https://sepolia.etherscan.io",decimals:18},97:{name:"BSC Testnet",symbol:"BNB",color:"#F3BA2F",explorerUrl:"https://testnet.bscscan.com",decimals:18},80001:{name:"Polygon Mumbai",symbol:"MATIC",color:"#8247E5",explorerUrl:"https://mumbai.polygonscan.com",decimals:18},421613:{name:"Arbitrum Goerli",symbol:"ETH",color:"#28A0F0",explorerUrl:"https://goerli.arbiscan.io",decimals:18},420:{name:"Optimism Goerli",symbol:"ETH",color:"#FF0420",explorerUrl:"https://goerli-optimism.etherscan.io",decimals:18},84531:{name:"Base Goerli",symbol:"ETH",color:"#0052FF",explorerUrl:"https://goerli.basescan.org",decimals:18},43113:{name:"Avalanche Fuji",symbol:"AVAX",color:"#E84142",explorerUrl:"https://testnet.snowscan.xyz",decimals:18},4002:{name:"Fantom Testnet",symbol:"FTM",color:"#1969FF",explorerUrl:"https://testnet.ftmscan.com",decimals:18}},He=new Map,We=new Map,_t=60*60*1e3,be=new Map,Qt=5*60*1e3;async function he(t){if(console.log(`Getting network info for chain ID: ${t}`),we[t])return console.log(`Found local network data for chain ${t}:`,we[t]),we[t];const n=He.get(t),i=We.get(t);if(n&&i&&Date.now()<i)return console.log(`Found cached network data for chain ${t}:`,n),n;const s=be.get(t);if(s&&Date.now()-s<Qt)return console.log(`Recently failed to fetch chain ${t}, using fallback`),ze(t);try{console.log(`Fetching network info from API for chain ${t}`);const a=await Xt(t);return He.set(t,a),We.set(t,Date.now()+_t),be.delete(t),console.log(`Successfully fetched and cached network info for chain ${t}:`,a),a}catch(a){return console.warn(`Failed to fetch network info for chain ${t}:`,a),be.set(t,Date.now()),ze(t)}}function ze(t){console.log(`Using fallback network info for chain ${t}`);const n={43114:{name:"Avalanche",symbol:"AVAX",color:"#E84142",explorerUrl:"https://snowscan.xyz",decimals:18},56:{name:"BNB Smart Chain",symbol:"BNB",color:"#F3BA2F",explorerUrl:"https://bscscan.com",decimals:18},137:{name:"Polygon",symbol:"MATIC",color:"#8247E5",explorerUrl:"https://polygonscan.com",decimals:18}};return n[t]?n[t]:{name:`Chain ${t}`,symbol:"ETH",color:"#666666",explorerUrl:null,decimals:18}}async function Xt(t){var s,a,o,l;const n=new AbortController,i=setTimeout(()=>n.abort(),1e4);try{const c=await fetch("https://chainid.network/chains.json",{signal:n.signal,headers:{Accept:"application/json","Cache-Control":"no-cache"}});if(clearTimeout(i),!c.ok)throw new Error(`HTTP error! status: ${c.status}`);const h=(await c.json()).find(d=>d.chainId===t);if(!h)throw new Error(`Chain ${t} not found in API response`);return{name:h.name||`Chain ${t}`,symbol:((s=h.nativeCurrency)==null?void 0:s.symbol)||"ETH",color:"#666666",explorerUrl:((o=(a=h.explorers)==null?void 0:a[0])==null?void 0:o.url)||null,decimals:((l=h.nativeCurrency)==null?void 0:l.decimals)||18}}catch(c){throw clearTimeout(i),c}}async function Jt(){const t=[1,56,137,42161,10,8453,43114,250];console.log("Preloading common networks:",t);const n=await Promise.allSettled(t.map(async a=>{try{const o=await he(a);return console.log(`Preloaded chain ${a}:`,o.name),o}catch(o){throw console.warn(`Failed to preload chain ${a}:`,o),o}})),i=n.filter(a=>a.status==="fulfilled").length,s=n.filter(a=>a.status==="rejected").length;console.log(`Preloading complete: ${i} successful, ${s} failed`)}typeof window<"u"&&setTimeout(()=>{Jt().catch(console.warn)},1e3);const Zt=({transaction:t,own:n,timeStamp:i})=>{const[s,a]=r.useState({name:"Loading...",symbol:"ETH",color:"#666666",explorerUrl:null,decimals:18}),[o,l]=r.useState(!0);r.useEffect(()=>{let m=!0;return(async()=>{console.log("TransactionMessage: Loading network info for chain",t.chainId),l(!0);try{const p=await he(t.chainId);m&&(console.log("TransactionMessage: Network info loaded:",p),a(p))}catch(p){if(console.error("TransactionMessage: Failed to load network info:",p),m){let b={name:`Chain ${t.chainId}`,symbol:"ETH",color:"#666666",explorerUrl:null,decimals:18};switch(t.chainId){case 1:b={name:"Ethereum",symbol:"ETH",color:"#627EEA",explorerUrl:"https://etherscan.io",decimals:18};break;case 56:b={name:"BNB Smart Chain",symbol:"BNB",color:"#F3BA2F",explorerUrl:"https://bscscan.com",decimals:18};break;case 137:b={name:"Polygon",symbol:"MATIC",color:"#8247E5",explorerUrl:"https://polygonscan.com",decimals:18};break;case 43114:b={name:"Avalanche",symbol:"AVAX",color:"#E84142",explorerUrl:"https://snowscan.xyz",decimals:18};break;case 42161:b={name:"Arbitrum One",symbol:"ETH",color:"#28A0F0",explorerUrl:"https://arbiscan.io",decimals:18};break;case 10:b={name:"Optimism",symbol:"ETH",color:"#FF0420",explorerUrl:"https://optimistic.etherscan.io",decimals:18};break;case 8453:b={name:"Base",symbol:"ETH",color:"#0052FF",explorerUrl:"https://basescan.org",decimals:18};break;case 250:b={name:"Fantom",symbol:"FTM",color:"#1969FF",explorerUrl:"https://ftmscan.com",decimals:18};break}console.log("TransactionMessage: Using fallback network info:",b),a(b)}}finally{m&&l(!1)}})(),()=>{m=!1}},[t.chainId]);const f=(()=>{switch(t.status){case"pending":return{icon:e.jsx(Ue,{size:16}),text:"Pending",className:"pending"};case"confirmed":return{icon:e.jsx(xt,{size:16}),text:"Confirmed",className:"confirmed"};case"failed":return{icon:e.jsx(pt,{size:16}),text:"Failed",className:"failed"};default:return{icon:e.jsx(Ue,{size:16}),text:"Unknown",className:"unknown"}}})(),h=m=>{const u=parseFloat(m);return u<1e-4?u.toExponential(2):u<1?u.toFixed(6):u<1e3?u.toFixed(4):u.toFixed(2)},d=s.explorerUrl?`${s.explorerUrl}/tx/${t.hash}`:null;return e.jsx("div",{className:"messageBox",children:e.jsxs("div",{className:`message transaction-message ${n?"own":""}`,children:[e.jsxs("div",{className:"transaction-header",children:[e.jsx("div",{className:"transaction-icon",children:e.jsx(Ne,{size:20})}),e.jsx("div",{className:"transaction-title",children:e.jsx("span",{children:n?`Sent to ${t.recipientName}`:`Received from ${t.senderName}`})}),e.jsxs("div",{className:`transaction-status ${f.className}`,children:[f.icon,e.jsx("span",{children:f.text})]})]}),e.jsxs("div",{className:"transaction-amount",children:[e.jsxs("span",{className:"amount",children:[n?"-":"+",h(t.amount)]}),e.jsx("span",{className:"currency",children:o?"...":s.symbol})]}),t.comment&&t.comment.trim()&&e.jsxs("div",{className:"transaction-comment",children:[e.jsx("div",{className:"comment-label",children:"Comment:"}),t.comment]}),e.jsx("div",{className:"transaction-network",children:e.jsxs("div",{className:"network-badge",style:{backgroundColor:s.color},children:[o?"Loading...":s.name,t.chainId&&!o&&e.jsxs("span",{style:{opacity:.7,fontSize:"10px",marginLeft:"4px"},children:["(",t.chainId,")"]})]})}),e.jsxs("div",{className:"transaction-details",children:[e.jsxs("div",{className:"detail-row",children:[e.jsx("span",{className:"label",children:"Hash:"}),e.jsxs("span",{className:"value hash",children:[t.hash.slice(0,8),"...",t.hash.slice(-6)]})]}),t.gasFee&&parseFloat(t.gasFee)>0&&e.jsxs("div",{className:"detail-row",children:[e.jsx("span",{className:"label",children:"Gas Fee:"}),e.jsxs("span",{className:"value",children:[parseFloat(t.gasFee).toFixed(6)," ",o?"...":s.symbol]})]}),d&&!o&&e.jsx("div",{className:"transaction-explorer",children:e.jsx("a",{href:d,target:"_blank",rel:"noopener noreferrer",className:"explorer-link",children:"View on Explorer →"})})]}),e.jsx("div",{className:"message-timestamp",children:new Date(i).toLocaleString()})]})})};function Oe({selectedChatId:t,users:n,getWalletById:i,onSendTransaction:s,recipientUser:a}){const[o,l]=r.useState([]),{address:c}=W(),{currentUser:f}=ae(),h=r.useRef(null),g=()=>{var d;(d=h.current)==null||d.scrollIntoView({behavior:"smooth"})};return r.useEffect(()=>{g()},[o]),r.useEffect(()=>{if(!t)return;const d=H(D,"privateChats",t,"msg"),m=Q(d,Se("ts","asc")),u=me(m,p=>{const b=[];p.forEach(N=>{const j=N.data();j.txt&&j.ts&&j.from?b.push(j):console.log("Missing fields in document:",N.id)}),console.log("Real-time Messages Update:",b),l(b)},p=>{console.error("Error fetching messages:",p)});return()=>u()},[t]),e.jsxs("div",{className:"chatContent",children:[o.map((d,m)=>{const u=f!=null&&f.id?d.from===f.id:!1;return d.type==="transaction"&&d.transactionData?e.jsx(Zt,{transaction:d.transactionData,own:u,timeStamp:d.ts.toMillis()},m):e.jsx(Yt,{text:d.txt,timeStamp:d.ts.toMillis(),from:d.from,own:u},m)}),e.jsx("div",{ref:h})," "]})}const ye=({chatName:t,onBack:n,showBackButton:i,showProfilePic:s=!1})=>{const{address:a}=W();return e.jsxs("div",{className:"chat-header",children:[e.jsxs("div",{className:"chat-header-left",children:[i&&e.jsx("button",{className:"back-button",onClick:n,title:"Go back",children:e.jsx(wt,{size:24})}),e.jsx("div",{className:"chat-header-info",children:e.jsx("h2",{className:"chat-header-title",children:t})})]}),e.jsx("div",{className:"chat-header-right",children:(s||!i)&&a&&e.jsx("div",{className:"header-profile-pic",children:e.jsx(ge,{eth:a})})})]})},Ve=({onClose:t,onChatCreated:n})=>{const[i,s]=r.useState([]),[a,o]=r.useState(!0),[l,c]=r.useState(null),[f,h]=r.useState(null),{currentUser:g}=ae();r.useEffect(()=>{(async()=>{try{o(!0);const p=H(D,"users"),N=(await te(p)).docs.map(x=>({id:x.id,name:x.data().name,wallet:x.data().wallet,chats:x.data().chats||[]})),j=g?N.filter(x=>x.id!==g.id):N;s(j)}catch(p){console.error("Error fetching users:",p),h("Failed to load users. Please try again.")}finally{o(!1)}})()},[g]);const d=async u=>{if(!g)return null;try{const p=H(D,"privateChats"),b=Q(p),N=await te(b);for(const j of N.docs){const k=j.data().pid||[];if(k.includes(g.id)&&k.includes(u))return j.id}return null}catch(p){return console.error("Error checking existing chat:",p),null}},m=async u=>{if(!g){h("You must be logged in to create a chat");return}c(u.id),h(null);try{const p=await d(u.id);if(p){console.log("Chat already exists:",p),n&&n(p),t();return}const b=H(D,"privateChats"),N=await Ee(b,{pid:[g.id,u.id],createdAt:new Date,lastActivity:new Date});console.log("Created new chat with ID:",N.id);const j=je(D,"users",g.id),x=je(D,"users",u.id);await Promise.all([Me(j,{chats:De(N.id)}),Me(x,{chats:De(N.id)})]),console.log("Updated users' chat lists"),n&&n(N.id),t()}catch(p){console.error("Error creating chat:",p),h("Failed to create chat. Please try again.")}finally{c(null)}};return e.jsx("div",{className:"modalOverlay",children:e.jsxs("div",{className:"modalContent",children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"20px"},children:[e.jsx("h2",{children:"Start New Chat"}),e.jsx("button",{className:"closeButton",onClick:t,style:{background:"transparent",border:"none",color:"#fff",cursor:"pointer",padding:"5px"},children:e.jsx(Te,{size:20})})]}),f&&e.jsx("div",{style:{color:"#ff4444",marginBottom:"15px",padding:"10px",background:"rgba(255, 68, 68, 0.1)",borderRadius:"8px"},children:f}),a?e.jsx("div",{style:{textAlign:"center",padding:"20px"},children:e.jsx("p",{children:"Loading users..."})}):i.length===0?e.jsx("div",{style:{textAlign:"center",padding:"20px"},children:e.jsx("p",{children:"No other users found."})}):e.jsxs("div",{style:{maxHeight:"60vh",overflowY:"auto",scrollbarWidth:"thin",scrollbarColor:"rgba(255, 255, 255, 0.2) transparent",paddingRight:"8px"},className:"modal-scroll-area",children:[e.jsx("p",{style:{marginBottom:"15px",color:"#ccc"},children:"Select a user to start chatting:"}),e.jsx("div",{style:{display:"flex",flexDirection:"column",gap:"10px"},children:i.map(u=>e.jsxs("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between",padding:"12px",background:"rgba(255, 255, 255, 0.05)",borderRadius:"8px",border:"1px solid rgba(255, 255, 255, 0.1)"},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"12px"},children:[e.jsx(ge,{eth:u.wallet}),e.jsxs("div",{children:[e.jsx("h4",{style:{margin:0,fontSize:"16px"},children:u.name}),e.jsxs("p",{style:{margin:0,fontSize:"12px",color:"#ccc",fontFamily:"monospace"},children:[u.wallet.slice(0,6),"...",u.wallet.slice(-4)]})]})]}),e.jsx("button",{onClick:()=>m(u),disabled:l===u.id,style:{background:l===u.id?"#666":"#50b458",border:"none",borderRadius:"50%",width:"40px",height:"40px",display:"flex",alignItems:"center",justifyContent:"center",cursor:l===u.id?"not-allowed":"pointer",color:"#fff",transition:"all 0.2s ease"},onMouseEnter:p=>{l!==u.id&&(p.target.style.background="#5bc464",p.target.style.transform="scale(1.05)")},onMouseLeave:p=>{l!==u.id&&(p.target.style.background="#50b458",p.target.style.transform="scale(1)")},children:l===u.id?e.jsx("div",{style:{width:"16px",height:"16px",border:"2px solid #fff",borderTop:"2px solid transparent",borderRadius:"50%",animation:"spin 1s linear infinite"}}):e.jsx(bt,{size:18})})]},u.id))})]}),e.jsx("style",{children:`
          @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
          }
          
          .modal-scroll-area::-webkit-scrollbar {
            width: 6px;
          }
          
          .modal-scroll-area::-webkit-scrollbar-track {
            background: transparent;
          }
          
          .modal-scroll-area::-webkit-scrollbar-thumb {
            background-color: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
          }
        `})]})})};function en(){const t=Tt(),[n,i]=r.useState(t),s=r.useRef(null),a=r.useRef(0);return r.useEffect(()=>{const l=Date.now()-a.current;if(s.current!==null&&l<2e3){console.log("useChainListener: Ignoring wagmi update",t,"due to recent direct update to",s.current);return}i(t),console.log("useChainListener: wagmi chain ID updated to",t)},[t]),r.useEffect(()=>{var l,c;const o=f=>{const h=parseInt(f,16);console.log("useChainListener: Direct chain change detected:",h,"(PRIORITY UPDATE)"),s.current=h,a.current=Date.now(),i(h)};if(typeof window<"u"&&window.ethereum)return(c=(l=window.ethereum).on)==null||c.call(l,"chainChanged",o),()=>{var f,h;(h=(f=window.ethereum).removeListener)==null||h.call(f,"chainChanged",o)}},[]),r.useEffect(()=>{(async()=>{if(typeof window<"u"&&window.ethereum)try{const l=await window.ethereum.request({method:"eth_chainId"}),c=parseInt(l,16);console.log("useChainListener: Initial chain ID from MetaMask:",c),c!==t&&(console.log("useChainListener: MetaMask chain ID differs from wagmi, using MetaMask value"),s.current=c,a.current=Date.now(),i(c))}catch(l){console.warn("useChainListener: Failed to get initial chain ID:",l)}})()},[]),n}const qe=({onClose:t,recipientUser:n,onTransactionSent:i})=>{const{address:s}=W(),{currentUser:a}=ae(),o=en(),l=It(),[c,f]=r.useState({name:"Loading...",symbol:"ETH",color:"#666666",explorerUrl:null,decimals:18}),[h,g]=r.useState(!0),[d,m]=r.useState(""),[u,p]=r.useState((n==null?void 0:n.wallet)||""),[b,N]=r.useState(""),[j,x]=r.useState("form"),[k,I]=r.useState(null),[E,F]=r.useState(null),M=()=>yt(u),C=()=>{try{const S=parseFloat(d);return S<=0||!y?!1:(U?parseFloat(U):S)<=parseFloat(y.formatted)}catch{return!1}},{data:y,isLoading:R,error:v,refetch:w}=At({address:s,chainId:o,query:{retry:3,retryDelay:1e3}}),{data:A,isLoading:B,refetch:P}=Ft({to:u,value:d?ie(d):void 0,chainId:o,query:{enabled:M()&&!!d&&parseFloat(d)>0,retry:2}}),{data:oe,refetch:K}=Rt({chainId:o,query:{retry:2}}),z=A&&oe?Be(A*oe):null,U=d&&z?(parseFloat(d)+parseFloat(z)).toString():null,{sendTransaction:re,data:T,error:Y,isPending:O,reset:q}=Ut(),{isLoading:X,isSuccess:_,isError:J,error:Z}=Mt({hash:T,timeout:6e4,query:{enabled:!!T,retry:5,retryDelay:2e3}});r.useEffect(()=>{let S=!0;return(async()=>{console.log("SendTransactionModal: Loading network info for chain ID:",o),g(!0);try{const G=await he(o);S&&(console.log("SendTransactionModal: Network info loaded:",G),f(G))}catch(G){if(console.error("SendTransactionModal: Failed to load network info for chain",o,":",G),S){let L={name:`Chain ${o}`,symbol:"ETH",color:"#666666",explorerUrl:null,decimals:18};o===43114?L={name:"Avalanche",symbol:"AVAX",color:"#E84142",explorerUrl:"https://snowscan.xyz",decimals:18}:o===56?L={name:"BNB Smart Chain",symbol:"BNB",color:"#F3BA2F",explorerUrl:"https://bscscan.com",decimals:18}:o===137&&(L={name:"Polygon",symbol:"MATIC",color:"#8247E5",explorerUrl:"https://polygonscan.com",decimals:18}),console.log("SendTransactionModal: Using fallback network info:",L),f(L)}}finally{S&&g(!1)}})(),()=>{S=!1}},[o]),r.useEffect(()=>{console.log("SendTransactionModal: chainId changed to",o,"- refreshing wagmi hooks"),w&&(console.log("SendTransactionModal: Refetching balance for chain",o),w().catch(console.warn)),P&&(console.log("SendTransactionModal: Refetching gas estimate for chain",o),P().catch(console.warn)),K&&(console.log("SendTransactionModal: Refetching gas price for chain",o),K().catch(console.warn))},[o,w,P,K]),r.useEffect(()=>{var V,G;const S=L=>{const $=parseInt(L,16);console.log("SendTransactionModal: Chain changed event detected, new chain:",$),g(!0),console.log("SendTransactionModal: Refreshing all wagmi hooks for new chain"),w&&w().catch(console.warn),P&&P().catch(console.warn),K&&K().catch(console.warn),he($).then(ee=>{console.log("SendTransactionModal: Network info refreshed after chain change:",ee),f(ee),g(!1)}).catch(ee=>{console.error("SendTransactionModal: Failed to refresh network info after chain change:",ee);let ne={name:`Chain ${$}`,symbol:"ETH",color:"#666666",explorerUrl:null,decimals:18};$===43114?ne={name:"Avalanche",symbol:"AVAX",color:"#E84142",explorerUrl:"https://snowscan.xyz",decimals:18}:$===56?ne={name:"BNB Smart Chain",symbol:"BNB",color:"#F3BA2F",explorerUrl:"https://bscscan.com",decimals:18}:$===137&&(ne={name:"Polygon",symbol:"MATIC",color:"#8247E5",explorerUrl:"https://polygonscan.com",decimals:18}),f(ne),g(!1)})};if(typeof window<"u"&&window.ethereum)return(G=(V=window.ethereum).on)==null||G.call(V,"chainChanged",S),()=>{var L,$;($=(L=window.ethereum).removeListener)==null||$.call(L,"chainChanged",S)}},[w,P,K]),r.useEffect(()=>{q(),x("form"),I(null),w&&w()},[q,w]),r.useEffect(()=>()=>{E&&clearTimeout(E)},[E]),r.useEffect(()=>{if(O){x("confirming"),I(null);const S=setTimeout(()=>{j==="confirming"&&(I("Transaction confirmation timed out. Please try again."),x("error"))},6e4);F(S)}},[O]),r.useEffect(()=>{T&&(E&&(clearTimeout(E),F(null)),!X&&!_&&!J&&x("pending"))},[T,X,_,J,E]),r.useEffect(()=>{if(_&&T){x("success");const S={hash:T,to:u,amount:d,chainId:o,timestamp:new Date,from:s,recipientName:(n==null?void 0:n.name)||"Unknown",senderName:(a==null?void 0:a.name)||"You",status:"confirmed",comment:b.trim()||void 0,gasUsed:A==null?void 0:A.toString(),gasFee:z||void 0};i&&i(S),setTimeout(()=>{t()},3e3)}},[_,T,u,d,o,s,n,a,i,t,b,A,z]),r.useEffect(()=>{if(Y||J){x("error");const S=(Y==null?void 0:Y.message)||(Z==null?void 0:Z.message)||"Transaction failed";S.includes("insufficient funds")?I("Insufficient funds for this transaction"):S.includes("user rejected")||S.includes("User denied")?I("Transaction was cancelled by user"):S.includes("gas")?I("Transaction failed due to gas issues"):S.includes("network")?I("Network error. Please check your connection and try again."):I("Transaction failed. Please try again."),E&&(clearTimeout(E),F(null))}},[Y,J,Z,E]);const Re=()=>C()&&M()&&!O&&!R&&y&&!h,ot=async()=>{if(Re())try{I(null),console.log("Sending transaction:",{to:u,value:ie(d),chainId:o}),re({to:u,value:ie(d)})}catch(S){console.error("Transaction error:",S),I("Failed to initiate transaction"),x("error")}},rt=["0.001","0.01","0.1"],at=S=>{m(S)},ct=async()=>{if(!y||!s||!l)return;const S=parseFloat(y.formatted);try{const V=oe;if(!V){alert("Unable to fetch gas price. Please try again in a moment.");return}const G=Math.min(1e-4,S*.01),L=ie(G.toString()),$=await l.estimateGas({account:s,to:u,value:L}),ee=$*BigInt(150)/BigInt(100),ne=ee*V,dt=Be(ne),fe=parseFloat(dt),pe=S-fe;if(pe<=0){alert(`Insufficient balance for transaction.

Balance: ${S} ${c.symbol}
Estimated gas fee (with buffer): ${fe.toFixed(8)} ${c.symbol}

You need more ${c.symbol} to cover gas fees.`);return}const xe=Math.min(pe,S*.99),ut=xe<.01?8:6;m(xe.toFixed(ut)),console.log("Max calculation with MetaMask 1.5x approach:",{balance:S,gasEstimate:$.toString(),gasWithBuffer:ee.toString(),gasPrice:V.toString(),txFee:fe,maxSendable:pe,finalAmount:xe})}catch(V){console.error("Error calculating max amount:",V),alert("Unable to calculate max amount. Please enter amount manually.")}},lt=()=>{w&&w()},ce=()=>!T||!c.explorerUrl?null:`${c.explorerUrl}/tx/${T}`,le=()=>{j==="confirming"&&!window.confirm("Are you sure you want to close? The transaction request may still be pending in your wallet.")||j==="pending"&&!window.confirm("Transaction is being processed on the blockchain. Are you sure you want to close? You can check the status using the transaction hash.")||(E&&clearTimeout(E),t())},it=()=>{switch(j){case"form":return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"transaction-form",children:[n&&e.jsxs("div",{className:"recipient-info",children:[e.jsx(ge,{eth:n.wallet}),e.jsxs("div",{className:"recipient-details",children:[e.jsx("h4",{children:n.name}),e.jsxs("p",{className:"recipient-address",children:[n.wallet.slice(0,6),"...",n.wallet.slice(-4)]})]})]}),v&&e.jsxs("div",{className:"error-message",children:["Failed to load balance.",e.jsx("button",{onClick:lt,style:{marginLeft:"10px",background:"#50b458",border:"none",color:"white",padding:"4px 8px",borderRadius:"4px",cursor:"pointer"},children:"Retry"})]}),e.jsxs("div",{className:"form-group",children:[e.jsxs("label",{children:["Amount (",h?"Loading...":c.symbol,")"]}),e.jsxs("div",{className:"amount-input-group",children:[e.jsx("input",{type:"number",value:d,onChange:S=>m(S.target.value),placeholder:"0.0",step:"0.0001",min:"0",max:(y==null?void 0:y.formatted)||"0",className:d&&!C()?"error":""}),e.jsxs("div",{className:"quick-amounts",children:[rt.map(S=>e.jsx("button",{type:"button",className:"quick-amount-btn",onClick:()=>at(S),children:S},S)),e.jsx("button",{type:"button",className:"quick-amount-btn",onClick:ct,disabled:!y,children:"Max"})]})]}),e.jsx("div",{className:"balance-info",children:R?e.jsx("span",{children:"Loading balance..."}):y?e.jsxs("span",{children:["Balance: ",parseFloat(y.formatted).toFixed(6)," ",y.symbol]}):e.jsx("span",{children:"Balance unavailable"})}),d&&!C()&&e.jsx("span",{className:"error-text",children:parseFloat(d)<=0?"Amount must be greater than 0":U&&parseFloat(U)>parseFloat((y==null?void 0:y.formatted)||"0")?"Insufficient balance (including gas fees)":"Insufficient balance"})]}),!n&&e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Recipient Address"}),e.jsx("input",{type:"text",value:u,onChange:S=>p(S.target.value),placeholder:"0x...",className:!M()&&u?"error":""}),u&&!M()&&e.jsx("span",{className:"error-text",children:"Invalid address"})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Comment (optional)"}),e.jsx("textarea",{value:b,onChange:S=>N(S.target.value),placeholder:"What's this transaction for?",maxLength:200,rows:3}),e.jsxs("div",{style:{fontSize:"12px",color:"#ccc",textAlign:"right",marginTop:"4px"},children:[b.length,"/200"]})]}),d&&parseFloat(d)>0&&e.jsxs("div",{className:"transaction-summary",children:[e.jsx("h4",{children:"Transaction Summary"}),e.jsxs("div",{className:"summary-row",children:[e.jsx("span",{children:"Amount to send:"}),e.jsxs("span",{children:[d," ",h?"Loading...":c.symbol]})]}),z&&e.jsxs("div",{className:"summary-row",children:[e.jsx("span",{children:"Estimated gas fee:"}),e.jsxs("span",{className:"gas-fee",children:[parseFloat(z).toFixed(6)," ",h?"Loading...":c.symbol]})]}),B&&e.jsxs("div",{className:"summary-row",children:[e.jsx("span",{children:"Estimating gas fee..."}),e.jsx("span",{className:"gas-loading",children:"⏳"})]}),U&&e.jsxs("div",{className:"summary-row total",children:[e.jsx("span",{children:e.jsx("strong",{children:"Total cost:"})}),e.jsx("span",{children:e.jsxs("strong",{children:[parseFloat(U).toFixed(6)," ",h?"Loading...":c.symbol]})})]}),d&&!C()&&U&&e.jsx("div",{className:"summary-warning",children:"⚠️ Insufficient balance for total cost including gas fees"})]}),e.jsx("div",{className:"network-info",children:e.jsxs("span",{children:["Sending on ",h?"Loading network...":c.name,o&&!h&&e.jsxs("span",{style:{opacity:.7,fontSize:"12px",marginLeft:"8px"},children:["(Chain ",o,")"]})]})})]}),e.jsxs("div",{className:"modal-footer",children:[e.jsx("button",{className:"cancel-btn",onClick:le,children:"Cancel"}),e.jsxs("button",{className:"send-btn",onClick:ot,disabled:!Re(),children:[e.jsx(Ne,{size:18}),"Send"]})]})]});case"confirming":return e.jsxs("div",{className:"transaction-status",children:[e.jsx("div",{className:"status-icon confirming",children:e.jsx("div",{className:"spinner"})}),e.jsx("h3",{children:"Confirm in Wallet"}),e.jsx("p",{children:"Please confirm the transaction in your wallet to continue."}),e.jsxs("p",{children:["Network: ",c.name]}),e.jsx("div",{className:"modal-footer",children:e.jsx("button",{className:"cancel-btn",onClick:le,children:"Cancel"})})]});case"pending":return e.jsxs("div",{className:"transaction-status",children:[e.jsx("div",{className:"status-icon pending",children:e.jsx("div",{className:"spinner"})}),e.jsx("h3",{children:"Transaction Pending"}),e.jsxs("p",{children:["Your transaction is being processed on ",c.name,"."]}),T&&e.jsxs("div",{className:"transaction-hash",children:[e.jsx("p",{children:"Transaction Hash:"}),e.jsxs("code",{children:[T.slice(0,10),"...",T.slice(-8)]})]}),ce()&&e.jsx("div",{className:"transaction-explorer",children:e.jsxs("a",{href:ce(),target:"_blank",rel:"noopener noreferrer",className:"explorer-link",children:["View on ",c.name," Explorer →"]})}),e.jsx("div",{className:"modal-footer",children:e.jsx("button",{className:"cancel-btn",onClick:le,children:"Close"})})]});case"success":return e.jsxs("div",{className:"transaction-status",children:[e.jsx("div",{className:"status-icon success",children:"✓"}),e.jsx("h3",{children:"Transaction Sent!"}),e.jsxs("p",{children:["Successfully sent ",d," ",c.symbol," to ",(n==null?void 0:n.name)||"recipient"]}),T&&e.jsxs("div",{className:"transaction-hash",children:[e.jsx("p",{children:"Transaction Hash:"}),e.jsxs("code",{children:[T.slice(0,10),"...",T.slice(-8)]})]}),ce()&&e.jsx("div",{className:"transaction-explorer",children:e.jsxs("a",{href:ce(),target:"_blank",rel:"noopener noreferrer",className:"explorer-link",children:["View on ",c.name," Explorer →"]})}),e.jsx("p",{className:"auto-close",children:"This window will close automatically..."})]});case"error":return e.jsxs("div",{className:"transaction-status",children:[e.jsx("div",{className:"status-icon error",children:"✕"}),e.jsx("h3",{children:"Transaction Failed"}),e.jsx("div",{className:"error-message",children:k}),e.jsxs("div",{className:"modal-footer",children:[e.jsx("button",{className:"cancel-btn",onClick:t,children:"Close"}),e.jsx("button",{className:"retry-btn",onClick:()=>{x("form"),I(null),q(),E&&(clearTimeout(E),F(null))},children:"Try Again"})]})]});default:return null}};return e.jsx("div",{className:"modalOverlay",children:e.jsxs("div",{className:"modalContent transaction-modal",children:[e.jsxs("div",{className:"modal-header",children:[e.jsxs("h2",{children:["Send ",h?"Loading...":c.symbol]}),(j==="form"||j==="error")&&e.jsx("button",{className:"closeButton",onClick:le,children:e.jsx(Te,{size:20})})]}),it()]})})},nt=()=>{const[t,n]=r.useState({width:typeof window<"u"?window.innerWidth:0,height:typeof window<"u"?window.innerHeight:0});r.useEffect(()=>{const o=()=>{n({width:window.innerWidth,height:window.innerHeight})};return window.addEventListener("resize",o),()=>window.removeEventListener("resize",o)},[]);const i=t.width<=768,s=t.width>768&&t.width<=1024,a=t.width>1024;return{isMobile:i,isTablet:s,isDesktop:a,windowSize:t}};function tn(){const{address:t}=W(),[n,i]=r.useState(null),[s,a]=r.useState([]),{setCurrentUser:o,currentUser:l}=ae(),[c,f]=r.useState(!1),[h,g]=r.useState(!1),[d,m]=r.useState(null),[u,p]=r.useState(null),{isMobile:b}=nt(),[N,j]=r.useState("list");r.useEffect(()=>{(async()=>{try{const w=H(D,"users"),B=(await te(w)).docs.map(P=>({id:P.id,name:P.data().name,wallet:P.data().wallet}));a(B),console.log("Fetched users:",B)}catch(w){console.error("Error fetching users:",w)}})()},[]),r.useEffect(()=>{(async()=>{if(!n){p(null);return}try{const w=await Ct(je(D,"privateChats",n));if(w.exists()){const A=w.data();p(A),console.log("Fetched chat data:",A)}else console.error("Chat document not found:",n),p(null)}catch(w){console.error("Error fetching chat data:",w),p(null)}})()},[n]),r.useEffect(()=>{if(s.length>0&&t){const v=s.find(w=>w.wallet===t);console.log("Current User:",v),o(v)}},[s,t,o]);const x=v=>{i(v),b&&j("chat")},k=()=>{b&&(j("list"),i(null))},I=v=>{console.log("New chat created with ID:",v),i(v),b&&j("chat")},E=v=>{const w=s.find(A=>A.id===v);return w?w.wallet:""},F=()=>{const v=M();return v?v.name:"Chat"},M=()=>{if(console.log("Getting recipient user..."),console.log("Selected chat ID:",n),console.log("Current chat data:",u),console.log("Current address:",t),console.log("Available users:",s),!n||!u||!t||s.length===0)return console.log("Missing required data for recipient detection"),null;const v=s.find(B=>B.wallet===t);if(!v)return console.log("Current user not found in users list"),null;console.log("Current user found:",v);const w=u.pid.find(B=>B!==v.id);if(!w)return console.log("Other participant ID not found in chat data"),null;console.log("Other participant ID:",w);const A=s.find(B=>B.id===w);return console.log("Recipient user found:",A),A||null},C=v=>{if(console.log("Handle send transaction called with:",v),!v||!v.wallet||!v.name){console.error("Invalid recipient user:",v);return}m(w=>(console.log("Setting recipient from",w,"to",v),v)),g(w=>(console.log("Setting modal visibility from",w,"to true"),!0))},y=async v=>{if(console.log("Transaction sent:",v),g(!1),m(null),n&&l)try{await Gt(v,n,l.id),console.log("Transaction message added to chat")}catch(w){console.error("Failed to add transaction message to chat:",w)}else console.error("Missing chat ID or current user for transaction message")},R=()=>{g(!1),m(null)};return r.useEffect(()=>{const v=M();console.log("Recipient user updated:",v)},[n,u,s,t]),b?e.jsxs("div",{className:"chat mobile-chat",children:[N==="list"?e.jsxs("div",{className:"mobile-chat-list",children:[e.jsx(ye,{chatName:"Chats",onBack:k,showBackButton:!1,showProfilePic:!0}),e.jsx("div",{className:"mobile-chat-selector",children:e.jsx(Le,{setSelectedChatId:x,users:s,getWalletById:E,selectedChatId:n})}),e.jsx("button",{className:"createChatButton mobile-create-chat",onClick:()=>f(!0),title:"Start new chat",children:e.jsx(Pe,{size:28})})]}):e.jsxs("div",{className:"mobile-chat-window",children:[e.jsx(ye,{chatName:F(),onBack:k,showBackButton:!0}),n&&e.jsx($e,{selectedChatId:n,onSendTransaction:C,recipientUser:M(),children:e.jsx(Oe,{selectedChatId:n,users:s,getWalletById:E,onSendTransaction:C,recipientUser:M()})})]}),c&&e.jsx(Ve,{onClose:()=>f(!1),onChatCreated:I}),h&&d&&e.jsx(qe,{onClose:R,recipientUser:d,onTransactionSent:y})]}):e.jsxs("div",{className:"chat desktop-chat",children:[e.jsx(Le,{setSelectedChatId:x,users:s,getWalletById:E,selectedChatId:n}),e.jsx("div",{className:"desktop-chat-area",children:n?e.jsxs(e.Fragment,{children:[e.jsx(ye,{chatName:F(),onBack:k,showBackButton:!1}),e.jsx($e,{selectedChatId:n,onSendTransaction:C,recipientUser:M(),children:e.jsx(Oe,{selectedChatId:n,users:s,getWalletById:E,onSendTransaction:C,recipientUser:M()})})]}):e.jsxs("div",{className:"desktop-chat-placeholder",children:[e.jsx("h2",{children:"Select a chat to start messaging"}),e.jsx("p",{children:"Choose a conversation from the sidebar or create a new one"})]})}),e.jsx("button",{className:"createChatButton desktop-create-chat",onClick:()=>f(!0),title:"Start new chat",children:e.jsx(Pe,{size:24})}),c&&e.jsx(Ve,{onClose:()=>f(!1),onChatCreated:I}),h&&d&&e.jsx(qe,{onClose:R,recipientUser:d,onTransactionSent:y})]})}function nn(){const{address:t}=W(),[n,i]=r.useState(null),s=Ie(),a=async o=>{const l=H(D,"users"),c=Q(l,ue("wallet","==",o));try{const h=!(await te(c)).empty;console.log("User found:",h),i(h),s(h?"/chat":"/signup")}catch(f){console.error("Error checking user:",f),i(!1),s("/signup")}};return e.jsxs("div",{children:[e.jsxs("button",{className:"proceedButton",onClick:()=>{t?a(t):console.error("Address is undefined")},children:[e.jsx(jt,{size:28}),e.jsx("span",{children:"Proceed"})]}),n!==null&&e.jsx("p",{children:n?"User exists":"User does not exist"})]})}function sn(){const{address:t,isConnected:n}=W(),{disconnect:i}=Fe(),s=r.useCallback(async()=>{try{console.log("Starting disconnect process..."),localStorage.removeItem("walletconnect"),localStorage.removeItem("walletConnected"),localStorage.removeItem("connectorId"),localStorage.removeItem("lastConnectedAddress");const a=[];for(let o=0;o<localStorage.length;o++){const l=localStorage.key(o);l&&(l.startsWith("w3m-")||l.startsWith("wagmi.")||l.startsWith("wc@2:")||l.includes("walletconnect"))&&a.push(l)}a.forEach(o=>{try{localStorage.removeItem(o)}catch(l){console.warn(`Failed to remove ${o}:`,l)}});try{const o=[];for(let l=0;l<sessionStorage.length;l++){const c=sessionStorage.key(l);c&&(c.startsWith("w3m-")||c.startsWith("wagmi.")||c.startsWith("wc@2:")||c.includes("walletconnect"))&&o.push(c)}o.forEach(l=>{try{sessionStorage.removeItem(l)}catch(c){console.warn(`Failed to remove session ${l}:`,c)}})}catch(o){console.warn("Error clearing sessionStorage:",o)}try{if("indexedDB"in window){const o=c=>new Promise((f,h)=>{const g=indexedDB.deleteDatabase(c);g.onsuccess=()=>f(!0),g.onerror=()=>h(g.error),g.onblocked=()=>{console.warn(`Database ${c} deletion blocked`),f(!1)}}),l=["walletconnect-v2","keyvaluestorage"];await Promise.allSettled(l.map(c=>o(c)))}}catch(o){console.warn("Error clearing IndexedDB:",o)}i(),await new Promise(o=>setTimeout(o,100)),console.log("Disconnect process completed")}catch(a){console.error("Error during disconnect:",a),i();try{localStorage.clear(),sessionStorage.clear()}catch(o){console.error("Failed to clear storage:",o)}setTimeout(()=>{window.location.reload()},1e3)}},[i]);return e.jsx("div",{className:"wallet-button",children:n&&t?e.jsxs("div",{className:"walletBubble",children:[e.jsxs("div",{className:"address",children:[t.slice(0,6),"...",t.slice(-4)]}),e.jsx("button",{onClick:s,title:"Disconnect wallet","aria-label":"Disconnect wallet",children:e.jsx(Te,{size:25})})]}):e.jsx("w3m-connect-button",{})})}function on(){const{address:t,isConnected:n,connector:i}=W(),{connect:s,connectors:a}=Dt(),{disconnect:o}=Fe(),[l,c]=r.useState(n);Ie();const{isMobile:f}=nt(),h=r.useCallback(async()=>{const g=localStorage.getItem("walletConnected")==="true",d=localStorage.getItem("lastConnectedAddress");if(!g||!d||n){console.log("No previous connection or already connected, skipping reconnection");return}console.log("Attempting to reconnect wallet automatically..."),console.log("Last connected address:",d);try{const m=localStorage.getItem("connectorId");if(console.log("Last used connector:",m),m){const u=a.find(p=>p.id===m);if(u){console.log("Reconnecting with saved connector:",m);const p=s({connector:u}),b=new Promise((N,j)=>setTimeout(()=>j(new Error("Connection timeout")),15e3));try{await Promise.race([p,b]),console.log("Reconnection successful")}catch(N){console.error("Failed to reconnect with saved connector:",N),N instanceof Error&&N.message.includes("timeout")?console.log("Connection timed out, keeping connector for retry"):(localStorage.removeItem("connectorId"),localStorage.removeItem("walletConnected"),localStorage.removeItem("lastConnectedAddress"))}}else console.log("Saved connector not found in available connectors"),localStorage.removeItem("connectorId")}else{const u=a.find(p=>p.id==="injected");if(u&&typeof window<"u"&&window.ethereum){console.log("No saved connector, trying injected...");try{const p=s({connector:u}),b=new Promise((N,j)=>setTimeout(()=>j(new Error("Connection timeout")),1e4));await Promise.race([p,b]),console.log("Injected connector reconnection successful")}catch(p){console.error("Failed to connect with injected connector:",p)}}}}catch(m){console.error("Error during reconnection attempt:",m),m instanceof Error&&m.message.includes("network")&&console.log("Network error during reconnection, will retry later")}},[s,a,n]);return r.useEffect(()=>{const g=setTimeout(()=>{h()},1500);return()=>clearTimeout(g)},[h]),r.useEffect(()=>{console.log("Connection state changed:",n?"connected":"disconnected"),console.log("Current connector:",i==null?void 0:i.id),console.log("Address:",t),c(n),n&&!l&&t&&(console.log("Wallet newly connected:",t),localStorage.setItem("walletConnected","true"),localStorage.setItem("lastConnectedAddress",t),localStorage.setItem("connectorId",(i==null?void 0:i.id)||""),console.log("Saved connection state for persistence")),!n&&l&&(console.log("Wallet disconnected"),localStorage.getItem("manualDisconnect")==="true"?(localStorage.removeItem("walletConnected"),localStorage.removeItem("lastConnectedAddress"),localStorage.removeItem("connectorId"),localStorage.removeItem("manualDisconnect"),console.log("Manual disconnect - cleared all connection data")):console.log("Automatic disconnect - keeping connection data for potential reconnection"))},[n,t,l,i]),r.useEffect(()=>{const g=async()=>{console.log("Page gained focus, checking connection state"),l&&!n&&(console.log("Connection lost while page was inactive, updating UI"),c(!1),localStorage.getItem("walletConnected")==="true"&&(console.log("Attempting reconnection after focus"),setTimeout(()=>{h()},1e3)));const d=localStorage.getItem("walletConnected")==="true",m=Date.now()-parseInt(localStorage.getItem("lastReconnectAttempt")||"0");d&&!n&&m>3e4&&(console.log("Should be connected but aren't, attempting reconnection"),localStorage.setItem("lastReconnectAttempt",Date.now().toString()),await h())};return window.addEventListener("focus",g),()=>{window.removeEventListener("focus",g)}},[l,n,h]),r.useCallback(async()=>{try{console.log("Manual disconnect initiated by user"),localStorage.setItem("manualDisconnect","true"),c(!1),localStorage.removeItem("walletConnected"),localStorage.removeItem("lastConnectedAddress"),localStorage.removeItem("connectorId"),localStorage.removeItem("lastReconnectAttempt"),console.log("Manual disconnect - cleared all persistence data"),o(),setTimeout(()=>{localStorage.removeItem("manualDisconnect")},2e3)}catch(g){console.error("Error during manual disconnect:",g),c(!1);try{Object.keys(localStorage).filter(m=>m.includes("wallet")||m.includes("w3m")||m.includes("wagmi")||m.includes("connector")||m.includes("Reconnect")).forEach(m=>localStorage.removeItem(m)),console.log("Cleared all wallet-related storage")}catch(d){console.error("Failed to clear storage:",d)}}},[o]),r.useEffect(()=>{const g=d=>{console.error("Connector error:",d.error),d.error.message.includes("User rejected")||d.error.message.includes("User denied")||d.error.message.includes("user cancelled")?(console.log("User rejected connection, clearing state"),localStorage.removeItem("walletConnected"),localStorage.removeItem("connectorId"),c(!1)):console.log("Temporary connector error, not clearing state")};if(i!=null&&i.emitter)return i.emitter.on("error",g),()=>{var d;(d=i.emitter)==null||d.off("error",g)}},[i]),r.useEffect(()=>{if(!n&&localStorage.getItem("walletConnected")==="true"){const d=setInterval(()=>{const m=parseInt(localStorage.getItem("lastReconnectAttempt")||"0");Date.now()-m>12e4&&(console.log("Periodic reconnection attempt"),localStorage.setItem("lastReconnectAttempt",Date.now().toString()),h())},6e4);return()=>clearInterval(d)}},[n,h]),e.jsxs("div",{className:`homepage ${f?"mobile-homepage":"desktop-homepage"}`,children:[e.jsxs("div",{className:"title",children:[e.jsx("h1",{children:"Chat 3.0 is here."}),e.jsx("h2",{children:"Your personal web3 companion."})]}),e.jsx("div",{children:e.jsxs("div",{className:"login",children:[e.jsx("h3",{children:l?`Connected ${i!=null&&i.id?`(${i.id})`:""}`:"Connect your wallet"}),e.jsx(sn,{}),l&&e.jsx(nn,{})]})})]})}function rn(){const{address:t,isConnected:n}=W(),i=Ie(),[s,a]=r.useState(""),[o,l]=r.useState(null),[c,f]=r.useState(!1),[h,g]=r.useState(!1),[d,m]=r.useState(!0),u=r.useCallback(async(x=0)=>{if(!t){m(!1);return}m(!0);try{console.log(`Checking if user exists (attempt ${x+1}):`,t);const k=H(D,"users"),I=Q(k,ue("wallet","==",t)),F=!(await te(I)).empty;g(F),console.log("User exists:",F),F&&(console.log("User already exists, redirecting to chat"),i("/chat"))}catch(k){if(console.error("Error checking if user exists:",k),x<3){console.log("Retrying user existence check..."),setTimeout(()=>{u(x+1)},1e3*(x+1));return}g(!1)}finally{m(!1)}},[t,i]);r.useEffect(()=>{u()},[u]),r.useEffect(()=>{n||(console.log("Wallet disconnected, redirecting to home"),i("/"))},[n,i]);const p=r.useCallback(async()=>{try{const x=H(D,"users"),k=Q(x,Se("name"),Ge(10)),E=(await te(k)).docs.map(F=>({id:F.id,...F.data()}));l({users:E}),console.log("Fetched user data:",E)}catch(x){console.error("Error fetching user data:",x),l({users:[]})}},[]);r.useEffect(()=>{p()},[p]);const b=r.useCallback(async()=>{if(!t||!s.trim()){console.error("Missing required data: address or name");return}if(h){console.log("User already exists, cannot register again");return}f(!0),console.log("Starting registration process:",t,s.trim());try{const x=H(D,"users"),k=Q(x,ue("wallet","==",t));if(!(await te(k)).empty){console.log("User already exists during registration attempt, redirecting"),g(!0),f(!1),i("/chat");return}let E=null,F=!1;const M=me(Q(x,ue("wallet","==",t)),y=>{!y.empty&&!F&&(F=!0,console.log("User successfully registered, redirecting to chat"),E&&clearTimeout(E),M(),i("/chat"))},y=>{console.error("Error in registration listener:",y),f(!1),E&&clearTimeout(E)});E=window.setTimeout(()=>{F||(console.log("Registration listener timeout, attempting manual check"),M(),u().then(()=>{f(!1)}))},15e3);const C=await Ee(x,{wallet:t,name:s.trim(),createdAt:new Date,chats:[]});console.log("Registration document written with ID:",C.id)}catch(x){console.error("Error during registration:",x),f(!1);const k=x instanceof Error?x.message:"Unknown error";k.includes("permission")||k.includes("rules")?alert("Registration failed: Permission denied. Please try again or contact support."):k.includes("network")||k.includes("offline")?alert("Registration failed: Network error. Please check your connection and try again."):alert("Registration failed: "+k)}},[t,s,h,i,u]),N=r.useCallback(x=>{x.key==="Enter"&&!c&&!h&&s.trim()&&b()},[b,c,h,s]),j=r.useCallback(x=>{const k=x.trim();return k.length>=2&&k.length<=50&&/^[a-zA-Z0-9\s._-]+$/.test(k)},[]);return d?e.jsxs("div",{className:"centered-signup",children:[e.jsxs("div",{className:"welcomeText",children:[e.jsx("h1",{children:"Checking registration status..."}),e.jsx("h2",{children:"Please wait"})]}),e.jsx("div",{style:{marginTop:"20px",color:"#ccc"},children:e.jsxs("p",{children:["Wallet: ",t]})})]}):h?e.jsxs("div",{className:"centered-signup",children:[e.jsxs("div",{className:"welcomeText",children:[e.jsx("h1",{children:"Already Registered"}),e.jsx("h2",{children:"You're already signed up! Redirecting to chat..."})]}),e.jsxs("p",{children:["Wallet Address: ",t]})]}):!n||!t?e.jsxs("div",{className:"centered-signup",children:[e.jsxs("div",{className:"welcomeText",children:[e.jsx("h1",{children:"Wallet Not Connected"}),e.jsx("h2",{children:"Please connect your wallet to continue"})]}),e.jsx("button",{onClick:()=>i("/"),style:{padding:"12px 24px",backgroundColor:"#50b458",color:"white",border:"none",borderRadius:"8px",cursor:"pointer",marginTop:"20px"},children:"Go Back to Home"})]}):e.jsxs("div",{className:"centered-signup",children:[e.jsxs("div",{className:"welcomeText",children:[e.jsx("h1",{children:"Welcome to Chat 3.0"}),e.jsx("h2",{children:"One last step to start chatting"})]}),e.jsx("div",{style:{marginBottom:"20px",color:"#ccc"},children:e.jsxs("p",{children:["Wallet: ",t.slice(0,6),"...",t.slice(-4)]})}),e.jsxs("div",{className:"signupBox",children:[e.jsx("input",{type:"text",placeholder:"Enter your display name",value:s,onChange:x=>a(x.target.value),onKeyPress:N,disabled:c,maxLength:50,minLength:2,autoComplete:"off",autoFocus:!0}),e.jsx("button",{onClick:b,disabled:c||!s.trim()||!j(s),title:!j(s)&&s.trim()?"Name must be 2-50 characters and contain only letters, numbers, spaces, dots, hyphens, and underscores":"",children:c?"Registering...":"Register"})]}),s.trim()&&!j(s)&&e.jsx("p",{style:{color:"#ff4444",fontSize:"14px",marginTop:"10px",textAlign:"center"},children:"Name must be 2-50 characters and contain only letters, numbers, spaces, dots, hyphens, and underscores"}),c&&e.jsx("p",{style:{color:"#50b458",marginTop:"15px",textAlign:"center"},children:"Creating your account, please wait..."}),!c&&!h&&(o==null?void 0:o.users)&&e.jsx("div",{style:{marginTop:"20px",textAlign:"center"},children:e.jsx("button",{onClick:()=>u(),style:{padding:"8px 16px",backgroundColor:"transparent",color:"#50b458",border:"1px solid #50b458",borderRadius:"6px",cursor:"pointer",fontSize:"14px"},children:"Retry Check"})})]})}const an=()=>{const{address:t,isConnected:n,status:i,connector:s}=W(),{disconnect:a}=Fe(),o=r.useRef(n),l=r.useRef(null),c=r.useRef(!1),f=r.useRef(0),h=r.useCallback(async()=>{const d=Date.now();if(d-f.current<5e3)return n;f.current=d;try{if(!n||!s||c.current)return!1;if(s.id==="walletConnect")try{const u=await s.getProvider();if(u.session===null&&u.connected===!1)return console.log("WalletConnect session explicitly ended"),!1}catch(m){return console.warn("WalletConnect provider check error (not disconnecting):",m),!0}if(s.id==="injected"&&typeof window<"u"&&window.ethereum)try{const m=await window.ethereum.request({method:"eth_accounts"});if(!m||m.length===0)return console.log("No accounts available from injected provider"),!1}catch(m){return console.warn("Injected provider check error (not disconnecting):",m),!0}return!0}catch(m){return console.warn("Error validating connection (assuming valid):",m),!0}},[n,s]),g=r.useCallback(async()=>{if(!c.current){c.current=!0;try{console.log("Forcing disconnect due to clear connection failure"),localStorage.removeItem("walletConnected"),localStorage.removeItem("lastConnectedAddress"),localStorage.removeItem("connectorId"),a()}catch(d){console.error("Error during force disconnect:",d)}finally{setTimeout(()=>{c.current=!1},3e3)}}},[a]);return r.useEffect(()=>{console.log("Connection status changed:",i),console.log("Is connected:",n),console.log("Current connector:",s==null?void 0:s.id),o.current&&!n&&!c.current&&(console.log("Detected disconnection, cleaning up state"),localStorage.removeItem("walletConnected"),localStorage.removeItem("lastConnectedAddress"),localStorage.removeItem("connectorId")),n&&t&&!c.current?(localStorage.setItem("walletConnected","true"),localStorage.setItem("lastConnectedAddress",t),localStorage.setItem("connectorId",(s==null?void 0:s.id)||""),console.log("Saved connection state to localStorage")):!n&&!c.current&&(localStorage.removeItem("walletConnected"),localStorage.removeItem("lastConnectedAddress"),localStorage.removeItem("connectorId"),console.log("Removed connection state from localStorage")),o.current=n},[n,t,i,s]),r.useEffect(()=>(n?(()=>{l.current&&clearInterval(l.current);const m=async()=>{try{n&&!c.current&&(await h()||(console.log("Clear connection failure detected, forcing disconnect"),await g()))}catch(u){console.warn("Error in periodic connection check (not disconnecting):",u)}};l.current=window.setInterval(m,3e4)})():l.current&&(clearInterval(l.current),l.current=null),()=>{l.current&&(clearInterval(l.current),l.current=null)}),[n,h,g]),r.useEffect(()=>{const d=async()=>{document.visibilityState==="visible"&&(console.log("Page is now visible, gentle connection check"),setTimeout(async()=>{if(n&&!c.current)try{await h()||(console.log("Clear connection failure after page became visible"),await g())}catch(m){console.warn("Error checking connection on visibility change (ignoring):",m)}},2e3))};return document.addEventListener("visibilitychange",d),()=>{document.removeEventListener("visibilitychange",d)}},[n,h,g]),r.useEffect(()=>{var u,p,b,N;const d=j=>{console.log("Network change detected to chain:",j),f.current=0},m=j=>{console.log("Accounts changed:",j),j.length===0&&n&&!c.current&&(console.log("All accounts removed by user, forcing disconnect"),g())};if(typeof window<"u"&&window.ethereum)return(p=(u=window.ethereum).on)==null||p.call(u,"chainChanged",d),(N=(b=window.ethereum).on)==null||N.call(b,"accountsChanged",m),()=>{var j,x,k,I;(x=(j=window.ethereum).removeListener)==null||x.call(j,"chainChanged",d),(I=(k=window.ethereum).removeListener)==null||I.call(k,"accountsChanged",m)}},[n,g]),r.useEffect(()=>{const d=m=>{m.key==="manualDisconnect"&&m.newValue==="true"&&(console.log("Manual disconnect detected"),c.current=!0,setTimeout(()=>{c.current=!1},5e3))};return window.addEventListener("storage",d),()=>{window.removeEventListener("storage",d)}},[]),null},cn=new vt({defaultOptions:{queries:{retry:3,retryDelay:t=>Math.min(1e3*2**t,3e4),staleTime:5*60*1e3,refetchOnWindowFocus:!0,refetchOnReconnect:!0}}}),ve="02ee764d5cc25cff6387d6d3f7943fd6",Ce={name:"TokenChat",description:"Web3 Chat Application",url:"https://c4ctus96.github.io/tokenchat",icons:["https://avatars.githubusercontent.com/u/37784886"]},ln=[Ae,Xe,Qe,_e,Ye,Ke],st=Bt({chains:ln,transports:{[Ae.id]:se("https://ethereum-rpc.publicnode.com"),[Xe.id]:se("https://bsc-dataseed1.defibit.io"),[Qe.id]:se("https://polygon-rpc.com"),[_e.id]:se("https://arbitrum-one-rpc.publicnode.com"),[Ye.id]:se("https://optimism-rpc.publicnode.com"),[Ke.id]:se("https://base-rpc.publicnode.com")},connectors:[Pt({projectId:ve,metadata:Ce,showQrModal:!1}),Lt({shimDisconnect:!0,target:{id:"injected",name:"Injected",provider:typeof window<"u"?window.ethereum:void 0}}),$t({appName:Ce.name,appLogoUrl:Ce.icons[0]}),Ht({options:{projectId:ve},socials:["google","x","github","discord","apple"],showWallets:!0,email:!0,walletFeatures:!1})],ssr:!1});Wt({wagmiConfig:st,projectId:ve,defaultChain:Ae,themeMode:"dark",enableAnalytics:!0,enableOnramp:!1,themeVariables:{"--w3m-accent":"#50b458","--w3m-color-mix":"#210059","--w3m-color-mix-strength":30},featuredWalletIds:["c57ca95b47569778a828d19178114f4db188b89b763c899ba0be274e97267d96","4622a2b2d6af1c9844944291e5e7351a6aa24cd7b23099efac1b2fd875da31a0","fd20dc426fb37566d803205b19bbc1d4096b248ac04548e3cfb6b3a38bd033aa"],includeWalletIds:[],excludeWalletIds:[]});function dn({children:t}){const{isConnected:n}=W();return n?e.jsx(e.Fragment,{children:t}):e.jsx(Je,{to:"/"})}function un(){const{isConnected:t,address:n,connector:i}=W();return r.useEffect(()=>{console.log("App initialized with connection status:",t),console.log("Current address:",n),console.log("Current connector:",i==null?void 0:i.id),typeof window.ethereum>"u"?console.log("MetaMask not detected, but WalletConnect and other wallets can still be used"):console.log("Ethereum provider detected:",window.ethereum.isMetaMask?"MetaMask":"Other");const a=setTimeout(()=>{const o=localStorage.getItem("walletConnected"),l=localStorage.getItem("lastConnectedAddress"),c=localStorage.getItem("manualDisconnect")==="true";o==="true"&&l&&!t&&!c&&console.log("Detected potential connection state mismatch")},3e3);return()=>{clearTimeout(a)}},[t,n,i]),r.useEffect(()=>{const s=a=>{var o,l,c,f,h,g,d,m,u,p,b,N;console.error("Unhandled promise rejection:",a.reason),(l=(o=a.reason)==null?void 0:o.message)!=null&&l.includes("User rejected")||(f=(c=a.reason)==null?void 0:c.message)!=null&&f.includes("User denied")||(g=(h=a.reason)==null?void 0:h.message)!=null&&g.includes("user cancelled")?(console.log("User rejected wallet action, clearing connection state"),localStorage.removeItem("walletConnected"),localStorage.removeItem("connectorId")):((m=(d=a.reason)==null?void 0:d.message)!=null&&m.includes("wallet")||(p=(u=a.reason)==null?void 0:u.message)!=null&&p.includes("connection")||(N=(b=a.reason)==null?void 0:b.message)!=null&&N.includes("provider"))&&console.log("Wallet-related error detected, but not clearing state automatically")};return window.addEventListener("unhandledrejection",s),()=>{window.removeEventListener("unhandledrejection",s)}},[]),r.useEffect(()=>{var a,o;const s=l=>{const c=parseInt(l,16);console.log("Network change detected in app - Chain ID:",c),localStorage.setItem("lastNetworkChange",JSON.stringify({chainId:c,timestamp:Date.now(),address:n}))};if(typeof window<"u"&&window.ethereum)return(o=(a=window.ethereum).on)==null||o.call(a,"chainChanged",s),()=>{var l,c;(c=(l=window.ethereum).removeListener)==null||c.call(l,"chainChanged",s)}},[n]),null}class mn extends ke.Component{constructor(n){super(n),this.state={hasError:!1}}static getDerivedStateFromError(n){return{hasError:!0,error:n}}componentDidCatch(n,i){var s,a,o,l,c,f;console.error("Error boundary caught an error:",n,i),(s=n.message)!=null&&s.includes("User rejected")||(a=n.message)!=null&&a.includes("User denied")||(o=n.message)!=null&&o.includes("user cancelled")?(console.log("Clearing wallet state due to user rejection error"),localStorage.removeItem("walletConnected"),localStorage.removeItem("connectorId"),localStorage.removeItem("lastConnectedAddress")):((l=n.message)!=null&&l.includes("wallet")||(c=n.message)!=null&&c.includes("connection")||(f=n.message)!=null&&f.includes("provider"))&&console.log("Wallet-related error caught, but not clearing state automatically")}render(){var n;return this.state.hasError?e.jsxs("div",{style:{display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",minHeight:"100vh",padding:"20px",backgroundColor:"#000",color:"#fff",textAlign:"center"},children:[e.jsx("h1",{children:"Something went wrong"}),e.jsx("p",{children:"The application encountered an unexpected error."}),e.jsxs("details",{style:{marginTop:"20px",fontSize:"14px",opacity:.7},children:[e.jsx("summary",{children:"Error Details"}),e.jsx("pre",{style:{marginTop:"10px",textAlign:"left"},children:(n=this.state.error)==null?void 0:n.message})]}),e.jsxs("div",{style:{display:"flex",gap:"10px",marginTop:"20px"},children:[e.jsx("button",{onClick:()=>{this.setState({hasError:!1})},style:{padding:"12px 24px",backgroundColor:"#50b458",color:"white",border:"none",borderRadius:"8px",cursor:"pointer"},children:"Try Again"}),e.jsx("button",{onClick:()=>{try{Object.keys(localStorage).filter(s=>s.includes("w3m-")||s.includes("wagmi.")||s.includes("wc@2:")).forEach(s=>localStorage.removeItem(s))}catch(i){console.error("Error clearing storage:",i)}window.location.reload()},style:{padding:"12px 24px",backgroundColor:"#ff4444",color:"white",border:"none",borderRadius:"8px",cursor:"pointer"},children:"Reset & Reload"})]})]}):this.props.children}}function hn(){return e.jsx(mn,{children:e.jsx(zt,{config:st,children:e.jsx(St,{client:cn,children:e.jsx(Vt,{children:e.jsxs(kt,{basename:"/tokenchat",children:[e.jsx(un,{}),e.jsx(an,{}),!1,e.jsxs(Nt,{children:[e.jsx(de,{path:"/",element:e.jsx(on,{})}),e.jsx(de,{path:"/chat",element:e.jsx(dn,{children:e.jsx(tn,{})})}),e.jsx(de,{path:"/signup",element:e.jsx(rn,{})}),e.jsx(de,{path:"*",element:e.jsx(Je,{to:"/",replace:!0})})]})]})})})})})}const gn=document.getElementById("root"),fn=Et(gn);fn.render(e.jsx(ke.StrictMode,{children:e.jsx(hn,{})}));
//# sourceMappingURL=index-zSRL9l6h.js.map
