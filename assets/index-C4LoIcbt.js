import{aL as es,aM as ss,aN as ts,aO as e,aG as i,aP as U,aQ as J,aR as z,aS as le,aT as Z,aU as W,aV as Be,aW as ns,aX as he,aY as me,aZ as we,a_ as as,a$ as rs,b0 as os,b1 as fe,b2 as cs,b3 as de,b4 as ve,b5 as Ne,b6 as _,b7 as Ce,b8 as is,b9 as Se,ba as ls,bb as ge,bc as ds,bd as X,be as us,bf as Ie,bg as $,bh as Ae,bi as Ue,bj as Pe,bk as Re,aE as pe,bl as hs,bm as ms,bn as fs,bo as oe,bp as gs,bq as ps}from"./react-BQ9x1fCz.js";import{u as R,a as xs,b as js,c as bs,d as ys,e as ws,f as vs,g as Ns,h as De,i as Cs,j as Ss,w as Es,k as ks,l as Ts,m as Fs,n as Ms,W as Bs}from"./web3-B54BSiBt.js";import"./walletconnect-K2htmtcq.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))a(o);new MutationObserver(o=>{for(const r of o)if(r.type==="childList")for(const m of r.addedNodes)m.tagName==="LINK"&&m.rel==="modulepreload"&&a(m)}).observe(document,{childList:!0,subtree:!0});function c(o){const r={};return o.integrity&&(r.integrity=o.integrity),o.referrerPolicy&&(r.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?r.credentials="include":o.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function a(o){if(o.ep)return;o.ep=!0;const r=c(o);fetch(o.href,r)}})();const Is={apiKey:"AIzaSyBRDBbrJbmLwb3YTI_YBmMdTjLEd8KjS2E",authDomain:"tokenchat-b8673.firebaseapp.com",projectId:"tokenchat-b8673",storageBucket:"tokenchat-b8673.appspot.com",messagingSenderId:"593980787293",appId:"1:593980787293:web:7c58ff7656a3fa31b19bb4",measurementId:"G-RB9WJLVQC0"},Le=es(Is);ss(Le);const B=ts(Le),ee=({eth:s})=>e.jsx("div",{children:e.jsx("img",{src:`https://effigy.im/a/${s}.svg`,alt:"Profile picture",className:"profilePic"})});function Ee({setSelectedChatId:s,users:t,getWalletById:c,selectedChatId:a}){const{address:o}=R(),[r,m]=i.useState([]),[l,w]=i.useState(null);i.useEffect(()=>{if(!o)return;const n=U(B,"privateChats"),d=J(n,async j=>{var P;try{const C=[];for(const A of j.docs){const I=A.data(),S={id:A.id,pid:I.pid||[]};try{const T=U(B,"privateChats",A.id,"msg"),L=z(T,Z("ts","desc"),le(1)),p=await W(L);if(p.empty)S.lastMessage="No messages yet",S.lastMessageTime=new Date(0);else{const v=p.docs[0].data();S.lastMessage=v.txt||"",S.lastMessageTime=((P=v.ts)==null?void 0:P.toDate())||new Date}}catch(T){console.error(`Error fetching messages for chat ${A.id}:`,T),S.lastMessage="Failed to load",S.lastMessageTime=new Date(0)}C.push(S)}C.sort((A,I)=>{var L,p;const S=((L=A.lastMessageTime)==null?void 0:L.getTime())||0;return(((p=I.lastMessageTime)==null?void 0:p.getTime())||0)-S}),console.log("Real-time chatrooms update:",C),m(C),w(null)}catch(C){w("Failed to fetch chat data. Please check your internet connection."),console.error("Snapshot error:",C)}},j=>{w("Failed to fetch data. Please check your internet connection."),console.error("Fetch error:",j)});return()=>d()},[o]),i.useEffect(()=>{(async()=>{if("Notification"in window&&Notification.permission==="default"){const d=await Notification.requestPermission();console.log("Notification permission:",d)}})()},[]),i.useEffect(()=>{if(!o||r.length===0)return;const n=t.find(j=>j.wallet===o);if(!n)return;const d=[];return r.forEach(j=>{if(j.pid.includes(n.id)){const P=U(B,"privateChats",j.id,"msg"),C=z(P,Z("ts","desc"),le(1)),A=J(C,I=>{if(!I.empty&&j.id!==a){const S=I.docs[0].data();if(S.from!==n.id){const T=k(S.from);x(T,S.txt)}}});d.push(A)}}),()=>{d.forEach(j=>j())}},[r,o,t,a]);const x=(n,d)=>{if("Notification"in window&&Notification.permission==="granted"){const j=d.length>50?d.substring(0,50)+"...":d;new Notification(`New message from ${n}`,{body:j,icon:"/favicon.ico",badge:"/favicon.ico",tag:"new-message"})}},f=t.find(n=>n.wallet===o),u=f?r.filter(n=>n.pid.includes(f.id)):[],k=n=>{const d=t.find(j=>j.id===n);return d?d.name:n},h=n=>f&&n.find(d=>d!==f.id)||"",g=n=>{const d=h(n);return k(d)},N=(n,d=40)=>n.length<=d?n:n.substring(0,d)+"...",y=n=>{s(n)};return e.jsxs("div",{className:"chatSelector",children:[l&&e.jsx("p",{className:"error",children:l}),u.length>0?u.map(n=>e.jsxs("div",{className:"contactBox",onClick:()=>y(n.id),style:{backgroundColor:n.id===a?"#003344":"#002233",cursor:"pointer"},children:[e.jsx(ee,{eth:c(h(n.pid))}),e.jsxs("div",{className:"contactTextBox",children:[e.jsx("h3",{style:{fontSize:"16px",fontWeight:"bold"},children:g(n.pid)}),e.jsx("p",{style:{margin:0,fontSize:"14px",color:"#ccc",opacity:.8,lineHeight:"1.2"},children:N(n.lastMessage||"No messages yet")})]})]},n.id)):e.jsxs("div",{style:{padding:"20px",textAlign:"center",color:"#ccc"},children:[e.jsx("p",{children:"No chats yet"}),e.jsx("p",{style:{fontSize:"14px",marginTop:"10px"},children:"Click the + button to start a new conversation"})]})]})}const ze=i.createContext(void 0),As=({children:s})=>{const[t,c]=i.useState(void 0);return e.jsx(ze.Provider,{value:{currentUser:t,setCurrentUser:c},children:s})},O=()=>{const s=i.useContext(ze);if(!s)throw new Error("useUser must be used within a UserProvider");return s},We=async(s,t,c,a="text",o)=>{try{const r=U(B,"privateChats",c,"msg"),m={txt:s,from:t,ts:new Date,type:a};a==="transaction"&&o&&(m.transactionData=o),await me(r,m),console.log("Message sent successfully")}catch(r){throw console.error("Error sending message:",r),r}},Us=({selectedChatId:s,onSendTransaction:t,recipientUser:c})=>{const[a,o]=Be.useState(""),{currentUser:r}=O(),m=f=>{o(f.target.value)},l=async()=>{if(!s||!r||!a.trim()){console.error("Missing required data:",{selectedChatId:s,currentUser:r,inputValue:a});return}try{await We(a.trim(),r.id,s),o("")}catch(f){console.error("Failed to send message:",f)}},w=()=>{if(!c||!t){console.error("Missing recipient data for transaction");return}t(c)},x=f=>{f.key==="Enter"&&!f.shiftKey&&(f.preventDefault(),l())};return e.jsxs("div",{className:"chatBottomBar",children:[e.jsx("input",{type:"text",className:"messageInput",placeholder:"Type your message...",value:a,onChange:m,onKeyDown:x}),e.jsx("button",{className:"transactionButton",onClick:w,disabled:!s||!r||!c,title:"Send crypto",children:e.jsx(ns,{size:20})}),e.jsx("button",{className:"sendMessageButton",onClick:l,disabled:!s||!r||!a.trim(),title:"Send message",children:e.jsx(he,{size:20})})]})},Ps=async(s,t,c)=>{try{let a=`Sent ${s.amount} ${Rs(s.chainId)} to ${s.recipientName}`;s.comment&&(a+=` - ${s.comment}`),await We(a,c,t,"transaction",s),console.log("Transaction message sent to chat")}catch(a){throw console.error("Failed to send transaction message:",a),a}},Rs=s=>{switch(s){case 1:return"ETH";case 56:return"BNB";case 137:return"MATIC";case 42161:return"ETH";case 10:return"ETH";case 8453:return"ETH";case 43114:return"AVAX";case 250:return"FTM";default:return"ETH"}};function ke({children:s,selectedChatId:t,onSendTransaction:c,recipientUser:a}){return e.jsxs("div",{className:"chatWindow",children:[e.jsx("div",{className:"chatContent",children:s}),e.jsx(Us,{selectedChatId:t,onSendTransaction:c,recipientUser:a||void 0})]})}const Ds=({text:s,timeStamp:t,from:c,own:a})=>e.jsx("div",{className:"messageBox",children:e.jsxs("div",{className:`message ${a?"own":""}`,children:[e.jsx("p",{className:"message-text",children:s}),e.jsx("p",{className:"message-timestamp",children:new Date(t).toLocaleString()})]})}),Ls=({transaction:s,own:t,timeStamp:c})=>{const o=(f=>{switch(f){case 1:return{name:"Ethereum",symbol:"ETH",color:"#627EEA",explorerUrl:"https://etherscan.io"};case 56:return{name:"BSC",symbol:"BNB",color:"#F3BA2F",explorerUrl:"https://bscscan.com"};case 137:return{name:"Polygon",symbol:"MATIC",color:"#8247E5",explorerUrl:"https://polygonscan.com"};case 42161:return{name:"Arbitrum",symbol:"ETH",color:"#28A0F0",explorerUrl:"https://arbiscan.io"};case 10:return{name:"Optimism",symbol:"ETH",color:"#FF0420",explorerUrl:"https://optimistic.etherscan.io"};case 8453:return{name:"Base",symbol:"ETH",color:"#0052FF",explorerUrl:"https://basescan.org"};case 43114:return{name:"Avalanche",symbol:"AVAX",color:"#E84142",explorerUrl:"https://snowtrace.io"};case 250:return{name:"Fantom",symbol:"FTM",color:"#1969FF",explorerUrl:"https://ftmscan.com"};default:return{name:"Unknown",symbol:"ETH",color:"#666",explorerUrl:null}}})(s.chainId),m=(()=>{switch(s.status){case"pending":return{icon:e.jsx(we,{size:16}),text:"Pending",className:"pending"};case"confirmed":return{icon:e.jsx(rs,{size:16}),text:"Confirmed",className:"confirmed"};case"failed":return{icon:e.jsx(as,{size:16}),text:"Failed",className:"failed"};default:return{icon:e.jsx(we,{size:16}),text:"Unknown",className:"unknown"}}})(),l=f=>{const u=parseFloat(f);return u<1e-4?u.toExponential(2):u<1?u.toFixed(6):u<1e3?u.toFixed(4):u.toFixed(2)},x=o.explorerUrl?`${o.explorerUrl}/tx/${s.hash}`:null;return e.jsx("div",{className:"messageBox",children:e.jsxs("div",{className:`message transaction-message ${t?"own":""}`,children:[e.jsxs("div",{className:"transaction-header",children:[e.jsx("div",{className:"transaction-icon",children:e.jsx(he,{size:20})}),e.jsx("div",{className:"transaction-title",children:e.jsx("span",{children:t?`Sent to ${s.recipientName}`:`Received from ${s.senderName}`})}),e.jsxs("div",{className:`transaction-status ${m.className}`,children:[m.icon,e.jsx("span",{children:m.text})]})]}),e.jsxs("div",{className:"transaction-amount",children:[e.jsxs("span",{className:"amount",children:[t?"-":"+",l(s.amount)]}),e.jsx("span",{className:"currency",children:o.symbol})]}),s.comment&&s.comment.trim()&&e.jsxs("div",{className:"transaction-comment",children:[e.jsx("div",{className:"comment-label",children:"Comment:"}),s.comment]}),e.jsx("div",{className:"transaction-network",children:e.jsx("div",{className:"network-badge",style:{backgroundColor:o.color},children:o.name})}),e.jsxs("div",{className:"transaction-details",children:[e.jsxs("div",{className:"detail-row",children:[e.jsx("span",{className:"label",children:"Hash:"}),e.jsxs("span",{className:"value hash",children:[s.hash.slice(0,8),"...",s.hash.slice(-6)]})]}),s.gasFee&&parseFloat(s.gasFee)>0&&e.jsxs("div",{className:"detail-row",children:[e.jsx("span",{className:"label",children:"Gas Fee:"}),e.jsxs("span",{className:"value",children:[parseFloat(s.gasFee).toFixed(6)," ",o.symbol]})]}),x&&e.jsx("div",{className:"transaction-explorer",children:e.jsx("a",{href:x,target:"_blank",rel:"noopener noreferrer",className:"explorer-link",children:"View on Explorer →"})})]}),e.jsx("div",{className:"message-timestamp",children:new Date(c).toLocaleString()})]})})};function Te({selectedChatId:s,users:t,getWalletById:c,onSendTransaction:a,recipientUser:o}){const[r,m]=i.useState([]),{address:l}=R(),{currentUser:w}=O(),x=i.useRef(null),f=()=>{var u;(u=x.current)==null||u.scrollIntoView({behavior:"smooth"})};return i.useEffect(()=>{f()},[r]),i.useEffect(()=>{if(!s)return;const u=U(B,"privateChats",s,"msg"),k=z(u,Z("ts","asc")),h=J(k,g=>{const N=[];g.forEach(y=>{const n=y.data();n.txt&&n.ts&&n.from?N.push(n):console.log("Missing fields in document:",y.id)}),console.log("Real-time Messages Update:",N),m(N)},g=>{console.error("Error fetching messages:",g)});return()=>h()},[s]),e.jsxs("div",{className:"chatContent",children:[r.map((u,k)=>{const h=w!=null&&w.id?u.from===w.id:!1;return u.type==="transaction"&&u.transactionData?e.jsx(Ls,{transaction:u.transactionData,own:h,timeStamp:u.ts.toMillis()},k):e.jsx(Ds,{text:u.txt,timeStamp:u.ts.toMillis(),from:u.from,own:h},k)}),e.jsx("div",{ref:x})," "]})}const ce=({chatName:s,onBack:t,showBackButton:c,showProfilePic:a=!1})=>{const{address:o}=R();return e.jsxs("div",{className:"chat-header",children:[e.jsxs("div",{className:"chat-header-left",children:[c&&e.jsx("button",{className:"back-button",onClick:t,title:"Go back",children:e.jsx(os,{size:24})}),e.jsx("div",{className:"chat-header-info",children:e.jsx("h2",{className:"chat-header-title",children:s})})]}),e.jsx("div",{className:"chat-header-right",children:(a||!c)&&o&&e.jsx("div",{className:"header-profile-pic",children:e.jsx(ee,{eth:o})})})]})},Fe=({onClose:s,onChatCreated:t})=>{const[c,a]=i.useState([]),[o,r]=i.useState(!0),[m,l]=i.useState(null),[w,x]=i.useState(null),{currentUser:f}=O();i.useEffect(()=>{(async()=>{try{r(!0);const g=U(B,"users"),y=(await W(g)).docs.map(d=>({id:d.id,name:d.data().name,wallet:d.data().wallet,chats:d.data().chats||[]})),n=f?y.filter(d=>d.id!==f.id):y;a(n)}catch(g){console.error("Error fetching users:",g),x("Failed to load users. Please try again.")}finally{r(!1)}})()},[f]);const u=async h=>{if(!f)return null;try{const g=U(B,"privateChats"),N=z(g),y=await W(N);for(const n of y.docs){const j=n.data().pid||[];if(j.includes(f.id)&&j.includes(h))return n.id}return null}catch(g){return console.error("Error checking existing chat:",g),null}},k=async h=>{if(!f){x("You must be logged in to create a chat");return}l(h.id),x(null);try{const g=await u(h.id);if(g){console.log("Chat already exists:",g),t&&t(g),s();return}const N=U(B,"privateChats"),y=await me(N,{pid:[f.id,h.id],createdAt:new Date,lastActivity:new Date});console.log("Created new chat with ID:",y.id);const n=de(B,"users",f.id),d=de(B,"users",h.id);await Promise.all([ve(n,{chats:Ne(y.id)}),ve(d,{chats:Ne(y.id)})]),console.log("Updated users' chat lists"),t&&t(y.id),s()}catch(g){console.error("Error creating chat:",g),x("Failed to create chat. Please try again.")}finally{l(null)}};return e.jsx("div",{className:"modalOverlay",children:e.jsxs("div",{className:"modalContent",children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"20px"},children:[e.jsx("h2",{children:"Start New Chat"}),e.jsx("button",{className:"closeButton",onClick:s,style:{background:"transparent",border:"none",color:"#fff",cursor:"pointer",padding:"5px"},children:e.jsx(fe,{size:20})})]}),w&&e.jsx("div",{style:{color:"#ff4444",marginBottom:"15px",padding:"10px",background:"rgba(255, 68, 68, 0.1)",borderRadius:"8px"},children:w}),o?e.jsx("div",{style:{textAlign:"center",padding:"20px"},children:e.jsx("p",{children:"Loading users..."})}):c.length===0?e.jsx("div",{style:{textAlign:"center",padding:"20px"},children:e.jsx("p",{children:"No other users found."})}):e.jsxs("div",{style:{maxHeight:"60vh",overflowY:"auto",scrollbarWidth:"thin",scrollbarColor:"rgba(255, 255, 255, 0.2) transparent",paddingRight:"8px"},className:"modal-scroll-area",children:[e.jsx("p",{style:{marginBottom:"15px",color:"#ccc"},children:"Select a user to start chatting:"}),e.jsx("div",{style:{display:"flex",flexDirection:"column",gap:"10px"},children:c.map(h=>e.jsxs("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between",padding:"12px",background:"rgba(255, 255, 255, 0.05)",borderRadius:"8px",border:"1px solid rgba(255, 255, 255, 0.1)"},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"12px"},children:[e.jsx(ee,{eth:h.wallet}),e.jsxs("div",{children:[e.jsx("h4",{style:{margin:0,fontSize:"16px"},children:h.name}),e.jsxs("p",{style:{margin:0,fontSize:"12px",color:"#ccc",fontFamily:"monospace"},children:[h.wallet.slice(0,6),"...",h.wallet.slice(-4)]})]})]}),e.jsx("button",{onClick:()=>k(h),disabled:m===h.id,style:{background:m===h.id?"#666":"#50b458",border:"none",borderRadius:"50%",width:"40px",height:"40px",display:"flex",alignItems:"center",justifyContent:"center",cursor:m===h.id?"not-allowed":"pointer",color:"#fff",transition:"all 0.2s ease"},onMouseEnter:g=>{m!==h.id&&(g.target.style.background="#5bc464",g.target.style.transform="scale(1.05)")},onMouseLeave:g=>{m!==h.id&&(g.target.style.background="#50b458",g.target.style.transform="scale(1)")},children:m===h.id?e.jsx("div",{style:{width:"16px",height:"16px",border:"2px solid #fff",borderTop:"2px solid transparent",borderRadius:"50%",animation:"spin 1s linear infinite"}}):e.jsx(cs,{size:18})})]},h.id))})]}),e.jsx("style",{children:`
          @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
          }
          
          .modal-scroll-area::-webkit-scrollbar {
            width: 6px;
          }
          
          .modal-scroll-area::-webkit-scrollbar-track {
            background: transparent;
          }
          
          .modal-scroll-area::-webkit-scrollbar-thumb {
            background-color: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
          }
        `})]})})},Me=({onClose:s,recipientUser:t,onTransactionSent:c})=>{const{address:a}=R(),{currentUser:o}=O(),r=xs(),m=js(),[l,w]=i.useState(""),[x,f]=i.useState((t==null?void 0:t.wallet)||""),[u,k]=i.useState(""),[h,g]=i.useState("form"),[N,y]=i.useState(null),[n,d]=i.useState(null),j=()=>is(x),P=()=>{try{const b=parseFloat(l);return b<=0||!C?!1:(F?parseFloat(F):b)<=parseFloat(C.formatted)}catch{return!1}},{data:C,isLoading:A,error:I,refetch:S}=bs({address:a,chainId:r,query:{retry:3,retryDelay:1e3}}),{data:T,isLoading:L}=ys({to:x,value:l?_(l):void 0,query:{enabled:j()&&!!l&&parseFloat(l)>0,retry:2}}),{data:p}=ws({chainId:r,query:{retry:2}}),v=T&&p?Ce(T*p):null,F=l&&v?(parseFloat(l)+parseFloat(v)).toString():null,{sendTransaction:D,data:E,error:H,isPending:se,reset:te}=vs(),{isLoading:xe,isSuccess:V,isError:Y,error:G}=Ns({hash:E,timeout:6e4,query:{enabled:!!E,retry:5,retryDelay:2e3}});i.useEffect(()=>{te(),g("form"),y(null),S&&S()},[te,S]),i.useEffect(()=>()=>{n&&clearTimeout(n)},[n]),i.useEffect(()=>{if(se){g("confirming"),y(null);const b=setTimeout(()=>{h==="confirming"&&(y("Transaction confirmation timed out. Please try again."),g("error"))},6e4);d(b)}},[se]),i.useEffect(()=>{E&&(n&&(clearTimeout(n),d(null)),!xe&&!V&&!Y&&g("pending"))},[E,xe,V,Y,n]),i.useEffect(()=>{if(V&&E){g("success");const b={hash:E,to:x,amount:l,chainId:r,timestamp:new Date,from:a,recipientName:(t==null?void 0:t.name)||"Unknown",senderName:(o==null?void 0:o.name)||"You",status:"confirmed",comment:u.trim()||void 0,gasUsed:T==null?void 0:T.toString(),gasFee:v||void 0};c&&c(b),setTimeout(()=>{s()},3e3)}},[V,E,x,l,r,a,t,o,c,s,u,T,v]),i.useEffect(()=>{if(H||Y){g("error");const b=(H==null?void 0:H.message)||(G==null?void 0:G.message)||"Transaction failed";b.includes("insufficient funds")?y("Insufficient funds for this transaction"):b.includes("user rejected")||b.includes("User denied")?y("Transaction was cancelled by user"):b.includes("gas")?y("Transaction failed due to gas issues"):b.includes("network")?y("Network error. Please check your connection and try again."):y("Transaction failed. Please try again."),n&&(clearTimeout(n),d(null))}},[H,Y,G,n]);const M=(b=>{switch(b){case 1:return{name:"Ethereum Mainnet",symbol:"ETH",color:"#627EEA",explorerUrl:"https://etherscan.io"};case 56:return{name:"BNB Smart Chain",symbol:"BNB",color:"#F3BA2F",explorerUrl:"https://bscscan.com"};case 137:return{name:"Polygon",symbol:"MATIC",color:"#8247E5",explorerUrl:"https://polygonscan.com"};case 42161:return{name:"Arbitrum One",symbol:"ETH",color:"#28A0F0",explorerUrl:"https://arbiscan.io"};case 10:return{name:"Optimism",symbol:"ETH",color:"#FF0420",explorerUrl:"https://optimistic.etherscan.io"};case 8453:return{name:"Base",symbol:"ETH",color:"#0052FF",explorerUrl:"https://basescan.org"};case 43114:return{name:"Avalanche C-Chain",symbol:"AVAX",color:"#E84142",explorerUrl:"https://snowtrace.io"};case 250:return{name:"Fantom Opera",symbol:"FTM",color:"#1969FF",explorerUrl:"https://ftmscan.com"};default:return{name:`Chain ${b}`,symbol:"ETH",color:"#666",explorerUrl:null}}})(r),je=()=>P()&&j()&&!se&&!A&&C,He=async()=>{if(je())try{y(null),console.log("Sending transaction:",{to:x,value:_(l),chainId:r}),D({to:x,value:_(l)})}catch(b){console.error("Transaction error:",b),y("Failed to initiate transaction"),g("error")}},Oe=["0.001","0.01","0.1"],Ve=b=>{w(b)},Ye=async()=>{if(!C||!a||!m)return;const b=parseFloat(C.formatted);try{const q=p;if(!q){alert("Unable to fetch gas price. Please try again in a moment.");return}const Ke=Math.min(1e-4,b*.01),_e=_(Ke.toString()),be=await m.estimateGas({account:a,to:x,value:_e}),ye=be*BigInt(150)/BigInt(100),Xe=ye*q,Je=Ce(Xe),ne=parseFloat(Je),ae=b-ne;if(ae<=0){alert(`Insufficient balance for transaction.

Balance: ${b} ${M.symbol}
Estimated gas fee (with buffer): ${ne.toFixed(8)} ${M.symbol}

You need more ${M.symbol} to cover gas fees.`);return}const re=Math.min(ae,b*.99),Ze=re<.01?8:6;w(re.toFixed(Ze)),console.log("Max calculation with MetaMask 1.5x approach:",{balance:b,gasEstimate:be.toString(),gasWithBuffer:ye.toString(),gasPrice:q.toString(),txFee:ne,maxSendable:ae,finalAmount:re})}catch(q){console.error("Error calculating max amount:",q),alert("Unable to calculate max amount. Please enter amount manually.")}},Ge=()=>{S&&S()},Q=()=>!E||!M.explorerUrl?null:`${M.explorerUrl}/tx/${E}`,K=()=>{h==="confirming"&&!window.confirm("Are you sure you want to close? The transaction request may still be pending in your wallet.")||h==="pending"&&!window.confirm("Transaction is being processed on the blockchain. Are you sure you want to close? You can check the status using the transaction hash.")||(n&&clearTimeout(n),s())},Qe=()=>{switch(h){case"form":return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"transaction-form",children:[t&&e.jsxs("div",{className:"recipient-info",children:[e.jsx(ee,{eth:t.wallet}),e.jsxs("div",{className:"recipient-details",children:[e.jsx("h4",{children:t.name}),e.jsxs("p",{className:"recipient-address",children:[t.wallet.slice(0,6),"...",t.wallet.slice(-4)]})]})]}),I&&e.jsxs("div",{className:"error-message",children:["Failed to load balance.",e.jsx("button",{onClick:Ge,style:{marginLeft:"10px",background:"#50b458",border:"none",color:"white",padding:"4px 8px",borderRadius:"4px",cursor:"pointer"},children:"Retry"})]}),e.jsxs("div",{className:"form-group",children:[e.jsxs("label",{children:["Amount (",M.symbol,")"]}),e.jsxs("div",{className:"amount-input-group",children:[e.jsx("input",{type:"number",value:l,onChange:b=>w(b.target.value),placeholder:"0.0",step:"0.0001",min:"0",max:(C==null?void 0:C.formatted)||"0",className:l&&!P()?"error":""}),e.jsxs("div",{className:"quick-amounts",children:[Oe.map(b=>e.jsx("button",{type:"button",className:"quick-amount-btn",onClick:()=>Ve(b),children:b},b)),e.jsx("button",{type:"button",className:"quick-amount-btn",onClick:Ye,disabled:!C,children:"Max"})]})]}),e.jsx("div",{className:"balance-info",children:A?e.jsx("span",{children:"Loading balance..."}):C?e.jsxs("span",{children:["Balance: ",parseFloat(C.formatted).toFixed(6)," ",C.symbol]}):e.jsx("span",{children:"Balance unavailable"})}),l&&!P()&&e.jsx("span",{className:"error-text",children:parseFloat(l)<=0?"Amount must be greater than 0":F&&parseFloat(F)>parseFloat((C==null?void 0:C.formatted)||"0")?"Insufficient balance (including gas fees)":"Insufficient balance"})]}),!t&&e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Recipient Address"}),e.jsx("input",{type:"text",value:x,onChange:b=>f(b.target.value),placeholder:"0x...",className:!j()&&x?"error":""}),x&&!j()&&e.jsx("span",{className:"error-text",children:"Invalid address"})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Comment (optional)"}),e.jsx("textarea",{value:u,onChange:b=>k(b.target.value),placeholder:"What's this transaction for?",maxLength:200,rows:3}),e.jsxs("div",{style:{fontSize:"12px",color:"#ccc",textAlign:"right",marginTop:"4px"},children:[u.length,"/200"]})]}),l&&parseFloat(l)>0&&e.jsxs("div",{className:"transaction-summary",children:[e.jsx("h4",{children:"Transaction Summary"}),e.jsxs("div",{className:"summary-row",children:[e.jsx("span",{children:"Amount to send:"}),e.jsxs("span",{children:[l," ",M.symbol]})]}),v&&e.jsxs("div",{className:"summary-row",children:[e.jsx("span",{children:"Estimated gas fee:"}),e.jsxs("span",{className:"gas-fee",children:[parseFloat(v).toFixed(6)," ",M.symbol]})]}),L&&e.jsxs("div",{className:"summary-row",children:[e.jsx("span",{children:"Estimating gas fee..."}),e.jsx("span",{className:"gas-loading",children:"⏳"})]}),F&&e.jsxs("div",{className:"summary-row total",children:[e.jsx("span",{children:e.jsx("strong",{children:"Total cost:"})}),e.jsx("span",{children:e.jsxs("strong",{children:[parseFloat(F).toFixed(6)," ",M.symbol]})})]}),l&&!P()&&F&&e.jsx("div",{className:"summary-warning",children:"⚠️ Insufficient balance for total cost including gas fees"})]}),e.jsx("div",{className:"network-info",children:e.jsxs("span",{children:["Sending on ",M.name]})})]}),e.jsxs("div",{className:"modal-footer",children:[e.jsx("button",{className:"cancel-btn",onClick:K,children:"Cancel"}),e.jsxs("button",{className:"send-btn",onClick:He,disabled:!je(),children:[e.jsx(he,{size:18}),"Send"]})]})]});case"confirming":return e.jsxs("div",{className:"transaction-status",children:[e.jsx("div",{className:"status-icon confirming",children:e.jsx("div",{className:"spinner"})}),e.jsx("h3",{children:"Confirm in Wallet"}),e.jsx("p",{children:"Please confirm the transaction in your wallet to continue."}),e.jsxs("p",{children:["Network: ",M.name]}),e.jsx("div",{className:"modal-footer",children:e.jsx("button",{className:"cancel-btn",onClick:K,children:"Cancel"})})]});case"pending":return e.jsxs("div",{className:"transaction-status",children:[e.jsx("div",{className:"status-icon pending",children:e.jsx("div",{className:"spinner"})}),e.jsx("h3",{children:"Transaction Pending"}),e.jsxs("p",{children:["Your transaction is being processed on ",M.name,"."]}),E&&e.jsxs("div",{className:"transaction-hash",children:[e.jsx("p",{children:"Transaction Hash:"}),e.jsxs("code",{children:[E.slice(0,10),"...",E.slice(-8)]})]}),Q()&&e.jsx("div",{className:"transaction-explorer",children:e.jsxs("a",{href:Q(),target:"_blank",rel:"noopener noreferrer",className:"explorer-link",children:["View on ",M.name," Explorer →"]})}),e.jsx("div",{className:"modal-footer",children:e.jsx("button",{className:"cancel-btn",onClick:K,children:"Close"})})]});case"success":return e.jsxs("div",{className:"transaction-status",children:[e.jsx("div",{className:"status-icon success",children:"✓"}),e.jsx("h3",{children:"Transaction Sent!"}),e.jsxs("p",{children:["Successfully sent ",l," ",M.symbol," to ",(t==null?void 0:t.name)||"recipient"]}),E&&e.jsxs("div",{className:"transaction-hash",children:[e.jsx("p",{children:"Transaction Hash:"}),e.jsxs("code",{children:[E.slice(0,10),"...",E.slice(-8)]})]}),Q()&&e.jsx("div",{className:"transaction-explorer",children:e.jsxs("a",{href:Q(),target:"_blank",rel:"noopener noreferrer",className:"explorer-link",children:["View on ",M.name," Explorer →"]})}),e.jsx("p",{className:"auto-close",children:"This window will close automatically..."})]});case"error":return e.jsxs("div",{className:"transaction-status",children:[e.jsx("div",{className:"status-icon error",children:"✕"}),e.jsx("h3",{children:"Transaction Failed"}),e.jsx("div",{className:"error-message",children:N}),e.jsxs("div",{className:"modal-footer",children:[e.jsx("button",{className:"cancel-btn",onClick:s,children:"Close"}),e.jsx("button",{className:"retry-btn",onClick:()=>{g("form"),y(null),te(),n&&(clearTimeout(n),d(null))},children:"Try Again"})]})]});default:return null}};return e.jsx("div",{className:"modalOverlay",children:e.jsxs("div",{className:"modalContent transaction-modal",children:[e.jsxs("div",{className:"modal-header",children:[e.jsxs("h2",{children:["Send ",M.symbol]}),(h==="form"||h==="error")&&e.jsx("button",{className:"closeButton",onClick:K,children:e.jsx(fe,{size:20})})]}),Qe()]})})},qe=()=>{const[s,t]=i.useState({width:typeof window<"u"?window.innerWidth:0,height:typeof window<"u"?window.innerHeight:0});i.useEffect(()=>{const r=()=>{t({width:window.innerWidth,height:window.innerHeight})};return window.addEventListener("resize",r),()=>window.removeEventListener("resize",r)},[]);const c=s.width<=768,a=s.width>768&&s.width<=1024,o=s.width>1024;return{isMobile:c,isTablet:a,isDesktop:o,windowSize:s}};function zs(){const{address:s}=R(),[t,c]=i.useState(null),[a,o]=i.useState([]),{setCurrentUser:r,currentUser:m}=O(),[l,w]=i.useState(!1),[x,f]=i.useState(!1),[u,k]=i.useState(null),[h,g]=i.useState(null),{isMobile:N}=qe(),[y,n]=i.useState("list");i.useEffect(()=>{(async()=>{try{const v=U(B,"users"),D=(await W(v)).docs.map(E=>({id:E.id,name:E.data().name,wallet:E.data().wallet}));o(D),console.log("Fetched users:",D)}catch(v){console.error("Error fetching users:",v)}})()},[]),i.useEffect(()=>{(async()=>{if(!t){g(null);return}try{const v=await ls(de(B,"privateChats",t));if(v.exists()){const F=v.data();g(F),console.log("Fetched chat data:",F)}else console.error("Chat document not found:",t),g(null)}catch(v){console.error("Error fetching chat data:",v),g(null)}})()},[t]),i.useEffect(()=>{if(a.length>0&&s){const p=a.find(v=>v.wallet===s);console.log("Current User:",p),r(p)}},[a,s,r]);const d=p=>{c(p),N&&n("chat")},j=()=>{N&&(n("list"),c(null))},P=p=>{console.log("New chat created with ID:",p),c(p),N&&n("chat")},C=p=>{const v=a.find(F=>F.id===p);return v?v.wallet:""},A=()=>{const p=I();return p?p.name:"Chat"},I=()=>{if(console.log("Getting recipient user..."),console.log("Selected chat ID:",t),console.log("Current chat data:",h),console.log("Current address:",s),console.log("Available users:",a),!t||!h||!s||a.length===0)return console.log("Missing required data for recipient detection"),null;const p=a.find(D=>D.wallet===s);if(!p)return console.log("Current user not found in users list"),null;console.log("Current user found:",p);const v=h.pid.find(D=>D!==p.id);if(!v)return console.log("Other participant ID not found in chat data"),null;console.log("Other participant ID:",v);const F=a.find(D=>D.id===v);return console.log("Recipient user found:",F),F||null},S=p=>{if(console.log("Handle send transaction called with:",p),!p||!p.wallet||!p.name){console.error("Invalid recipient user:",p);return}k(v=>(console.log("Setting recipient from",v,"to",p),p)),f(v=>(console.log("Setting modal visibility from",v,"to true"),!0))},T=async p=>{if(console.log("Transaction sent:",p),f(!1),k(null),t&&m)try{await Ps(p,t,m.id),console.log("Transaction message added to chat")}catch(v){console.error("Failed to add transaction message to chat:",v)}else console.error("Missing chat ID or current user for transaction message")},L=()=>{f(!1),k(null)};return i.useEffect(()=>{const p=I();console.log("Recipient user updated:",p)},[t,h,a,s]),N?e.jsxs("div",{className:"chat mobile-chat",children:[y==="list"?e.jsxs("div",{className:"mobile-chat-list",children:[e.jsx(ce,{chatName:"Chats",onBack:j,showBackButton:!1,showProfilePic:!0}),e.jsx("div",{className:"mobile-chat-selector",children:e.jsx(Ee,{setSelectedChatId:d,users:a,getWalletById:C,selectedChatId:t})}),e.jsx("button",{className:"createChatButton mobile-create-chat",onClick:()=>w(!0),title:"Start new chat",children:e.jsx(Se,{size:28})})]}):e.jsxs("div",{className:"mobile-chat-window",children:[e.jsx(ce,{chatName:A(),onBack:j,showBackButton:!0}),t&&e.jsx(ke,{selectedChatId:t,onSendTransaction:S,recipientUser:I(),children:e.jsx(Te,{selectedChatId:t,users:a,getWalletById:C,onSendTransaction:S,recipientUser:I()})})]}),l&&e.jsx(Fe,{onClose:()=>w(!1),onChatCreated:P}),x&&u&&e.jsx(Me,{onClose:L,recipientUser:u,onTransactionSent:T})]}):e.jsxs("div",{className:"chat desktop-chat",children:[e.jsx(Ee,{setSelectedChatId:d,users:a,getWalletById:C,selectedChatId:t}),e.jsx("div",{className:"desktop-chat-area",children:t?e.jsxs(e.Fragment,{children:[e.jsx(ce,{chatName:A(),onBack:j,showBackButton:!1}),e.jsx(ke,{selectedChatId:t,onSendTransaction:S,recipientUser:I(),children:e.jsx(Te,{selectedChatId:t,users:a,getWalletById:C,onSendTransaction:S,recipientUser:I()})})]}):e.jsxs("div",{className:"desktop-chat-placeholder",children:[e.jsx("h2",{children:"Select a chat to start messaging"}),e.jsx("p",{children:"Choose a conversation from the sidebar or create a new one"})]})}),e.jsx("button",{className:"createChatButton desktop-create-chat",onClick:()=>w(!0),title:"Start new chat",children:e.jsx(Se,{size:24})}),l&&e.jsx(Fe,{onClose:()=>w(!1),onChatCreated:P}),x&&u&&e.jsx(Me,{onClose:L,recipientUser:u,onTransactionSent:T})]})}function Ws(){const{address:s}=R(),[t,c]=i.useState(null),a=ge(),o=async r=>{const m=U(B,"users"),l=z(m,X("wallet","==",r));try{const x=!(await W(l)).empty;console.log("User found:",x),c(x),a(x?"/chat":"/signup")}catch(w){console.error("Error checking user:",w),c(!1),a("/signup")}};return e.jsxs("div",{children:[e.jsxs("button",{className:"proceedButton",onClick:()=>{s?o(s):console.error("Address is undefined")},children:[e.jsx(ds,{size:28}),e.jsx("span",{children:"Proceed"})]}),t!==null&&e.jsx("p",{children:t?"User exists":"User does not exist"})]})}function qs(){const{address:s,isConnected:t}=R(),{disconnect:c}=De(),a=async()=>{localStorage.removeItem("walletconnect"),localStorage.removeItem("walletConnected"),localStorage.removeItem("connectorId"),c()};return e.jsx("div",{className:"wallet-button",children:t&&s?e.jsxs("div",{className:"walletBubble",children:[e.jsxs("div",{className:"address",children:[s.slice(0,6),"...",s.slice(-4)]}),e.jsx("button",{onClick:a,children:e.jsx(fe,{size:25})})]}):e.jsx("w3m-connect-button",{})})}function $s(){const{address:s,isConnected:t,connector:c}=R(),{connect:a,connectors:o}=Cs();De();const[r,m]=i.useState(t);ge();const{isMobile:l}=qe();return i.useEffect(()=>{if(localStorage.getItem("walletConnected")==="true"&&!t){console.log("Attempting to reconnect wallet automatically...");const x=localStorage.getItem("connectorId");if(console.log("Last used connector:",x),x){const f=o.find(u=>u.id===x);f&&(console.log("Reconnecting with saved connector:",x),a({connector:f}))}else{const f=o.find(u=>u.id==="injected");f&&(console.log("No saved connector, trying injected..."),a({connector:f}))}}},[a,o,t]),i.useEffect(()=>{console.log("Connection state changed:",t?"connected":"disconnected"),console.log("Current connector:",c==null?void 0:c.id),m(t),t&&!r&&console.log("Wallet newly connected:",s),!t&&r&&console.log("Wallet disconnected")},[t,s,r,c]),i.useEffect(()=>{const w=()=>{r&&!t&&(console.log("Connection lost while page was inactive, updating UI"),m(!1))};return window.addEventListener("focus",w),()=>{window.removeEventListener("focus",w)}},[r,t]),e.jsxs("div",{className:`homepage ${l?"mobile-homepage":"desktop-homepage"}`,children:[e.jsxs("div",{className:"title",children:[e.jsx("h1",{children:"Chat 3.0 is here."}),e.jsx("h2",{children:"Your personal web3 companion."})]}),e.jsx("div",{children:e.jsxs("div",{className:"login",children:[e.jsx("h3",{children:r?`Connected ${c!=null&&c.id?`(${c.id})`:""}`:"Connect your wallet"}),e.jsx(qs,{}),r&&e.jsx(Ws,{})]})})]})}function Hs(){const{address:s}=R(),t=ge(),[c,a]=i.useState(""),[o,r]=i.useState(null),[m,l]=i.useState(!1),[w,x]=i.useState(!1),[f,u]=i.useState(!0);i.useEffect(()=>{(async()=>{if(s){u(!0);try{const y=U(B,"users"),n=z(y,X("wallet","==",s)),j=!(await W(n)).empty;x(j),j&&(console.log("User already exists, redirecting to chat"),t("/chat"))}catch(y){console.error("Error checking if user exists:",y)}finally{u(!1)}}})()},[s,t]);const k=async()=>{const N=U(B,"users"),y=z(N,Z("name"),le(10)),d=(await W(y)).docs.map(j=>({id:j.id,...j.data()}));r({users:d}),console.log("Fetched data:",d)};i.useEffect(()=>{k()},[]);const h=async()=>{if(!s||!c.trim()){console.error("Missing required data: address or name");return}if(w){console.log("User already exists, cannot register again");return}l(!0),console.log("Writing data:",s,c);try{const N=U(B,"users"),y=z(N,X("wallet","==",s));if(!(await W(y)).empty){console.log("User already exists, cannot register"),x(!0),l(!1),t("/chat");return}const d=J(z(N,X("wallet","==",s)),j=>{j.empty||(console.log("User successfully registered, redirecting to chat"),d(),t("/chat"))},j=>{console.error("Error in onSnapshot listener:",j),l(!1)});await me(N,{wallet:s,name:c.trim()}),console.log("Data written successfully"),setTimeout(()=>{d(),m&&(l(!1),console.log("Registration timeout, stopped listening"))},1e4)}catch(N){console.error("Error writing data:",N),l(!1)}},g=N=>{N.key==="Enter"&&!m&&!w&&c.trim()&&h()};return f?e.jsx("div",{className:"centered-signup",children:e.jsxs("div",{className:"welcomeText",children:[e.jsx("h1",{children:"Checking registration status..."}),e.jsx("h2",{children:"Please wait"})]})}):w?e.jsxs("div",{className:"centered-signup",children:[e.jsxs("div",{className:"welcomeText",children:[e.jsx("h1",{children:"Already Registered"}),e.jsx("h2",{children:"You're already signed up! Redirecting to chat..."})]}),e.jsxs("p",{children:["Wallet Address: ",s]})]}):e.jsxs("div",{className:"centered-signup",children:[e.jsxs("div",{className:"welcomeText",children:[e.jsx("h1",{children:"Welcome to Chat 3.0"}),e.jsx("h2",{children:"One last step to start chatting"})]}),e.jsxs("p",{children:["Wallet Address: ",s]}),e.jsxs("div",{className:"signupBox",children:[e.jsx("input",{type:"text",placeholder:"Enter name",value:c,onChange:N=>a(N.target.value),onKeyPress:g,disabled:m,maxLength:50}),e.jsx("button",{onClick:h,disabled:m||!c.trim(),children:m?"Registering...":"Register"})]}),m&&e.jsx("p",{style:{color:"#50b458",marginTop:"10px"},children:"Creating your account, please wait..."})]})}const Os=new us,ue="02ee764d5cc25cff6387d6d3f7943fd6",ie={name:"TokenChat",description:"Web3 Chat Application",url:"https://c4ctus96.github.io/tokenchat",icons:["https://avatars.githubusercontent.com/u/37784886"]},Vs=[pe,Re,Pe,Ue,Ae,Ie],$e=Ss({chains:Vs,transports:{[pe.id]:$("https://ethereum-rpc.publicnode.com"),[Re.id]:$("https://bsc-dataseed1.defibit.io"),[Pe.id]:$("https://polygon-rpc.com"),[Ue.id]:$("https://arbitrum-one-rpc.publicnode.com"),[Ae.id]:$("https://optimism-rpc.publicnode.com"),[Ie.id]:$("https://base-rpc.publicnode.com")},connectors:[Es({projectId:ue,metadata:ie,showQrModal:!1}),ks({shimDisconnect:!0}),Ts({appName:ie.name,appLogoUrl:ie.icons[0]}),Fs({options:{projectId:ue},socials:["google","x","github","discord","apple"],showWallets:!0,email:!0,walletFeatures:!1})]});Ms({wagmiConfig:$e,projectId:ue,defaultChain:pe,themeMode:"dark",enableAnalytics:!0,enableOnramp:!1,themeVariables:{"--w3m-accent":"#50b458","--w3m-color-mix":"#210059","--w3m-color-mix-strength":30}});function Ys({children:s}){const{isConnected:t}=R();return t?e.jsx(e.Fragment,{children:s}):e.jsx(gs,{to:"/"})}function Gs(){const{isConnected:s}=R();return i.useEffect(()=>{console.log("App initialized, connection status:",s),typeof window.ethereum>"u"&&console.log("MetaMask not detected, but WalletConnect can still be used")},[s]),null}function Qs(){return e.jsx(Bs,{config:$e,children:e.jsx(hs,{client:Os,children:e.jsx(As,{children:e.jsxs(ms,{basename:"/tokenchat",children:[e.jsx(Gs,{}),e.jsxs(fs,{children:[e.jsx(oe,{path:"/",element:e.jsx($s,{})}),e.jsx(oe,{path:"/chat",element:e.jsx(Ys,{children:e.jsx(zs,{})})}),e.jsx(oe,{path:"/signup",element:e.jsx(Hs,{})})]})]})})})})}const Ks=document.getElementById("root"),_s=ps(Ks);_s.render(e.jsx(Be.StrictMode,{children:e.jsx(Qs,{})}));
//# sourceMappingURL=index-C4LoIcbt.js.map
