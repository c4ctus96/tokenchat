import{aK as qe,aL as He,aM as $e,aN as e,aF as l,aO as A,aP as G,aQ as z,aR as ae,aS as _,aT as W,aU as Ne,aV as Oe,aW as ce,aX as ie,aY as fe,aZ as Ve,a_ as Qe,a$ as Ye,b0 as le,b1 as Ke,b2 as re,b3 as pe,b4 as ge,b5 as ee,b6 as Ge,b7 as _e,b8 as xe,b9 as Xe,ba as de,bb as Je,bc as K,bd as Ze,be as Ce,bf as q,bg as Se,bh as ke,bi as Ee,bj as Te,aD as ue,bk as es,bl as ss,bm as ts,bn as se,bo as ns,bp as as}from"./react-BslxCsWc.js";import{u as R,a as rs,b as os,c as cs,d as is,e as ls,f as ds,g as Fe,h as us,i as hs,w as ms,j as fs,k as ps,l as gs,m as xs,W as js}from"./web3-C1TNVDmO.js";import"./walletconnect-C7PARPXg.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))n(o);new MutationObserver(o=>{for(const r of o)if(r.type==="childList")for(const a of r.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&n(a)}).observe(document,{childList:!0,subtree:!0});function i(o){const r={};return o.integrity&&(r.integrity=o.integrity),o.referrerPolicy&&(r.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?r.credentials="include":o.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function n(o){if(o.ep)return;o.ep=!0;const r=i(o);fetch(o.href,r)}})();const bs={apiKey:"AIzaSyBRDBbrJbmLwb3YTI_YBmMdTjLEd8KjS2E",authDomain:"tokenchat-b8673.firebaseapp.com",projectId:"tokenchat-b8673",storageBucket:"tokenchat-b8673.appspot.com",messagingSenderId:"593980787293",appId:"1:593980787293:web:7c58ff7656a3fa31b19bb4",measurementId:"G-RB9WJLVQC0"},Me=qe(bs);He(Me);const M=$e(Me),X=({eth:s})=>e.jsx("div",{children:e.jsx("img",{src:`https://effigy.im/a/${s}.svg`,alt:"Profile picture",className:"profilePic"})});function je({setSelectedChatId:s,users:t,getWalletById:i,selectedChatId:n}){const{address:o}=R(),[r,a]=l.useState([]),[N,f]=l.useState(null);l.useEffect(()=>{if(!o)return;const c=A(M,"privateChats"),u=G(c,async j=>{var k;try{const F=[];for(const B of j.docs){const T=B.data(),C={id:B.id,pid:T.pid||[]};try{const U=A(M,"privateChats",B.id,"msg"),D=z(U,_("ts","desc"),ae(1)),m=await W(D);if(m.empty)C.lastMessage="No messages yet",C.lastMessageTime=new Date(0);else{const y=m.docs[0].data();C.lastMessage=y.txt||"",C.lastMessageTime=((k=y.ts)==null?void 0:k.toDate())||new Date}}catch(U){console.error(`Error fetching messages for chat ${B.id}:`,U),C.lastMessage="Failed to load",C.lastMessageTime=new Date(0)}F.push(C)}F.sort((B,T)=>{var D,m;const C=((D=B.lastMessageTime)==null?void 0:D.getTime())||0;return(((m=T.lastMessageTime)==null?void 0:m.getTime())||0)-C}),console.log("Real-time chatrooms update:",F),a(F),f(null)}catch(F){f("Failed to fetch chat data. Please check your internet connection."),console.error("Snapshot error:",F)}},j=>{f("Failed to fetch data. Please check your internet connection."),console.error("Fetch error:",j)});return()=>u()},[o]),l.useEffect(()=>{(async()=>{if("Notification"in window&&Notification.permission==="default"){const u=await Notification.requestPermission();console.log("Notification permission:",u)}})()},[]),l.useEffect(()=>{if(!o||r.length===0)return;const c=t.find(j=>j.wallet===o);if(!c)return;const u=[];return r.forEach(j=>{if(j.pid.includes(c.id)){const k=A(M,"privateChats",j.id,"msg"),F=z(k,_("ts","desc"),ae(1)),B=G(F,T=>{if(!T.empty&&j.id!==n){const C=T.docs[0].data();if(C.from!==c.id){const U=E(C.from);v(U,C.txt)}}});u.push(B)}}),()=>{u.forEach(j=>j())}},[r,o,t,n]);const v=(c,u)=>{if("Notification"in window&&Notification.permission==="granted"){const j=u.length>50?u.substring(0,50)+"...":u;new Notification(`New message from ${c}`,{body:j,icon:"/favicon.ico",badge:"/favicon.ico",tag:"new-message"})}},h=t.find(c=>c.wallet===o),p=h?r.filter(c=>c.pid.includes(h.id)):[],E=c=>{const u=t.find(j=>j.id===c);return u?u.name:c},d=c=>h&&c.find(u=>u!==h.id)||"",b=c=>{const u=d(c);return E(u)},g=(c,u=40)=>c.length<=u?c:c.substring(0,u)+"...",x=c=>{s(c)};return e.jsxs("div",{className:"chatSelector",children:[N&&e.jsx("p",{className:"error",children:N}),p.length>0?p.map(c=>e.jsxs("div",{className:"contactBox",onClick:()=>x(c.id),style:{backgroundColor:c.id===n?"#003344":"#002233",cursor:"pointer"},children:[e.jsx(X,{eth:i(d(c.pid))}),e.jsxs("div",{className:"contactTextBox",children:[e.jsx("h3",{style:{fontSize:"16px",fontWeight:"bold"},children:b(c.pid)}),e.jsx("p",{style:{margin:0,fontSize:"14px",color:"#ccc",opacity:.8,lineHeight:"1.2"},children:g(c.lastMessage||"No messages yet")})]})]},c.id)):e.jsxs("div",{style:{padding:"20px",textAlign:"center",color:"#ccc"},children:[e.jsx("p",{children:"No chats yet"}),e.jsx("p",{style:{fontSize:"14px",marginTop:"10px"},children:"Click the + button to start a new conversation"})]})]})}const Ie=l.createContext(void 0),ys=({children:s})=>{const[t,i]=l.useState(void 0);return e.jsx(Ie.Provider,{value:{currentUser:t,setCurrentUser:i},children:s})},H=()=>{const s=l.useContext(Ie);if(!s)throw new Error("useUser must be used within a UserProvider");return s},Be=async(s,t,i,n="text",o)=>{try{const r=A(M,"privateChats",i,"msg"),a={txt:s,from:t,ts:new Date,type:n};n==="transaction"&&o&&(a.transactionData=o),await ie(r,a),console.log("Message sent successfully")}catch(r){throw console.error("Error sending message:",r),r}},ws=({selectedChatId:s,onSendTransaction:t,recipientUser:i})=>{const[n,o]=Ne.useState(""),{currentUser:r}=H(),a=h=>{o(h.target.value)},N=async()=>{if(!s||!r||!n.trim()){console.error("Missing required data:",{selectedChatId:s,currentUser:r,inputValue:n});return}try{await Be(n.trim(),r.id,s),o("")}catch(h){console.error("Failed to send message:",h)}},f=()=>{if(!i||!t){console.error("Missing recipient data for transaction");return}t(i)},v=h=>{h.key==="Enter"&&!h.shiftKey&&(h.preventDefault(),N())};return e.jsxs("div",{className:"chatBottomBar",children:[e.jsx("input",{type:"text",className:"messageInput",placeholder:"Type your message...",value:n,onChange:a,onKeyDown:v}),e.jsx("button",{className:"transactionButton",onClick:f,disabled:!s||!r||!i,title:"Send crypto",children:e.jsx(Oe,{size:20})}),e.jsx("button",{className:"sendMessageButton",onClick:N,disabled:!s||!r||!n.trim(),title:"Send message",children:e.jsx(ce,{size:20})})]})},vs=async(s,t,i)=>{try{let n=`Sent ${s.amount} ${Ns(s.chainId)} to ${s.recipientName}`;s.comment&&(n+=` - ${s.comment}`),await Be(n,i,t,"transaction",s),console.log("Transaction message sent to chat")}catch(n){throw console.error("Failed to send transaction message:",n),n}},Ns=s=>{switch(s){case 1:return"ETH";case 56:return"BNB";case 137:return"MATIC";case 42161:return"ETH";case 10:return"ETH";case 8453:return"ETH";case 43114:return"AVAX";case 250:return"FTM";default:return"ETH"}};function be({children:s,selectedChatId:t,onSendTransaction:i,recipientUser:n}){return e.jsxs("div",{className:"chatWindow",children:[e.jsx("div",{className:"chatContent",children:s}),e.jsx(ws,{selectedChatId:t,onSendTransaction:i,recipientUser:n||void 0})]})}const Cs=({text:s,timeStamp:t,from:i,own:n})=>e.jsx("div",{className:"messageBox",children:e.jsxs("div",{className:`message ${n?"own":""}`,children:[e.jsx("p",{className:"message-text",children:s}),e.jsx("p",{className:"message-timestamp",children:new Date(t).toLocaleString()})]})}),Ss=({transaction:s,own:t,timeStamp:i})=>{const o=(h=>{switch(h){case 1:return{name:"Ethereum",symbol:"ETH",color:"#627EEA",explorerUrl:"https://etherscan.io"};case 56:return{name:"BSC",symbol:"BNB",color:"#F3BA2F",explorerUrl:"https://bscscan.com"};case 137:return{name:"Polygon",symbol:"MATIC",color:"#8247E5",explorerUrl:"https://polygonscan.com"};case 42161:return{name:"Arbitrum",symbol:"ETH",color:"#28A0F0",explorerUrl:"https://arbiscan.io"};case 10:return{name:"Optimism",symbol:"ETH",color:"#FF0420",explorerUrl:"https://optimistic.etherscan.io"};case 8453:return{name:"Base",symbol:"ETH",color:"#0052FF",explorerUrl:"https://basescan.org"};case 43114:return{name:"Avalanche",symbol:"AVAX",color:"#E84142",explorerUrl:"https://snowtrace.io"};case 250:return{name:"Fantom",symbol:"FTM",color:"#1969FF",explorerUrl:"https://ftmscan.com"};default:return{name:"Unknown",symbol:"ETH",color:"#666",explorerUrl:null}}})(s.chainId),a=(()=>{switch(s.status){case"pending":return{icon:e.jsx(fe,{size:16}),text:"Pending",className:"pending"};case"confirmed":return{icon:e.jsx(Qe,{size:16}),text:"Confirmed",className:"confirmed"};case"failed":return{icon:e.jsx(Ve,{size:16}),text:"Failed",className:"failed"};default:return{icon:e.jsx(fe,{size:16}),text:"Unknown",className:"unknown"}}})(),N=h=>{const p=parseFloat(h);return p<1e-4?p.toExponential(2):p<1?p.toFixed(6):p<1e3?p.toFixed(4):p.toFixed(2)},v=o.explorerUrl?`${o.explorerUrl}/tx/${s.hash}`:null;return e.jsx("div",{className:"messageBox",children:e.jsxs("div",{className:`message transaction-message ${t?"own":""}`,children:[e.jsxs("div",{className:"transaction-header",children:[e.jsx("div",{className:"transaction-icon",children:e.jsx(ce,{size:20})}),e.jsx("div",{className:"transaction-title",children:e.jsx("span",{children:t?`Sent to ${s.recipientName}`:`Received from ${s.senderName}`})}),e.jsxs("div",{className:`transaction-status ${a.className}`,children:[a.icon,e.jsx("span",{children:a.text})]})]}),e.jsxs("div",{className:"transaction-amount",children:[e.jsxs("span",{className:"amount",children:[t?"-":"+",N(s.amount)]}),e.jsx("span",{className:"currency",children:o.symbol})]}),s.comment&&s.comment.trim()&&e.jsxs("div",{className:"transaction-comment",children:[e.jsx("div",{className:"comment-label",children:"Comment:"}),s.comment]}),e.jsx("div",{className:"transaction-network",children:e.jsx("div",{className:"network-badge",style:{backgroundColor:o.color},children:o.name})}),e.jsxs("div",{className:"transaction-details",children:[e.jsxs("div",{className:"detail-row",children:[e.jsx("span",{className:"label",children:"Hash:"}),e.jsxs("span",{className:"value hash",children:[s.hash.slice(0,8),"...",s.hash.slice(-6)]})]}),s.gasFee&&parseFloat(s.gasFee)>0&&e.jsxs("div",{className:"detail-row",children:[e.jsx("span",{className:"label",children:"Gas Fee:"}),e.jsxs("span",{className:"value",children:[parseFloat(s.gasFee).toFixed(6)," ",o.symbol]})]}),v&&e.jsx("div",{className:"transaction-explorer",children:e.jsx("a",{href:v,target:"_blank",rel:"noopener noreferrer",className:"explorer-link",children:"View on Explorer →"})})]}),e.jsx("div",{className:"message-timestamp",children:new Date(i).toLocaleString()})]})})};function ye({selectedChatId:s,users:t,getWalletById:i,onSendTransaction:n,recipientUser:o}){const[r,a]=l.useState([]),{address:N}=R(),{currentUser:f}=H(),v=l.useRef(null),h=()=>{var p;(p=v.current)==null||p.scrollIntoView({behavior:"smooth"})};return l.useEffect(()=>{h()},[r]),l.useEffect(()=>{if(!s)return;const p=A(M,"privateChats",s,"msg"),E=z(p,_("ts","asc")),d=G(E,b=>{const g=[];b.forEach(x=>{const c=x.data();c.txt&&c.ts&&c.from?g.push(c):console.log("Missing fields in document:",x.id)}),console.log("Real-time Messages Update:",g),a(g)},b=>{console.error("Error fetching messages:",b)});return()=>d()},[s]),e.jsxs("div",{className:"chatContent",children:[r.map((p,E)=>{const d=f!=null&&f.id?p.from===f.id:!1;return p.type==="transaction"&&p.transactionData?e.jsx(Ss,{transaction:p.transactionData,own:d,timeStamp:p.ts.toMillis()},E):e.jsx(Cs,{text:p.txt,timeStamp:p.ts.toMillis(),from:p.from,own:d},E)}),e.jsx("div",{ref:v})," "]})}const te=({chatName:s,onBack:t,showBackButton:i,showProfilePic:n=!1})=>{const{address:o}=R();return e.jsxs("div",{className:"chat-header",children:[e.jsxs("div",{className:"chat-header-left",children:[i&&e.jsx("button",{className:"back-button",onClick:t,title:"Go back",children:e.jsx(Ye,{size:24})}),e.jsx("div",{className:"chat-header-info",children:e.jsx("h2",{className:"chat-header-title",children:s})})]}),e.jsx("div",{className:"chat-header-right",children:(n||!i)&&o&&e.jsx("div",{className:"header-profile-pic",children:e.jsx(X,{eth:o})})})]})},we=({onClose:s,onChatCreated:t})=>{const[i,n]=l.useState([]),[o,r]=l.useState(!0),[a,N]=l.useState(null),[f,v]=l.useState(null),{currentUser:h}=H();l.useEffect(()=>{(async()=>{try{r(!0);const b=A(M,"users"),x=(await W(b)).docs.map(u=>({id:u.id,name:u.data().name,wallet:u.data().wallet,chats:u.data().chats||[]})),c=h?x.filter(u=>u.id!==h.id):x;n(c)}catch(b){console.error("Error fetching users:",b),v("Failed to load users. Please try again.")}finally{r(!1)}})()},[h]);const p=async d=>{if(!h)return null;try{const b=A(M,"privateChats"),g=z(b),x=await W(g);for(const c of x.docs){const j=c.data().pid||[];if(j.includes(h.id)&&j.includes(d))return c.id}return null}catch(b){return console.error("Error checking existing chat:",b),null}},E=async d=>{if(!h){v("You must be logged in to create a chat");return}N(d.id),v(null);try{const b=await p(d.id);if(b){console.log("Chat already exists:",b),t&&t(b),s();return}const g=A(M,"privateChats"),x=await ie(g,{pid:[h.id,d.id],createdAt:new Date,lastActivity:new Date});console.log("Created new chat with ID:",x.id);const c=re(M,"users",h.id),u=re(M,"users",d.id);await Promise.all([pe(c,{chats:ge(x.id)}),pe(u,{chats:ge(x.id)})]),console.log("Updated users' chat lists"),t&&t(x.id),s()}catch(b){console.error("Error creating chat:",b),v("Failed to create chat. Please try again.")}finally{N(null)}};return e.jsx("div",{className:"modalOverlay",children:e.jsxs("div",{className:"modalContent",children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"20px"},children:[e.jsx("h2",{children:"Start New Chat"}),e.jsx("button",{className:"closeButton",onClick:s,style:{background:"transparent",border:"none",color:"#fff",cursor:"pointer",padding:"5px"},children:e.jsx(le,{size:20})})]}),f&&e.jsx("div",{style:{color:"#ff4444",marginBottom:"15px",padding:"10px",background:"rgba(255, 68, 68, 0.1)",borderRadius:"8px"},children:f}),o?e.jsx("div",{style:{textAlign:"center",padding:"20px"},children:e.jsx("p",{children:"Loading users..."})}):i.length===0?e.jsx("div",{style:{textAlign:"center",padding:"20px"},children:e.jsx("p",{children:"No other users found."})}):e.jsxs("div",{style:{maxHeight:"60vh",overflowY:"auto",scrollbarWidth:"thin",scrollbarColor:"rgba(255, 255, 255, 0.2) transparent",paddingRight:"8px"},className:"modal-scroll-area",children:[e.jsx("p",{style:{marginBottom:"15px",color:"#ccc"},children:"Select a user to start chatting:"}),e.jsx("div",{style:{display:"flex",flexDirection:"column",gap:"10px"},children:i.map(d=>e.jsxs("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between",padding:"12px",background:"rgba(255, 255, 255, 0.05)",borderRadius:"8px",border:"1px solid rgba(255, 255, 255, 0.1)"},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"12px"},children:[e.jsx(X,{eth:d.wallet}),e.jsxs("div",{children:[e.jsx("h4",{style:{margin:0,fontSize:"16px"},children:d.name}),e.jsxs("p",{style:{margin:0,fontSize:"12px",color:"#ccc",fontFamily:"monospace"},children:[d.wallet.slice(0,6),"...",d.wallet.slice(-4)]})]})]}),e.jsx("button",{onClick:()=>E(d),disabled:a===d.id,style:{background:a===d.id?"#666":"#50b458",border:"none",borderRadius:"50%",width:"40px",height:"40px",display:"flex",alignItems:"center",justifyContent:"center",cursor:a===d.id?"not-allowed":"pointer",color:"#fff",transition:"all 0.2s ease"},onMouseEnter:b=>{a!==d.id&&(b.target.style.background="#5bc464",b.target.style.transform="scale(1.05)")},onMouseLeave:b=>{a!==d.id&&(b.target.style.background="#50b458",b.target.style.transform="scale(1)")},children:a===d.id?e.jsx("div",{style:{width:"16px",height:"16px",border:"2px solid #fff",borderTop:"2px solid transparent",borderRadius:"50%",animation:"spin 1s linear infinite"}}):e.jsx(Ke,{size:18})})]},d.id))})]}),e.jsx("style",{children:`
          @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
          }
          
          .modal-scroll-area::-webkit-scrollbar {
            width: 6px;
          }
          
          .modal-scroll-area::-webkit-scrollbar-track {
            background: transparent;
          }
          
          .modal-scroll-area::-webkit-scrollbar-thumb {
            background-color: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
          }
        `})]})})},ve=({onClose:s,recipientUser:t,onTransactionSent:i})=>{const{address:n}=R(),{currentUser:o}=H(),r=rs(),[a,N]=l.useState(""),[f,v]=l.useState((t==null?void 0:t.wallet)||""),[h,p]=l.useState(""),[E,d]=l.useState("form"),[b,g]=l.useState(null),[x,c]=l.useState(null),u=()=>_e(f),j=()=>{try{const w=parseFloat(a);return w<=0||!k?!1:(y?parseFloat(y):w)<=parseFloat(k.formatted)}catch{return!1}},{data:k,isLoading:F,error:B,refetch:T}=os({address:n,chainId:r,query:{retry:3,retryDelay:1e3}}),{data:C,isLoading:U}=cs({to:f,value:a?ee(a):void 0,query:{enabled:u()&&!!a&&parseFloat(a)>0,retry:2}}),{data:D}=is({chainId:r,query:{retry:2}}),m=C&&D?Ge(C*D):null,y=a&&m?(parseFloat(a)+parseFloat(m)).toString():null,{sendTransaction:P,data:S,error:L,isPending:J,reset:Z}=ls(),{isLoading:he,isSuccess:$,isError:O,error:V}=ds({hash:S,timeout:6e4,query:{enabled:!!S,retry:5,retryDelay:2e3}});l.useEffect(()=>{Z(),d("form"),g(null),T&&T()},[Z,T]),l.useEffect(()=>()=>{x&&clearTimeout(x)},[x]),l.useEffect(()=>{if(J){d("confirming"),g(null);const w=setTimeout(()=>{E==="confirming"&&(g("Transaction confirmation timed out. Please try again."),d("error"))},6e4);c(w)}},[J]),l.useEffect(()=>{S&&(x&&(clearTimeout(x),c(null)),!he&&!$&&!O&&d("pending"))},[S,he,$,O,x]),l.useEffect(()=>{if($&&S){d("success");const w={hash:S,to:f,amount:a,chainId:r,timestamp:new Date,from:n,recipientName:(t==null?void 0:t.name)||"Unknown",senderName:(o==null?void 0:o.name)||"You",status:"confirmed",comment:h.trim()||void 0,gasUsed:C==null?void 0:C.toString(),gasFee:m||void 0};i&&i(w),setTimeout(()=>{s()},3e3)}},[$,S,f,a,r,n,t,o,i,s,h,C,m]),l.useEffect(()=>{if(L||O){d("error");const w=(L==null?void 0:L.message)||(V==null?void 0:V.message)||"Transaction failed";w.includes("insufficient funds")?g("Insufficient funds for this transaction"):w.includes("user rejected")||w.includes("User denied")?g("Transaction was cancelled by user"):w.includes("gas")?g("Transaction failed due to gas issues"):w.includes("network")?g("Network error. Please check your connection and try again."):g("Transaction failed. Please try again."),x&&(clearTimeout(x),c(null))}},[L,O,V,x]);const I=(w=>{switch(w){case 1:return{name:"Ethereum Mainnet",symbol:"ETH",color:"#627EEA",explorerUrl:"https://etherscan.io"};case 56:return{name:"BNB Smart Chain",symbol:"BNB",color:"#F3BA2F",explorerUrl:"https://bscscan.com"};case 137:return{name:"Polygon",symbol:"MATIC",color:"#8247E5",explorerUrl:"https://polygonscan.com"};case 42161:return{name:"Arbitrum One",symbol:"ETH",color:"#28A0F0",explorerUrl:"https://arbiscan.io"};case 10:return{name:"Optimism",symbol:"ETH",color:"#FF0420",explorerUrl:"https://optimistic.etherscan.io"};case 8453:return{name:"Base",symbol:"ETH",color:"#0052FF",explorerUrl:"https://basescan.org"};case 43114:return{name:"Avalanche C-Chain",symbol:"AVAX",color:"#E84142",explorerUrl:"https://snowtrace.io"};case 250:return{name:"Fantom Opera",symbol:"FTM",color:"#1969FF",explorerUrl:"https://ftmscan.com"};default:return{name:`Chain ${w}`,symbol:"ETH",color:"#666",explorerUrl:null}}})(r),me=()=>j()&&u()&&!J&&!F&&k,Re=async()=>{if(me())try{g(null),console.log("Sending transaction:",{to:f,value:ee(a),chainId:r}),P({to:f,value:ee(a)})}catch(w){console.error("Transaction error:",w),g("Failed to initiate transaction"),d("error")}},De=["0.001","0.01","0.1"],Pe=w=>{N(w)},Le=()=>{if(k){const w=Math.max(0,parseFloat(k.formatted)-.001);N(w.toString())}},ze=()=>{T&&T()},Q=()=>!S||!I.explorerUrl?null:`${I.explorerUrl}/tx/${S}`,Y=()=>{E==="confirming"&&!window.confirm("Are you sure you want to close? The transaction request may still be pending in your wallet.")||E==="pending"&&!window.confirm("Transaction is being processed on the blockchain. Are you sure you want to close? You can check the status using the transaction hash.")||(x&&clearTimeout(x),s())},We=()=>{switch(E){case"form":return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"transaction-form",children:[t&&e.jsxs("div",{className:"recipient-info",children:[e.jsx(X,{eth:t.wallet}),e.jsxs("div",{className:"recipient-details",children:[e.jsx("h4",{children:t.name}),e.jsxs("p",{className:"recipient-address",children:[t.wallet.slice(0,6),"...",t.wallet.slice(-4)]})]})]}),B&&e.jsxs("div",{className:"error-message",children:["Failed to load balance.",e.jsx("button",{onClick:ze,style:{marginLeft:"10px",background:"#50b458",border:"none",color:"white",padding:"4px 8px",borderRadius:"4px",cursor:"pointer"},children:"Retry"})]}),e.jsxs("div",{className:"form-group",children:[e.jsxs("label",{children:["Amount (",I.symbol,")"]}),e.jsxs("div",{className:"amount-input-group",children:[e.jsx("input",{type:"number",value:a,onChange:w=>N(w.target.value),placeholder:"0.0",step:"0.0001",min:"0",max:(k==null?void 0:k.formatted)||"0",className:a&&!j()?"error":""}),e.jsxs("div",{className:"quick-amounts",children:[De.map(w=>e.jsx("button",{type:"button",className:"quick-amount-btn",onClick:()=>Pe(w),children:w},w)),e.jsx("button",{type:"button",className:"quick-amount-btn",onClick:Le,disabled:!k,children:"Max"})]})]}),e.jsx("div",{className:"balance-info",children:F?e.jsx("span",{children:"Loading balance..."}):k?e.jsxs("span",{children:["Balance: ",parseFloat(k.formatted).toFixed(6)," ",k.symbol]}):e.jsx("span",{children:"Balance unavailable"})}),a&&!j()&&e.jsx("span",{className:"error-text",children:parseFloat(a)<=0?"Amount must be greater than 0":y&&parseFloat(y)>parseFloat((k==null?void 0:k.formatted)||"0")?"Insufficient balance (including gas fees)":"Insufficient balance"})]}),!t&&e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Recipient Address"}),e.jsx("input",{type:"text",value:f,onChange:w=>v(w.target.value),placeholder:"0x...",className:!u()&&f?"error":""}),f&&!u()&&e.jsx("span",{className:"error-text",children:"Invalid address"})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Comment (optional)"}),e.jsx("textarea",{value:h,onChange:w=>p(w.target.value),placeholder:"What's this transaction for?",maxLength:200,rows:3}),e.jsxs("div",{style:{fontSize:"12px",color:"#ccc",textAlign:"right",marginTop:"4px"},children:[h.length,"/200"]})]}),a&&parseFloat(a)>0&&e.jsxs("div",{className:"transaction-summary",children:[e.jsx("h4",{children:"Transaction Summary"}),e.jsxs("div",{className:"summary-row",children:[e.jsx("span",{children:"Amount to send:"}),e.jsxs("span",{children:[a," ",I.symbol]})]}),m&&e.jsxs("div",{className:"summary-row",children:[e.jsx("span",{children:"Estimated gas fee:"}),e.jsxs("span",{className:"gas-fee",children:[parseFloat(m).toFixed(6)," ",I.symbol]})]}),U&&e.jsxs("div",{className:"summary-row",children:[e.jsx("span",{children:"Estimating gas fee..."}),e.jsx("span",{className:"gas-loading",children:"⏳"})]}),y&&e.jsxs("div",{className:"summary-row total",children:[e.jsx("span",{children:e.jsx("strong",{children:"Total cost:"})}),e.jsx("span",{children:e.jsxs("strong",{children:[parseFloat(y).toFixed(6)," ",I.symbol]})})]}),a&&!j()&&y&&e.jsx("div",{className:"summary-warning",children:"⚠️ Insufficient balance for total cost including gas fees"})]}),e.jsx("div",{className:"network-info",children:e.jsxs("span",{children:["Sending on ",I.name]})})]}),e.jsxs("div",{className:"modal-footer",children:[e.jsx("button",{className:"cancel-btn",onClick:Y,children:"Cancel"}),e.jsxs("button",{className:"send-btn",onClick:Re,disabled:!me(),children:[e.jsx(ce,{size:18}),"Send ",a||"0"," ",I.symbol]})]})]});case"confirming":return e.jsxs("div",{className:"transaction-status",children:[e.jsx("div",{className:"status-icon confirming",children:e.jsx("div",{className:"spinner"})}),e.jsx("h3",{children:"Confirm in Wallet"}),e.jsx("p",{children:"Please confirm the transaction in your wallet to continue."}),e.jsxs("p",{children:["Network: ",I.name]}),e.jsx("div",{className:"modal-footer",children:e.jsx("button",{className:"cancel-btn",onClick:Y,children:"Cancel"})})]});case"pending":return e.jsxs("div",{className:"transaction-status",children:[e.jsx("div",{className:"status-icon pending",children:e.jsx("div",{className:"spinner"})}),e.jsx("h3",{children:"Transaction Pending"}),e.jsxs("p",{children:["Your transaction is being processed on ",I.name,"."]}),S&&e.jsxs("div",{className:"transaction-hash",children:[e.jsx("p",{children:"Transaction Hash:"}),e.jsxs("code",{children:[S.slice(0,10),"...",S.slice(-8)]})]}),Q()&&e.jsx("div",{className:"transaction-explorer",children:e.jsxs("a",{href:Q(),target:"_blank",rel:"noopener noreferrer",className:"explorer-link",children:["View on ",I.name," Explorer →"]})}),e.jsx("div",{className:"modal-footer",children:e.jsx("button",{className:"cancel-btn",onClick:Y,children:"Close"})})]});case"success":return e.jsxs("div",{className:"transaction-status",children:[e.jsx("div",{className:"status-icon success",children:"✓"}),e.jsx("h3",{children:"Transaction Sent!"}),e.jsxs("p",{children:["Successfully sent ",a," ",I.symbol," to ",(t==null?void 0:t.name)||"recipient"]}),S&&e.jsxs("div",{className:"transaction-hash",children:[e.jsx("p",{children:"Transaction Hash:"}),e.jsxs("code",{children:[S.slice(0,10),"...",S.slice(-8)]})]}),Q()&&e.jsx("div",{className:"transaction-explorer",children:e.jsxs("a",{href:Q(),target:"_blank",rel:"noopener noreferrer",className:"explorer-link",children:["View on ",I.name," Explorer →"]})}),e.jsx("p",{className:"auto-close",children:"This window will close automatically..."})]});case"error":return e.jsxs("div",{className:"transaction-status",children:[e.jsx("div",{className:"status-icon error",children:"✕"}),e.jsx("h3",{children:"Transaction Failed"}),e.jsx("div",{className:"error-message",children:b}),e.jsxs("div",{className:"modal-footer",children:[e.jsx("button",{className:"cancel-btn",onClick:s,children:"Close"}),e.jsx("button",{className:"retry-btn",onClick:()=>{d("form"),g(null),Z(),x&&(clearTimeout(x),c(null))},children:"Try Again"})]})]});default:return null}};return e.jsx("div",{className:"modalOverlay",children:e.jsxs("div",{className:"modalContent transaction-modal",children:[e.jsxs("div",{className:"modal-header",children:[e.jsxs("h2",{children:["Send ",I.symbol]}),(E==="form"||E==="error")&&e.jsx("button",{className:"closeButton",onClick:Y,children:e.jsx(le,{size:20})})]}),We()]})})},Ae=()=>{const[s,t]=l.useState({width:typeof window<"u"?window.innerWidth:0,height:typeof window<"u"?window.innerHeight:0});l.useEffect(()=>{const r=()=>{t({width:window.innerWidth,height:window.innerHeight})};return window.addEventListener("resize",r),()=>window.removeEventListener("resize",r)},[]);const i=s.width<=768,n=s.width>768&&s.width<=1024,o=s.width>1024;return{isMobile:i,isTablet:n,isDesktop:o,windowSize:s}};function ks(){const{address:s}=R(),[t,i]=l.useState(null),[n,o]=l.useState([]),{setCurrentUser:r,currentUser:a}=H(),[N,f]=l.useState(!1),[v,h]=l.useState(!1),[p,E]=l.useState(null),[d,b]=l.useState(null),{isMobile:g}=Ae(),[x,c]=l.useState("list");l.useEffect(()=>{(async()=>{try{const y=A(M,"users"),S=(await W(y)).docs.map(L=>({id:L.id,name:L.data().name,wallet:L.data().wallet}));o(S),console.log("Fetched users:",S)}catch(y){console.error("Error fetching users:",y)}})()},[]),l.useEffect(()=>{(async()=>{if(!t){b(null);return}try{const y=await Xe(re(M,"privateChats",t));if(y.exists()){const P=y.data();b(P),console.log("Fetched chat data:",P)}else console.error("Chat document not found:",t),b(null)}catch(y){console.error("Error fetching chat data:",y),b(null)}})()},[t]),l.useEffect(()=>{if(n.length>0&&s){const m=n.find(y=>y.wallet===s);console.log("Current User:",m),r(m)}},[n,s,r]);const u=m=>{i(m),g&&c("chat")},j=()=>{g&&(c("list"),i(null))},k=m=>{console.log("New chat created with ID:",m),i(m),g&&c("chat")},F=m=>{const y=n.find(P=>P.id===m);return y?y.wallet:""},B=()=>{const m=T();return m?m.name:"Chat"},T=()=>{if(console.log("Getting recipient user..."),console.log("Selected chat ID:",t),console.log("Current chat data:",d),console.log("Current address:",s),console.log("Available users:",n),!t||!d||!s||n.length===0)return console.log("Missing required data for recipient detection"),null;const m=n.find(S=>S.wallet===s);if(!m)return console.log("Current user not found in users list"),null;console.log("Current user found:",m);const y=d.pid.find(S=>S!==m.id);if(!y)return console.log("Other participant ID not found in chat data"),null;console.log("Other participant ID:",y);const P=n.find(S=>S.id===y);return console.log("Recipient user found:",P),P||null},C=m=>{if(console.log("Handle send transaction called with:",m),!m||!m.wallet||!m.name){console.error("Invalid recipient user:",m);return}E(y=>(console.log("Setting recipient from",y,"to",m),m)),h(y=>(console.log("Setting modal visibility from",y,"to true"),!0))},U=async m=>{if(console.log("Transaction sent:",m),h(!1),E(null),t&&a)try{await vs(m,t,a.id),console.log("Transaction message added to chat")}catch(y){console.error("Failed to add transaction message to chat:",y)}else console.error("Missing chat ID or current user for transaction message")},D=()=>{h(!1),E(null)};return l.useEffect(()=>{const m=T();console.log("Recipient user updated:",m)},[t,d,n,s]),g?e.jsxs("div",{className:"chat mobile-chat",children:[x==="list"?e.jsxs("div",{className:"mobile-chat-list",children:[e.jsx(te,{chatName:"Chats",onBack:j,showBackButton:!1,showProfilePic:!0}),e.jsx("div",{className:"mobile-chat-selector",children:e.jsx(je,{setSelectedChatId:u,users:n,getWalletById:F,selectedChatId:t})}),e.jsx("button",{className:"createChatButton mobile-create-chat",onClick:()=>f(!0),title:"Start new chat",children:e.jsx(xe,{size:28})})]}):e.jsxs("div",{className:"mobile-chat-window",children:[e.jsx(te,{chatName:B(),onBack:j,showBackButton:!0}),t&&e.jsx(be,{selectedChatId:t,onSendTransaction:C,recipientUser:T(),children:e.jsx(ye,{selectedChatId:t,users:n,getWalletById:F,onSendTransaction:C,recipientUser:T()})})]}),N&&e.jsx(we,{onClose:()=>f(!1),onChatCreated:k}),v&&p&&e.jsx(ve,{onClose:D,recipientUser:p,onTransactionSent:U})]}):e.jsxs("div",{className:"chat desktop-chat",children:[e.jsx(je,{setSelectedChatId:u,users:n,getWalletById:F,selectedChatId:t}),e.jsx("div",{className:"desktop-chat-area",children:t?e.jsxs(e.Fragment,{children:[e.jsx(te,{chatName:B(),onBack:j,showBackButton:!1}),e.jsx(be,{selectedChatId:t,onSendTransaction:C,recipientUser:T(),children:e.jsx(ye,{selectedChatId:t,users:n,getWalletById:F,onSendTransaction:C,recipientUser:T()})})]}):e.jsxs("div",{className:"desktop-chat-placeholder",children:[e.jsx("h2",{children:"Select a chat to start messaging"}),e.jsx("p",{children:"Choose a conversation from the sidebar or create a new one"})]})}),e.jsx("button",{className:"createChatButton desktop-create-chat",onClick:()=>f(!0),title:"Start new chat",children:e.jsx(xe,{size:24})}),N&&e.jsx(we,{onClose:()=>f(!1),onChatCreated:k}),v&&p&&e.jsx(ve,{onClose:D,recipientUser:p,onTransactionSent:U})]})}function Es(){const{address:s}=R(),[t,i]=l.useState(null),n=de(),o=async r=>{const a=A(M,"users"),N=z(a,K("wallet","==",r));try{const v=!(await W(N)).empty;console.log("User found:",v),i(v),n(v?"/chat":"/signup")}catch(f){console.error("Error checking user:",f),i(!1),n("/signup")}};return e.jsxs("div",{children:[e.jsxs("button",{className:"proceedButton",onClick:()=>{s?o(s):console.error("Address is undefined")},children:[e.jsx(Je,{size:28}),e.jsx("span",{children:"Proceed"})]}),t!==null&&e.jsx("p",{children:t?"User exists":"User does not exist"})]})}function Ts(){const{address:s,isConnected:t}=R(),{disconnect:i}=Fe(),n=async()=>{localStorage.removeItem("walletconnect"),localStorage.removeItem("walletConnected"),localStorage.removeItem("connectorId"),i()};return e.jsx("div",{className:"wallet-button",children:t&&s?e.jsxs("div",{className:"walletBubble",children:[e.jsxs("div",{className:"address",children:[s.slice(0,6),"...",s.slice(-4)]}),e.jsx("button",{onClick:n,children:e.jsx(le,{size:25})})]}):e.jsx("w3m-connect-button",{})})}function Fs(){const{address:s,isConnected:t,connector:i}=R(),{connect:n,connectors:o}=us();Fe();const[r,a]=l.useState(t);de();const{isMobile:N}=Ae();return l.useEffect(()=>{if(localStorage.getItem("walletConnected")==="true"&&!t){console.log("Attempting to reconnect wallet automatically...");const v=localStorage.getItem("connectorId");if(console.log("Last used connector:",v),v){const h=o.find(p=>p.id===v);h&&(console.log("Reconnecting with saved connector:",v),n({connector:h}))}else{const h=o.find(p=>p.id==="injected");h&&(console.log("No saved connector, trying injected..."),n({connector:h}))}}},[n,o,t]),l.useEffect(()=>{console.log("Connection state changed:",t?"connected":"disconnected"),console.log("Current connector:",i==null?void 0:i.id),a(t),t&&!r&&console.log("Wallet newly connected:",s),!t&&r&&console.log("Wallet disconnected")},[t,s,r,i]),l.useEffect(()=>{const f=()=>{r&&!t&&(console.log("Connection lost while page was inactive, updating UI"),a(!1))};return window.addEventListener("focus",f),()=>{window.removeEventListener("focus",f)}},[r,t]),e.jsxs("div",{className:`homepage ${N?"mobile-homepage":"desktop-homepage"}`,children:[e.jsxs("div",{className:"title",children:[e.jsx("h1",{children:"Chat 3.0 is here."}),e.jsx("h2",{children:"Your personal web3 companion."})]}),e.jsx("div",{children:e.jsxs("div",{className:"login",children:[e.jsx("h3",{children:r?`Connected ${i!=null&&i.id?`(${i.id})`:""}`:"Connect your wallet"}),e.jsx(Ts,{}),r&&e.jsx(Es,{})]})})]})}function Ms(){const{address:s}=R(),t=de(),[i,n]=l.useState(""),[o,r]=l.useState(null),[a,N]=l.useState(!1),[f,v]=l.useState(!1),[h,p]=l.useState(!0);l.useEffect(()=>{(async()=>{if(s){p(!0);try{const x=A(M,"users"),c=z(x,K("wallet","==",s)),j=!(await W(c)).empty;v(j),j&&(console.log("User already exists, redirecting to chat"),t("/chat"))}catch(x){console.error("Error checking if user exists:",x)}finally{p(!1)}}})()},[s,t]);const E=async()=>{const g=A(M,"users"),x=z(g,_("name"),ae(10)),u=(await W(x)).docs.map(j=>({id:j.id,...j.data()}));r({users:u}),console.log("Fetched data:",u)};l.useEffect(()=>{E()},[]);const d=async()=>{if(!s||!i.trim()){console.error("Missing required data: address or name");return}if(f){console.log("User already exists, cannot register again");return}N(!0),console.log("Writing data:",s,i);try{const g=A(M,"users"),x=z(g,K("wallet","==",s));if(!(await W(x)).empty){console.log("User already exists, cannot register"),v(!0),N(!1),t("/chat");return}const u=G(z(g,K("wallet","==",s)),j=>{j.empty||(console.log("User successfully registered, redirecting to chat"),u(),t("/chat"))},j=>{console.error("Error in onSnapshot listener:",j),N(!1)});await ie(g,{wallet:s,name:i.trim()}),console.log("Data written successfully"),setTimeout(()=>{u(),a&&(N(!1),console.log("Registration timeout, stopped listening"))},1e4)}catch(g){console.error("Error writing data:",g),N(!1)}},b=g=>{g.key==="Enter"&&!a&&!f&&i.trim()&&d()};return h?e.jsx("div",{className:"centered-signup",children:e.jsxs("div",{className:"welcomeText",children:[e.jsx("h1",{children:"Checking registration status..."}),e.jsx("h2",{children:"Please wait"})]})}):f?e.jsxs("div",{className:"centered-signup",children:[e.jsxs("div",{className:"welcomeText",children:[e.jsx("h1",{children:"Already Registered"}),e.jsx("h2",{children:"You're already signed up! Redirecting to chat..."})]}),e.jsxs("p",{children:["Wallet Address: ",s]})]}):e.jsxs("div",{className:"centered-signup",children:[e.jsxs("div",{className:"welcomeText",children:[e.jsx("h1",{children:"Welcome to Chat 3.0"}),e.jsx("h2",{children:"One last step to start chatting"})]}),e.jsxs("p",{children:["Wallet Address: ",s]}),e.jsxs("div",{className:"signupBox",children:[e.jsx("input",{type:"text",placeholder:"Enter name",value:i,onChange:g=>n(g.target.value),onKeyPress:b,disabled:a,maxLength:50}),e.jsx("button",{onClick:d,disabled:a||!i.trim(),children:a?"Registering...":"Register"})]}),a&&e.jsx("p",{style:{color:"#50b458",marginTop:"10px"},children:"Creating your account, please wait..."})]})}const Is=new Ze,oe="02ee764d5cc25cff6387d6d3f7943fd6",ne={name:"TokenChat",description:"Web3 Chat Application",url:"https://c4ctus96.github.io/tokenchat",icons:["https://avatars.githubusercontent.com/u/37784886"]},Bs=[ue,Te,Ee,ke,Se,Ce],Ue=hs({chains:Bs,transports:{[ue.id]:q("https://ethereum-rpc.publicnode.com"),[Te.id]:q("https://bsc-dataseed1.defibit.io"),[Ee.id]:q("https://polygon-rpc.com"),[ke.id]:q("https://arbitrum-one-rpc.publicnode.com"),[Se.id]:q("https://optimism-rpc.publicnode.com"),[Ce.id]:q("https://base-rpc.publicnode.com")},connectors:[ms({projectId:oe,metadata:ne,showQrModal:!1}),fs({shimDisconnect:!0}),ps({appName:ne.name,appLogoUrl:ne.icons[0]}),gs({options:{projectId:oe},socials:["google","x","github","discord","apple"],showWallets:!0,email:!0,walletFeatures:!1})]});xs({wagmiConfig:Ue,projectId:oe,defaultChain:ue,themeMode:"dark",enableAnalytics:!0,enableOnramp:!1,themeVariables:{"--w3m-accent":"#50b458","--w3m-color-mix":"#210059","--w3m-color-mix-strength":30}});function As({children:s}){const{isConnected:t}=R();return t?e.jsx(e.Fragment,{children:s}):e.jsx(ns,{to:"/"})}function Us(){const{isConnected:s}=R();return l.useEffect(()=>{console.log("App initialized, connection status:",s),typeof window.ethereum>"u"&&console.log("MetaMask not detected, but WalletConnect can still be used")},[s]),null}function Rs(){return e.jsx(js,{config:Ue,children:e.jsx(es,{client:Is,children:e.jsx(ys,{children:e.jsxs(ss,{basename:"/tokenchat",children:[e.jsx(Us,{}),e.jsxs(ts,{children:[e.jsx(se,{path:"/",element:e.jsx(Fs,{})}),e.jsx(se,{path:"/chat",element:e.jsx(As,{children:e.jsx(ks,{})})}),e.jsx(se,{path:"/signup",element:e.jsx(Ms,{})})]})]})})})})}const Ds=document.getElementById("root"),Ps=as(Ds);Ps.render(e.jsx(Ne.StrictMode,{children:e.jsx(Rs,{})}));
//# sourceMappingURL=index-tGJheTwL.js.map
