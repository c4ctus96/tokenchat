import{aH as e,aI as oe,aJ as re,aK as ce,aE as l,aL as S,aM as A,aN as E,aO as F,aP as T,aQ as M,aR as X,aS as ie,aT as Q,aU as Z,aV as le,aW as H,aX as J,aY as _,aZ as de,a_ as K,a$ as ue,b0 as W,b1 as he,b2 as ee,b3 as G,aC as Y,b4 as ge,b5 as fe,b6 as me,b7 as q,b8 as pe,b9 as xe}from"./react-D4sFk2H4.js";import{u as N,a as te,b as ye,c as je,w as we,i as be,d as Ce,e as ve,f as Se,W as Ne}from"./web3-C4zzx0Ke.js";import"./walletconnect-HkNjc9k2.js";(function(){const s=document.createElement("link").relList;if(s&&s.supports&&s.supports("modulepreload"))return;for(const c of document.querySelectorAll('link[rel="modulepreload"]'))a(c);new MutationObserver(c=>{for(const r of c)if(r.type==="childList")for(const d of r.addedNodes)d.tagName==="LINK"&&d.rel==="modulepreload"&&a(d)}).observe(document,{childList:!0,subtree:!0});function o(c){const r={};return c.integrity&&(r.integrity=c.integrity),c.referrerPolicy&&(r.referrerPolicy=c.referrerPolicy),c.crossOrigin==="use-credentials"?r.credentials="include":c.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function a(c){if(c.ep)return;c.ep=!0;const r=o(c);fetch(c.href,r)}})();const $=({eth:t})=>e.jsx("div",{children:e.jsx("img",{src:`https://effigy.im/a/${t}.svg`,alt:"Profile picture",className:"profilePic"})});function Ee(){const{address:t}=N();return e.jsx("div",{className:"ChatSidebar",children:e.jsx("div",{className:"profilePicture",children:t&&e.jsx($,{eth:t})})})}const Ue={apiKey:"AIzaSyBRDBbrJbmLwb3YTI_YBmMdTjLEd8KjS2E",authDomain:"tokenchat-b8673.firebaseapp.com",projectId:"tokenchat-b8673",storageBucket:"tokenchat-b8673.appspot.com",messagingSenderId:"593980787293",appId:"1:593980787293:web:7c58ff7656a3fa31b19bb4",measurementId:"G-RB9WJLVQC0"},se=oe(Ue);re(se);const C=ce(se);function ke({setSelectedChatId:t,users:s,getWalletById:o,selectedChatId:a}){const{address:c}=N(),[r,d]=l.useState([]),[p,y]=l.useState(null);l.useEffect(()=>{if(!c)return;const n=S(C,"privateChats"),i=A(n,async m=>{var I;try{const U=[];for(const k of m.docs){const R=k.data(),v={id:k.id,pid:R.pid||[]};try{const P=S(C,"privateChats",k.id,"msg"),B=E(P,T("ts","desc"),F(1)),D=await M(B);if(D.empty)v.lastMessage="No messages yet",v.lastMessageTime=new Date(0);else{const V=D.docs[0].data();v.lastMessage=V.txt||"",v.lastMessageTime=((I=V.ts)==null?void 0:I.toDate())||new Date}}catch(P){console.error(`Error fetching messages for chat ${k.id}:`,P),v.lastMessage="Failed to load",v.lastMessageTime=new Date(0)}U.push(v)}U.sort((k,R)=>{var B,D;const v=((B=k.lastMessageTime)==null?void 0:B.getTime())||0;return(((D=R.lastMessageTime)==null?void 0:D.getTime())||0)-v}),console.log("Real-time chatrooms update:",U),d(U),y(null)}catch(U){y("Failed to fetch chat data. Please check your internet connection."),console.error("Snapshot error:",U)}},m=>{y("Failed to fetch data. Please check your internet connection."),console.error("Fetch error:",m)});return()=>i()},[c]),l.useEffect(()=>{(async()=>{if("Notification"in window&&Notification.permission==="default"){const i=await Notification.requestPermission();console.log("Notification permission:",i)}})()},[]),l.useEffect(()=>{if(!c||r.length===0)return;const n=s.find(m=>m.wallet===c);if(!n)return;const i=[];return r.forEach(m=>{if(m.pid.includes(n.id)){const I=S(C,"privateChats",m.id,"msg"),U=E(I,T("ts","desc"),F(1)),k=A(U,R=>{if(!R.empty&&m.id!==a){const v=R.docs[0].data();if(v.from!==n.id){const P=b(v.from);h(P,v.txt)}}});i.push(k)}}),()=>{i.forEach(m=>m())}},[r,c,s,a]);const h=(n,i)=>{if("Notification"in window&&Notification.permission==="granted"){const m=i.length>50?i.substring(0,50)+"...":i;new Notification(`New message from ${n}`,{body:m,icon:"/favicon.ico",badge:"/favicon.ico",tag:"new-message"})}},x=s.find(n=>n.wallet===c),j=x?r.filter(n=>n.pid.includes(x.id)):[],b=n=>{const i=s.find(m=>m.id===n);return i?i.name:n},u=n=>x&&n.find(i=>i!==x.id)||"",g=n=>{const i=u(n);return b(i)},f=(n,i=40)=>n.length<=i?n:n.substring(0,i)+"...",w=n=>{t(n)};return e.jsxs("div",{className:"chatSelector",children:[p&&e.jsx("p",{className:"error",children:p}),j.length>0?j.map(n=>e.jsxs("div",{className:"contactBox",onClick:()=>w(n.id),style:{backgroundColor:n.id===a?"#003344":"#002233",cursor:"pointer"},children:[e.jsx($,{eth:o(u(n.pid))}),e.jsxs("div",{className:"contactTextBox",children:[e.jsx("h3",{style:{fontSize:"16px",fontWeight:"bold"},children:g(n.pid)}),e.jsx("p",{style:{margin:0,fontSize:"14px",color:"#ccc",opacity:.8,lineHeight:"1.2"},children:f(n.lastMessage||"No messages yet")})]})]},n.id)):e.jsxs("div",{style:{padding:"20px",textAlign:"center",color:"#ccc"},children:[e.jsx("p",{children:"No chats yet"}),e.jsx("p",{style:{fontSize:"14px",marginTop:"10px"},children:"Click the + button to start a new conversation"})]})]})}const ne=l.createContext(void 0),Me=({children:t})=>{const[s,o]=l.useState(void 0);return e.jsx(ne.Provider,{value:{currentUser:s,setCurrentUser:o},children:t})},L=()=>{const t=l.useContext(ne);if(!t)throw new Error("useUser must be used within a UserProvider");return t},Re=async(t,s,o)=>{try{const a=S(C,"privateChats",o,"msg");await Q(a,{txt:t,from:s,ts:new Date}),console.log("Message sent successfully")}catch(a){console.error("Error sending message:",a)}},Pe=({selectedChatId:t})=>{const[s,o]=X.useState(""),{currentUser:a}=L(),c=p=>{o(p.target.value)},r=()=>{if(!t||!a||!s.trim()){console.error("Missing required data:",{selectedChatId:t,currentUser:a,inputValue:s});return}Re(s,a.id,t),o("")},d=p=>{p.key==="Enter"&&r()};return e.jsxs("div",{className:"chatBottomBar",children:[e.jsx("input",{type:"text",className:"messageInput",placeholder:"Type your message",value:s,onChange:c,onKeyDown:d}),e.jsx("button",{className:"sendMessageButton",onClick:r,disabled:!t||!a,title:"Send message",children:e.jsx(ie,{size:20})})]})};function De({children:t,selectedChatId:s}){return e.jsxs("div",{className:"chatWindow",children:[e.jsx("div",{className:"chatContent",children:t})," ",e.jsx(Pe,{selectedChatId:s})]})}const Ie=({text:t,timeStamp:s,from:o,own:a})=>e.jsx("div",{className:"messageBox",children:e.jsxs("div",{className:`message ${a?"own":""}`,children:[e.jsx("p",{className:"message-text",children:t}),e.jsx("p",{className:"message-timestamp",children:new Date(s).toLocaleString()})]})});function Be({selectedChatId:t,users:s,getWalletById:o}){const[a,c]=l.useState([]),{address:r}=N(),{currentUser:d}=L(),p=l.useRef(null),y=()=>{var h;(h=p.current)==null||h.scrollIntoView({behavior:"smooth"})};return l.useEffect(()=>{y()},[a]),l.useEffect(()=>{if(!t)return;const h=S(C,"privateChats",t,"msg"),x=E(h,T("ts","asc")),j=A(x,b=>{const u=[];b.forEach(g=>{const f=g.data();f.txt&&f.ts&&f.from?u.push(f):console.log("Missing fields in document:",g.id)}),console.log("Real-time Messages Update:",u),c(u)},b=>{console.error("Error fetching messages:",b)});return()=>j()},[t]),e.jsxs("div",{className:"chatContent",children:[a.map((h,x)=>{const j=d!=null&&d.id?h.from===d.id:!1;return e.jsx(Ie,{text:h.txt,timeStamp:h.ts.toMillis(),from:h.from,own:j},x)}),e.jsx("div",{ref:p})," "]})}const We=({onClose:t,onChatCreated:s})=>{const[o,a]=l.useState([]),[c,r]=l.useState(!0),[d,p]=l.useState(null),[y,h]=l.useState(null),{currentUser:x}=L();l.useEffect(()=>{(async()=>{try{r(!0);const g=S(C,"users"),w=(await M(g)).docs.map(i=>({id:i.id,name:i.data().name,wallet:i.data().wallet,chats:i.data().chats||[]})),n=x?w.filter(i=>i.id!==x.id):w;a(n)}catch(g){console.error("Error fetching users:",g),h("Failed to load users. Please try again.")}finally{r(!1)}})()},[x]);const j=async u=>{if(!x)return null;try{const g=S(C,"privateChats"),f=E(g),w=await M(f);for(const n of w.docs){const m=n.data().pid||[];if(m.includes(x.id)&&m.includes(u))return n.id}return null}catch(g){return console.error("Error checking existing chat:",g),null}},b=async u=>{if(!x){h("You must be logged in to create a chat");return}p(u.id),h(null);try{const g=await j(u.id);if(g){console.log("Chat already exists:",g),s&&s(g),t();return}const f=S(C,"privateChats"),w=await Q(f,{pid:[x.id,u.id],createdAt:new Date,lastActivity:new Date});console.log("Created new chat with ID:",w.id);const n=H(C,"users",x.id),i=H(C,"users",u.id);await Promise.all([J(n,{chats:_(w.id)}),J(i,{chats:_(w.id)})]),console.log("Updated users' chat lists"),s&&s(w.id),t()}catch(g){console.error("Error creating chat:",g),h("Failed to create chat. Please try again.")}finally{p(null)}};return e.jsx("div",{className:"modalOverlay",children:e.jsxs("div",{className:"modalContent",children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"20px"},children:[e.jsx("h2",{children:"Start New Chat"}),e.jsx("button",{className:"closeButton",onClick:t,style:{background:"transparent",border:"none",color:"#fff",cursor:"pointer",padding:"5px"},children:e.jsx(Z,{size:20})})]}),y&&e.jsx("div",{style:{color:"#ff4444",marginBottom:"15px",padding:"10px",background:"rgba(255, 68, 68, 0.1)",borderRadius:"8px"},children:y}),c?e.jsx("div",{style:{textAlign:"center",padding:"20px"},children:e.jsx("p",{children:"Loading users..."})}):o.length===0?e.jsx("div",{style:{textAlign:"center",padding:"20px"},children:e.jsx("p",{children:"No other users found."})}):e.jsxs("div",{style:{maxHeight:"400px",overflowY:"auto",scrollbarWidth:"thin",scrollbarColor:"rgba(255, 255, 255, 0.2) transparent",paddingRight:"8px"},className:"modal-scroll-area",children:[e.jsx("p",{style:{marginBottom:"15px",color:"#ccc"},children:"Select a user to start chatting:"}),e.jsx("div",{style:{display:"flex",flexDirection:"column",gap:"10px"},children:o.map(u=>e.jsxs("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between",padding:"12px",background:"rgba(255, 255, 255, 0.05)",borderRadius:"8px",border:"1px solid rgba(255, 255, 255, 0.1)"},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"12px"},children:[e.jsx($,{eth:u.wallet}),e.jsxs("div",{children:[e.jsx("h4",{style:{margin:0,fontSize:"16px"},children:u.name}),e.jsxs("p",{style:{margin:0,fontSize:"12px",color:"#ccc",fontFamily:"monospace"},children:[u.wallet.slice(0,6),"...",u.wallet.slice(-4)]})]})]}),e.jsx("button",{onClick:()=>b(u),disabled:d===u.id,style:{background:d===u.id?"#666":"#50b458",border:"none",borderRadius:"50%",width:"40px",height:"40px",display:"flex",alignItems:"center",justifyContent:"center",cursor:d===u.id?"not-allowed":"pointer",color:"#fff",transition:"all 0.2s ease"},onMouseEnter:g=>{d!==u.id&&(g.target.style.background="#5bc464",g.target.style.transform="scale(1.05)")},onMouseLeave:g=>{d!==u.id&&(g.target.style.background="#50b458",g.target.style.transform="scale(1)")},children:d===u.id?e.jsx("div",{style:{width:"16px",height:"16px",border:"2px solid #fff",borderTop:"2px solid transparent",borderRadius:"50%",animation:"spin 1s linear infinite"}}):e.jsx(le,{size:18})})]},u.id))})]}),e.jsx("style",{children:`
          @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
          }
          
          .modal-scroll-area::-webkit-scrollbar {
            width: 6px;
          }
          
          .modal-scroll-area::-webkit-scrollbar-track {
            background: transparent;
          }
          
          .modal-scroll-area::-webkit-scrollbar-thumb {
            background-color: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
          }
        `})]})})};function Ae(){const{address:t}=N(),[s,o]=l.useState(null),[a,c]=l.useState([]),{setCurrentUser:r}=L(),[d,p]=l.useState(!1);l.useEffect(()=>{(async()=>{const b=S(C,"users"),g=(await M(b)).docs.map(f=>({id:f.id,name:f.data().name,wallet:f.data().wallet}));c(g)})()},[]),l.useEffect(()=>{if(a.length>0&&t){const j=a.find(b=>b.wallet===t);console.log("Current User:",j),r(j)}},[a,t,r]);const y=j=>{o(j)},h=j=>{console.log("New chat created with ID:",j),o(j)},x=j=>{const b=a.find(u=>u.id===j);return b?b.wallet:""};return e.jsxs("div",{className:"chat",children:[e.jsx(Ee,{}),e.jsx(ke,{setSelectedChatId:y,users:a,getWalletById:x,selectedChatId:s}),e.jsx(De,{selectedChatId:s||void 0,children:s&&e.jsx(Be,{selectedChatId:s,users:a,getWalletById:x})}),e.jsx("button",{className:"createChatButton",onClick:()=>p(!0),title:"Start new chat",children:e.jsx(de,{size:32})}),d&&e.jsx(We,{onClose:()=>p(!1),onChatCreated:h})]})}function Te(){const{address:t}=N(),[s,o]=l.useState(null),a=K(),c=async r=>{const d=S(C,"users"),p=E(d,W("wallet","==",r));try{const h=!(await M(p)).empty;console.log("User found:",h),o(h),a(h?"/chat":"/signup")}catch(y){console.error("Error checking user:",y),o(!1),a("/signup")}};return e.jsxs("div",{children:[e.jsxs("button",{className:"proceedButton",onClick:()=>{t?c(t):console.error("Address is undefined")},children:[e.jsx(ue,{size:28}),e.jsx("span",{children:"Proceed"})]}),s!==null&&e.jsx("p",{children:s?"User exists":"User does not exist"})]})}function Le(){const{address:t,isConnected:s}=N(),{disconnect:o}=te(),a=async()=>{localStorage.removeItem("walletconnect"),localStorage.removeItem("walletConnected"),localStorage.removeItem("connectorId"),o()};return e.jsx("div",{className:"wallet-button",children:s&&t?e.jsxs("div",{className:"walletBubble",children:[e.jsxs("div",{className:"address",children:[t.slice(0,6),"...",t.slice(-4)]}),e.jsx("button",{onClick:a,children:e.jsx(Z,{size:25})})]}):e.jsx("w3m-connect-button",{})})}function qe(){const{address:t,isConnected:s,connector:o}=N(),{connect:a,connectors:c}=ye();te();const[r,d]=l.useState(s);return K(),l.useEffect(()=>{if(localStorage.getItem("walletConnected")==="true"&&!s){console.log("Attempting to reconnect wallet automatically...");const y=localStorage.getItem("connectorId");if(console.log("Last used connector:",y),y){const h=c.find(x=>x.id===y);h&&(console.log("Reconnecting with saved connector:",y),a({connector:h}))}else{const h=c.find(x=>x.id==="injected");h&&(console.log("No saved connector, trying injected..."),a({connector:h}))}}},[a,c,s]),l.useEffect(()=>{console.log("Connection state changed:",s?"connected":"disconnected"),console.log("Current connector:",o==null?void 0:o.id),d(s),s&&!r&&console.log("Wallet newly connected:",t),!s&&r&&console.log("Wallet disconnected")},[s,t,r,o]),l.useEffect(()=>{const p=()=>{r&&!s&&(console.log("Connection lost while page was inactive, updating UI"),d(!1))};return window.addEventListener("focus",p),()=>{window.removeEventListener("focus",p)}},[r,s]),e.jsxs("div",{className:"homepage",children:[e.jsxs("div",{className:"title",children:[e.jsx("h1",{children:"Chat 3.0 is here."}),e.jsx("h2",{children:"Your personal web3 companion."})]}),e.jsx("div",{children:e.jsxs("div",{className:"login",children:[e.jsx("h3",{children:r?`Connected ${o!=null&&o.id?`(${o.id})`:""}`:"Connect your wallet"}),e.jsx(Le,{}),r&&e.jsx(Te,{})]})})]})}function ze(){const{address:t}=N(),s=K(),[o,a]=l.useState(""),[c,r]=l.useState(null),[d,p]=l.useState(!1),[y,h]=l.useState(!1),[x,j]=l.useState(!0);l.useEffect(()=>{(async()=>{if(t){j(!0);try{const w=S(C,"users"),n=E(w,W("wallet","==",t)),m=!(await M(n)).empty;h(m),m&&(console.log("User already exists, redirecting to chat"),s("/chat"))}catch(w){console.error("Error checking if user exists:",w)}finally{j(!1)}}})()},[t,s]);const b=async()=>{const f=S(C,"users"),w=E(f,T("name"),F(10)),i=(await M(w)).docs.map(m=>({id:m.id,...m.data()}));r({users:i}),console.log("Fetched data:",i)};l.useEffect(()=>{b()},[]);const u=async()=>{if(!t||!o.trim()){console.error("Missing required data: address or name");return}if(y){console.log("User already exists, cannot register again");return}p(!0),console.log("Writing data:",t,o);try{const f=S(C,"users"),w=E(f,W("wallet","==",t));if(!(await M(w)).empty){console.log("User already exists, cannot register"),h(!0),p(!1),s("/chat");return}const i=A(E(f,W("wallet","==",t)),m=>{m.empty||(console.log("User successfully registered, redirecting to chat"),i(),s("/chat"))},m=>{console.error("Error in onSnapshot listener:",m),p(!1)});await Q(f,{wallet:t,name:o.trim()}),console.log("Data written successfully"),setTimeout(()=>{i(),d&&(p(!1),console.log("Registration timeout, stopped listening"))},1e4)}catch(f){console.error("Error writing data:",f),p(!1)}},g=f=>{f.key==="Enter"&&!d&&!y&&o.trim()&&u()};return x?e.jsx("div",{className:"centered-signup",children:e.jsxs("div",{className:"welcomeText",children:[e.jsx("h1",{children:"Checking registration status..."}),e.jsx("h2",{children:"Please wait"})]})}):y?e.jsxs("div",{className:"centered-signup",children:[e.jsxs("div",{className:"welcomeText",children:[e.jsx("h1",{children:"Already Registered"}),e.jsx("h2",{children:"You're already signed up! Redirecting to chat..."})]}),e.jsxs("p",{children:["Wallet Address: ",t]})]}):e.jsxs("div",{className:"centered-signup",children:[e.jsxs("div",{className:"welcomeText",children:[e.jsx("h1",{children:"Welcome to Chat 3.0"}),e.jsx("h2",{children:"One last step to start chatting"})]}),e.jsxs("p",{children:["Wallet Address: ",t]}),e.jsxs("div",{className:"signupBox",children:[e.jsx("input",{type:"text",placeholder:"Enter name",value:o,onChange:f=>a(f.target.value),onKeyPress:g,disabled:d,maxLength:50}),e.jsx("button",{onClick:u,disabled:d||!o.trim(),children:d?"Registering...":"Register"})]}),d&&e.jsx("p",{style:{color:"#50b458",marginTop:"10px"},children:"Creating your account, please wait..."})]})}const Fe=new he,O="02ee764d5cc25cff6387d6d3f7943fd6",z={name:"TokenChat",description:"Web3 Chat Application",url:"https://c4ctus96.github.io/tokenchat",icons:["https://avatars.githubusercontent.com/u/37784886"]},Oe=[Y,ee],ae=je({chains:Oe,transports:{[Y.id]:G("https://eth-mainnet.g.alchemy.com/v2/demo"),[ee.id]:G("https://arb-mainnet.g.alchemy.com/v2/demo")},connectors:[we({projectId:O,metadata:z,showQrModal:!1}),be({shimDisconnect:!0}),Ce({appName:z.name,appLogoUrl:z.icons[0]}),ve({options:{projectId:O},socials:["google","x","github","discord","apple"],showWallets:!0,email:!0,walletFeatures:!1})]});Se({wagmiConfig:ae,projectId:O,defaultChain:Y,themeMode:"dark",enableAnalytics:!0,enableOnramp:!1,themeVariables:{"--w3m-accent":"#50b458","--w3m-color-mix":"#210059","--w3m-color-mix-strength":30}});function Qe({children:t}){const{isConnected:s}=N();return s?e.jsx(e.Fragment,{children:t}):e.jsx(pe,{to:"/"})}function Ke(){const{isConnected:t}=N();return l.useEffect(()=>{console.log("App initialized, connection status:",t),typeof window.ethereum>"u"&&console.log("MetaMask not detected, but WalletConnect can still be used")},[t]),null}function Ye(){return e.jsx(Ne,{config:ae,children:e.jsx(ge,{client:Fe,children:e.jsx(Me,{children:e.jsxs(fe,{basename:"/tokenchat",children:[e.jsx(Ke,{}),e.jsxs(me,{children:[e.jsx(q,{path:"/",element:e.jsx(qe,{})}),e.jsx(q,{path:"/chat",element:e.jsx(Qe,{children:e.jsx(Ae,{})})}),e.jsx(q,{path:"/signup",element:e.jsx(ze,{})})]})]})})})})}const $e=document.getElementById("root"),Ve=xe($e);Ve.render(e.jsx(X.StrictMode,{children:e.jsx(Ye,{})}));
//# sourceMappingURL=index-Bk97lj9u.js.map
