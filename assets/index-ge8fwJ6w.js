import{aI as Fe,aJ as Ae,aK as Ue,aL as e,aE as i,aM as A,aN as V,aO as P,aP as G,aQ as Q,aR as z,aS as ge,aT as Re,aU as ee,aV as se,aW as oe,aX as De,aY as Pe,aZ as ze,a_ as te,a$ as Le,b0 as J,b1 as ce,b2 as ie,b3 as We,b4 as He,b5 as le,b6 as qe,b7 as ne,b8 as Oe,b9 as $,ba as $e,bb as pe,bc as W,bd as xe,be as je,bf as be,bg as we,aC as ae,bh as Ve,bi as Qe,bj as Ye,bk as K,bl as Ke,bm as _e}from"./react-CulJTQnF.js";import{u as D,a as Xe,b as Ge,c as Je,d as Ze,e as es,f as ye,g as ss,h as ts,w as ns,i as as,j as rs,k as os,l as cs,W as is}from"./web3-DS3Acpbn.js";import"./walletconnect-BDrbz5XB.js";(function(){const s=document.createElement("link").relList;if(s&&s.supports&&s.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))n(o);new MutationObserver(o=>{for(const a of o)if(a.type==="childList")for(const l of a.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&n(l)}).observe(document,{childList:!0,subtree:!0});function r(o){const a={};return o.integrity&&(a.integrity=o.integrity),o.referrerPolicy&&(a.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?a.credentials="include":o.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function n(o){if(o.ep)return;o.ep=!0;const a=r(o);fetch(o.href,a)}})();const ls={apiKey:"AIzaSyBRDBbrJbmLwb3YTI_YBmMdTjLEd8KjS2E",authDomain:"tokenchat-b8673.firebaseapp.com",projectId:"tokenchat-b8673",storageBucket:"tokenchat-b8673.appspot.com",messagingSenderId:"593980787293",appId:"1:593980787293:web:7c58ff7656a3fa31b19bb4",measurementId:"G-RB9WJLVQC0"},ve=Fe(ls);Ae(ve);const B=Ue(ve),Y=({eth:t})=>e.jsx("div",{children:e.jsx("img",{src:`https://effigy.im/a/${t}.svg`,alt:"Profile picture",className:"profilePic"})});function de({setSelectedChatId:t,users:s,getWalletById:r,selectedChatId:n}){const{address:o}=D(),[a,l]=i.useState([]),[v,g]=i.useState(null);i.useEffect(()=>{if(!o)return;const c=A(B,"privateChats"),u=V(c,async b=>{var C;try{const T=[];for(const I of b.docs){const M=I.data(),k={id:I.id,pid:M.pid||[]};try{const F=A(B,"privateChats",I.id,"msg"),U=P(F,Q("ts","desc"),G(1)),h=await z(U);if(h.empty)k.lastMessage="No messages yet",k.lastMessageTime=new Date(0);else{const N=h.docs[0].data();k.lastMessage=N.txt||"",k.lastMessageTime=((C=N.ts)==null?void 0:C.toDate())||new Date}}catch(F){console.error(`Error fetching messages for chat ${I.id}:`,F),k.lastMessage="Failed to load",k.lastMessageTime=new Date(0)}T.push(k)}T.sort((I,M)=>{var U,h;const k=((U=I.lastMessageTime)==null?void 0:U.getTime())||0;return(((h=M.lastMessageTime)==null?void 0:h.getTime())||0)-k}),console.log("Real-time chatrooms update:",T),l(T),g(null)}catch(T){g("Failed to fetch chat data. Please check your internet connection."),console.error("Snapshot error:",T)}},b=>{g("Failed to fetch data. Please check your internet connection."),console.error("Fetch error:",b)});return()=>u()},[o]),i.useEffect(()=>{(async()=>{if("Notification"in window&&Notification.permission==="default"){const u=await Notification.requestPermission();console.log("Notification permission:",u)}})()},[]),i.useEffect(()=>{if(!o||a.length===0)return;const c=s.find(b=>b.wallet===o);if(!c)return;const u=[];return a.forEach(b=>{if(b.pid.includes(c.id)){const C=A(B,"privateChats",b.id,"msg"),T=P(C,Q("ts","desc"),G(1)),I=V(T,M=>{if(!M.empty&&b.id!==n){const k=M.docs[0].data();if(k.from!==c.id){const F=S(k.from);w(F,k.txt)}}});u.push(I)}}),()=>{u.forEach(b=>b())}},[a,o,s,n]);const w=(c,u)=>{if("Notification"in window&&Notification.permission==="granted"){const b=u.length>50?u.substring(0,50)+"...":u;new Notification(`New message from ${c}`,{body:b,icon:"/favicon.ico",badge:"/favicon.ico",tag:"new-message"})}},m=s.find(c=>c.wallet===o),f=m?a.filter(c=>c.pid.includes(m.id)):[],S=c=>{const u=s.find(b=>b.id===c);return u?u.name:c},d=c=>m&&c.find(u=>u!==m.id)||"",j=c=>{const u=d(c);return S(u)},p=(c,u=40)=>c.length<=u?c:c.substring(0,u)+"...",x=c=>{t(c)};return e.jsxs("div",{className:"chatSelector",children:[v&&e.jsx("p",{className:"error",children:v}),f.length>0?f.map(c=>e.jsxs("div",{className:"contactBox",onClick:()=>x(c.id),style:{backgroundColor:c.id===n?"#003344":"#002233",cursor:"pointer"},children:[e.jsx(Y,{eth:r(d(c.pid))}),e.jsxs("div",{className:"contactTextBox",children:[e.jsx("h3",{style:{fontSize:"16px",fontWeight:"bold"},children:j(c.pid)}),e.jsx("p",{style:{margin:0,fontSize:"14px",color:"#ccc",opacity:.8,lineHeight:"1.2"},children:p(c.lastMessage||"No messages yet")})]})]},c.id)):e.jsxs("div",{style:{padding:"20px",textAlign:"center",color:"#ccc"},children:[e.jsx("p",{children:"No chats yet"}),e.jsx("p",{style:{fontSize:"14px",marginTop:"10px"},children:"Click the + button to start a new conversation"})]})]})}const Ne=i.createContext(void 0),ds=({children:t})=>{const[s,r]=i.useState(void 0);return e.jsx(Ne.Provider,{value:{currentUser:s,setCurrentUser:r},children:t})},H=()=>{const t=i.useContext(Ne);if(!t)throw new Error("useUser must be used within a UserProvider");return t},Ce=async(t,s,r,n="text",o)=>{try{const a=A(B,"privateChats",r,"msg"),l={txt:t,from:s,ts:new Date,type:n};n==="transaction"&&o&&(l.transactionData=o),await se(a,l),console.log("Message sent successfully")}catch(a){throw console.error("Error sending message:",a),a}},us=({selectedChatId:t,onSendTransaction:s,recipientUser:r})=>{const[n,o]=ge.useState(""),{currentUser:a}=H(),l=m=>{o(m.target.value)},v=async()=>{if(!t||!a||!n.trim()){console.error("Missing required data:",{selectedChatId:t,currentUser:a,inputValue:n});return}try{await Ce(n.trim(),a.id,t),o("")}catch(m){console.error("Failed to send message:",m)}},g=()=>{if(!r||!s){console.error("Missing recipient data for transaction");return}s(r)},w=m=>{m.key==="Enter"&&!m.shiftKey&&(m.preventDefault(),v())};return e.jsxs("div",{className:"chatBottomBar",children:[e.jsx("input",{type:"text",className:"messageInput",placeholder:"Type your message...",value:n,onChange:l,onKeyDown:w}),e.jsx("button",{className:"transactionButton",onClick:g,disabled:!t||!a||!r,title:"Send crypto",children:e.jsx(Re,{size:20})}),e.jsx("button",{className:"sendMessageButton",onClick:v,disabled:!t||!a||!n.trim(),title:"Send message",children:e.jsx(ee,{size:20})})]})},hs=async(t,s,r)=>{try{const n=`Sent ${t.amount} ${ms(t.chainId)} to ${t.recipientName}`;await Ce(n,r,s,"transaction",t),console.log("Transaction message sent to chat")}catch(n){throw console.error("Failed to send transaction message:",n),n}},ms=t=>{switch(t){case 1:return"ETH";case 56:return"BNB";case 137:return"MATIC";case 42161:return"ETH";case 10:return"ETH";case 8453:return"ETH";case 43114:return"AVAX";case 250:return"FTM";default:return"ETH"}};function ue({children:t,selectedChatId:s,onSendTransaction:r,recipientUser:n}){return e.jsxs("div",{className:"chatWindow",children:[e.jsx("div",{className:"chatContent",children:t}),e.jsx(us,{selectedChatId:s,onSendTransaction:r,recipientUser:n||void 0})]})}const fs=({text:t,timeStamp:s,from:r,own:n})=>e.jsx("div",{className:"messageBox",children:e.jsxs("div",{className:`message ${n?"own":""}`,children:[e.jsx("p",{className:"message-text",children:t}),e.jsx("p",{className:"message-timestamp",children:new Date(s).toLocaleString()})]})}),gs=({transaction:t,own:s,timeStamp:r})=>{const o=(m=>{switch(m){case 1:return{name:"Ethereum",symbol:"ETH",color:"#627EEA",explorerUrl:"https://etherscan.io"};case 56:return{name:"BSC",symbol:"BNB",color:"#F3BA2F",explorerUrl:"https://bscscan.com"};case 137:return{name:"Polygon",symbol:"MATIC",color:"#8247E5",explorerUrl:"https://polygonscan.com"};case 42161:return{name:"Arbitrum",symbol:"ETH",color:"#28A0F0",explorerUrl:"https://arbiscan.io"};case 10:return{name:"Optimism",symbol:"ETH",color:"#FF0420",explorerUrl:"https://optimistic.etherscan.io"};case 8453:return{name:"Base",symbol:"ETH",color:"#0052FF",explorerUrl:"https://basescan.org"};case 43114:return{name:"Avalanche",symbol:"AVAX",color:"#E84142",explorerUrl:"https://snowtrace.io"};case 250:return{name:"Fantom",symbol:"FTM",color:"#1969FF",explorerUrl:"https://ftmscan.com"};default:return{name:"Unknown",symbol:"ETH",color:"#666",explorerUrl:null}}})(t.chainId),l=(()=>{switch(t.status){case"pending":return{icon:e.jsx(oe,{size:16}),text:"Pending",className:"pending"};case"confirmed":return{icon:e.jsx(Pe,{size:16}),text:"Confirmed",className:"confirmed"};case"failed":return{icon:e.jsx(De,{size:16}),text:"Failed",className:"failed"};default:return{icon:e.jsx(oe,{size:16}),text:"Unknown",className:"unknown"}}})(),v=m=>{const f=parseFloat(m);return f<1e-4?f.toExponential(2):f<1?f.toFixed(6):f<1e3?f.toFixed(4):f.toFixed(2)},w=o.explorerUrl?`${o.explorerUrl}/tx/${t.hash}`:null;return e.jsx("div",{className:"messageBox",children:e.jsxs("div",{className:`message transaction-message ${s?"own":""}`,children:[e.jsxs("div",{className:"transaction-header",children:[e.jsx("div",{className:"transaction-icon",children:e.jsx(ee,{size:20})}),e.jsx("div",{className:"transaction-title",children:e.jsx("span",{children:s?`Sent to ${t.recipientName}`:`Received from ${t.senderName}`})}),e.jsxs("div",{className:`transaction-status ${l.className}`,children:[l.icon,e.jsx("span",{children:l.text})]})]}),e.jsxs("div",{className:"transaction-amount",children:[e.jsxs("span",{className:"amount",children:[s?"-":"+",v(t.amount)]}),e.jsx("span",{className:"currency",children:o.symbol})]}),e.jsx("div",{className:"transaction-network",children:e.jsx("div",{className:"network-badge",style:{backgroundColor:o.color},children:o.name})}),e.jsxs("div",{className:"transaction-details",children:[e.jsxs("div",{className:"detail-row",children:[e.jsx("span",{className:"label",children:"Hash:"}),e.jsxs("span",{className:"value hash",children:[t.hash.slice(0,8),"...",t.hash.slice(-6)]})]}),w&&e.jsx("div",{className:"transaction-explorer",children:e.jsx("a",{href:w,target:"_blank",rel:"noopener noreferrer",className:"explorer-link",children:"View on Explorer →"})})]}),e.jsx("div",{className:"message-timestamp",children:new Date(r).toLocaleString()})]})})};function he({selectedChatId:t,users:s,getWalletById:r,onSendTransaction:n,recipientUser:o}){const[a,l]=i.useState([]),{address:v}=D(),{currentUser:g}=H(),w=i.useRef(null),m=()=>{var f;(f=w.current)==null||f.scrollIntoView({behavior:"smooth"})};return i.useEffect(()=>{m()},[a]),i.useEffect(()=>{if(!t)return;const f=A(B,"privateChats",t,"msg"),S=P(f,Q("ts","asc")),d=V(S,j=>{const p=[];j.forEach(x=>{const c=x.data();c.txt&&c.ts&&c.from?p.push(c):console.log("Missing fields in document:",x.id)}),console.log("Real-time Messages Update:",p),l(p)},j=>{console.error("Error fetching messages:",j)});return()=>d()},[t]),e.jsxs("div",{className:"chatContent",children:[a.map((f,S)=>{const d=g!=null&&g.id?f.from===g.id:!1;return f.type==="transaction"&&f.transactionData?e.jsx(gs,{transaction:f.transactionData,own:d,timeStamp:f.ts.toMillis()},S):e.jsx(fs,{text:f.txt,timeStamp:f.ts.toMillis(),from:f.from,own:d},S)}),e.jsx("div",{ref:w})," "]})}const _=({chatName:t,onBack:s,showBackButton:r,showProfilePic:n=!1})=>{const{address:o}=D();return e.jsxs("div",{className:"chat-header",children:[e.jsxs("div",{className:"chat-header-left",children:[r&&e.jsx("button",{className:"back-button",onClick:s,title:"Go back",children:e.jsx(ze,{size:24})}),e.jsx("div",{className:"chat-header-info",children:e.jsx("h2",{className:"chat-header-title",children:t})})]}),e.jsx("div",{className:"chat-header-right",children:(n||!r)&&o&&e.jsx("div",{className:"header-profile-pic",children:e.jsx(Y,{eth:o})})})]})},me=({onClose:t,onChatCreated:s})=>{const[r,n]=i.useState([]),[o,a]=i.useState(!0),[l,v]=i.useState(null),[g,w]=i.useState(null),{currentUser:m}=H();i.useEffect(()=>{(async()=>{try{a(!0);const j=A(B,"users"),x=(await z(j)).docs.map(u=>({id:u.id,name:u.data().name,wallet:u.data().wallet,chats:u.data().chats||[]})),c=m?x.filter(u=>u.id!==m.id):x;n(c)}catch(j){console.error("Error fetching users:",j),w("Failed to load users. Please try again.")}finally{a(!1)}})()},[m]);const f=async d=>{if(!m)return null;try{const j=A(B,"privateChats"),p=P(j),x=await z(p);for(const c of x.docs){const b=c.data().pid||[];if(b.includes(m.id)&&b.includes(d))return c.id}return null}catch(j){return console.error("Error checking existing chat:",j),null}},S=async d=>{if(!m){w("You must be logged in to create a chat");return}v(d.id),w(null);try{const j=await f(d.id);if(j){console.log("Chat already exists:",j),s&&s(j),t();return}const p=A(B,"privateChats"),x=await se(p,{pid:[m.id,d.id],createdAt:new Date,lastActivity:new Date});console.log("Created new chat with ID:",x.id);const c=J(B,"users",m.id),u=J(B,"users",d.id);await Promise.all([ce(c,{chats:ie(x.id)}),ce(u,{chats:ie(x.id)})]),console.log("Updated users' chat lists"),s&&s(x.id),t()}catch(j){console.error("Error creating chat:",j),w("Failed to create chat. Please try again.")}finally{v(null)}};return e.jsx("div",{className:"modalOverlay",children:e.jsxs("div",{className:"modalContent",children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"20px"},children:[e.jsx("h2",{children:"Start New Chat"}),e.jsx("button",{className:"closeButton",onClick:t,style:{background:"transparent",border:"none",color:"#fff",cursor:"pointer",padding:"5px"},children:e.jsx(te,{size:20})})]}),g&&e.jsx("div",{style:{color:"#ff4444",marginBottom:"15px",padding:"10px",background:"rgba(255, 68, 68, 0.1)",borderRadius:"8px"},children:g}),o?e.jsx("div",{style:{textAlign:"center",padding:"20px"},children:e.jsx("p",{children:"Loading users..."})}):r.length===0?e.jsx("div",{style:{textAlign:"center",padding:"20px"},children:e.jsx("p",{children:"No other users found."})}):e.jsxs("div",{style:{maxHeight:"60vh",overflowY:"auto",scrollbarWidth:"thin",scrollbarColor:"rgba(255, 255, 255, 0.2) transparent",paddingRight:"8px"},className:"modal-scroll-area",children:[e.jsx("p",{style:{marginBottom:"15px",color:"#ccc"},children:"Select a user to start chatting:"}),e.jsx("div",{style:{display:"flex",flexDirection:"column",gap:"10px"},children:r.map(d=>e.jsxs("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between",padding:"12px",background:"rgba(255, 255, 255, 0.05)",borderRadius:"8px",border:"1px solid rgba(255, 255, 255, 0.1)"},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"12px"},children:[e.jsx(Y,{eth:d.wallet}),e.jsxs("div",{children:[e.jsx("h4",{style:{margin:0,fontSize:"16px"},children:d.name}),e.jsxs("p",{style:{margin:0,fontSize:"12px",color:"#ccc",fontFamily:"monospace"},children:[d.wallet.slice(0,6),"...",d.wallet.slice(-4)]})]})]}),e.jsx("button",{onClick:()=>S(d),disabled:l===d.id,style:{background:l===d.id?"#666":"#50b458",border:"none",borderRadius:"50%",width:"40px",height:"40px",display:"flex",alignItems:"center",justifyContent:"center",cursor:l===d.id?"not-allowed":"pointer",color:"#fff",transition:"all 0.2s ease"},onMouseEnter:j=>{l!==d.id&&(j.target.style.background="#5bc464",j.target.style.transform="scale(1.05)")},onMouseLeave:j=>{l!==d.id&&(j.target.style.background="#50b458",j.target.style.transform="scale(1)")},children:l===d.id?e.jsx("div",{style:{width:"16px",height:"16px",border:"2px solid #fff",borderTop:"2px solid transparent",borderRadius:"50%",animation:"spin 1s linear infinite"}}):e.jsx(Le,{size:18})})]},d.id))})]}),e.jsx("style",{children:`
          @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
          }
          
          .modal-scroll-area::-webkit-scrollbar {
            width: 6px;
          }
          
          .modal-scroll-area::-webkit-scrollbar-track {
            background: transparent;
          }
          
          .modal-scroll-area::-webkit-scrollbar-thumb {
            background-color: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
          }
        `})]})})},fe=({onClose:t,recipientUser:s,onTransactionSent:r})=>{const{address:n}=D(),{currentUser:o}=H(),a=Xe();Ge();const[l,v]=i.useState(""),[g,w]=i.useState((s==null?void 0:s.wallet)||""),[m,f]=i.useState(""),[S,d]=i.useState("form"),[j,p]=i.useState(null),{data:x,isLoading:c,error:u}=Je({address:n,chainId:a}),{sendTransaction:b,data:C,error:T,isPending:I,reset:M}=Ze(),{isLoading:k,isSuccess:F,isError:U,error:h}=es({hash:C});i.useEffect(()=>{M(),d("form"),p(null)},[M]),i.useEffect(()=>{I&&(d("confirming"),p(null))},[I]),i.useEffect(()=>{C&&!k&&!F&&!U&&d("pending")},[C,k,F,U]),i.useEffect(()=>{if(F&&C){d("success");const y={hash:C,to:g,amount:l,chainId:a,timestamp:new Date,from:n,recipientName:(s==null?void 0:s.name)||"Unknown",senderName:(o==null?void 0:o.name)||"You",status:"confirmed"};r&&r(y),setTimeout(()=>{t()},3e3)}},[F,C,g,l,a,n,s,o,r,t]),i.useEffect(()=>{if(T||U){d("error");const y=(T==null?void 0:T.message)||(h==null?void 0:h.message)||"Transaction failed";y.includes("insufficient funds")?p("Insufficient funds for this transaction"):y.includes("user rejected")?p("Transaction was cancelled"):y.includes("gas")?p("Transaction failed due to gas issues"):p(y)}},[T,U,h]);const E=(y=>{switch(y){case 1:return{name:"Ethereum Mainnet",symbol:"ETH",color:"#627EEA",explorerUrl:"https://etherscan.io"};case 56:return{name:"BNB Smart Chain",symbol:"BNB",color:"#F3BA2F",explorerUrl:"https://bscscan.com"};case 137:return{name:"Polygon",symbol:"MATIC",color:"#8247E5",explorerUrl:"https://polygonscan.com"};case 42161:return{name:"Arbitrum One",symbol:"ETH",color:"#28A0F0",explorerUrl:"https://arbiscan.io"};case 10:return{name:"Optimism",symbol:"ETH",color:"#FF0420",explorerUrl:"https://optimistic.etherscan.io"};case 8453:return{name:"Base",symbol:"ETH",color:"#0052FF",explorerUrl:"https://basescan.org"};case 43114:return{name:"Avalanche C-Chain",symbol:"AVAX",color:"#E84142",explorerUrl:"https://snowtrace.io"};case 250:return{name:"Fantom Opera",symbol:"FTM",color:"#1969FF",explorerUrl:"https://ftmscan.com"};default:return{name:`Chain ${y}`,symbol:"ETH",color:"#666",explorerUrl:null}}})(a),R=()=>{try{const y=parseFloat(l);return y<=0||!x?!1:y<=parseFloat(x.formatted)}catch{return!1}},L=()=>We(g),re=()=>R()&&L()&&!I&&!c,Ee=async()=>{if(re())try{p(null),b({to:g,value:He(l)})}catch(y){console.error("Transaction error:",y),p("Failed to send transaction"),d("error")}},Te=["0.001","0.01","0.1"],Me=y=>{v(y)},Be=()=>{if(x){const y=Math.max(0,parseFloat(x.formatted)-.001);v(y.toString())}},q=()=>!C||!E.explorerUrl?null:`${E.explorerUrl}/tx/${C}`,O=()=>{(S==="confirming"||S==="pending")&&!window.confirm("Transaction is in progress. Are you sure you want to close this window? You can check the transaction status in your wallet.")||t()},Ie=()=>{switch(S){case"form":return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"transaction-form",children:[s&&e.jsxs("div",{className:"recipient-info",children:[e.jsx(Y,{eth:s.wallet}),e.jsxs("div",{className:"recipient-details",children:[e.jsx("h4",{children:s.name}),e.jsxs("p",{className:"recipient-address",children:[s.wallet.slice(0,6),"...",s.wallet.slice(-4)]})]})]}),u&&e.jsx("div",{className:"error-message",children:"Failed to load balance. Please check your network connection."}),e.jsxs("div",{className:"form-group",children:[e.jsxs("label",{children:["Amount (",E.symbol,")"]}),e.jsxs("div",{className:"amount-input-group",children:[e.jsx("input",{type:"number",value:l,onChange:y=>v(y.target.value),placeholder:"0.0",step:"0.0001",min:"0",max:(x==null?void 0:x.formatted)||"0",className:l&&!R()?"error":""}),e.jsxs("div",{className:"quick-amounts",children:[Te.map(y=>e.jsx("button",{type:"button",className:"quick-amount-btn",onClick:()=>Me(y),children:y},y)),e.jsx("button",{type:"button",className:"quick-amount-btn",onClick:Be,disabled:!x,children:"Max"})]})]}),e.jsx("div",{className:"balance-info",children:c?e.jsx("span",{children:"Loading balance..."}):x?e.jsxs("span",{children:["Balance: ",parseFloat(x.formatted).toFixed(6)," ",x.symbol]}):e.jsx("span",{children:"Balance unavailable"})}),l&&!R()&&e.jsx("span",{className:"error-text",children:parseFloat(l)<=0?"Amount must be greater than 0":"Insufficient balance"})]}),!s&&e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Recipient Address"}),e.jsx("input",{type:"text",value:g,onChange:y=>w(y.target.value),placeholder:"0x...",className:!L()&&g?"error":""}),g&&!L()&&e.jsx("span",{className:"error-text",children:"Invalid address"})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Message (optional)"}),e.jsx("textarea",{value:m,onChange:y=>f(y.target.value),placeholder:"What's this for?",maxLength:200,rows:3})]}),e.jsx("div",{className:"network-info",children:e.jsxs("span",{children:["Sending on ",E.name]})})]}),e.jsxs("div",{className:"modal-footer",children:[e.jsx("button",{className:"cancel-btn",onClick:O,children:"Cancel"}),e.jsxs("button",{className:"send-btn",onClick:Ee,disabled:!re(),children:[e.jsx(ee,{size:18}),"Send ",l||"0"," ",E.symbol]})]})]});case"confirming":return e.jsxs("div",{className:"transaction-status",children:[e.jsx("div",{className:"status-icon confirming",children:e.jsx("div",{className:"spinner"})}),e.jsx("h3",{children:"Confirm in Wallet"}),e.jsx("p",{children:"Please confirm the transaction in your wallet to continue."}),e.jsxs("p",{children:["Network: ",E.name]}),e.jsx("div",{className:"modal-footer",children:e.jsx("button",{className:"cancel-btn",onClick:O,children:"Cancel"})})]});case"pending":return e.jsxs("div",{className:"transaction-status",children:[e.jsx("div",{className:"status-icon pending",children:e.jsx("div",{className:"spinner"})}),e.jsx("h3",{children:"Transaction Pending"}),e.jsxs("p",{children:["Your transaction is being processed on ",E.name,"."]}),C&&e.jsxs("div",{className:"transaction-hash",children:[e.jsx("p",{children:"Transaction Hash:"}),e.jsxs("code",{children:[C.slice(0,10),"...",C.slice(-8)]})]}),q()&&e.jsx("div",{className:"transaction-explorer",children:e.jsxs("a",{href:q(),target:"_blank",rel:"noopener noreferrer",className:"explorer-link",children:["View on ",E.name," Explorer →"]})}),e.jsx("div",{className:"modal-footer",children:e.jsx("button",{className:"cancel-btn",onClick:O,children:"Close"})})]});case"success":return e.jsxs("div",{className:"transaction-status",children:[e.jsx("div",{className:"status-icon success",children:"✓"}),e.jsx("h3",{children:"Transaction Sent!"}),e.jsxs("p",{children:["Successfully sent ",l," ",E.symbol," to ",(s==null?void 0:s.name)||"recipient"]}),C&&e.jsxs("div",{className:"transaction-hash",children:[e.jsx("p",{children:"Transaction Hash:"}),e.jsxs("code",{children:[C.slice(0,10),"...",C.slice(-8)]})]}),q()&&e.jsx("div",{className:"transaction-explorer",children:e.jsxs("a",{href:q(),target:"_blank",rel:"noopener noreferrer",className:"explorer-link",children:["View on ",E.name," Explorer →"]})}),e.jsx("p",{className:"auto-close",children:"This window will close automatically..."})]});case"error":return e.jsxs("div",{className:"transaction-status",children:[e.jsx("div",{className:"status-icon error",children:"✕"}),e.jsx("h3",{children:"Transaction Failed"}),e.jsx("div",{className:"error-message",children:j}),e.jsxs("div",{className:"modal-footer",children:[e.jsx("button",{className:"cancel-btn",onClick:t,children:"Close"}),e.jsx("button",{className:"retry-btn",onClick:()=>{d("form"),p(null),M()},children:"Try Again"})]})]});default:return null}};return e.jsx("div",{className:"modalOverlay",children:e.jsxs("div",{className:"modalContent transaction-modal",children:[e.jsxs("div",{className:"modal-header",children:[e.jsxs("h2",{children:["Send ",E.symbol]}),(S==="form"||S==="error")&&e.jsx("button",{className:"closeButton",onClick:O,children:e.jsx(te,{size:20})})]}),Ie()]})})},Se=()=>{const[t,s]=i.useState({width:typeof window<"u"?window.innerWidth:0,height:typeof window<"u"?window.innerHeight:0});i.useEffect(()=>{const a=()=>{s({width:window.innerWidth,height:window.innerHeight})};return window.addEventListener("resize",a),()=>window.removeEventListener("resize",a)},[]);const r=t.width<=768,n=t.width>768&&t.width<=1024,o=t.width>1024;return{isMobile:r,isTablet:n,isDesktop:o,windowSize:t}};function ps(){const{address:t}=D(),[s,r]=i.useState(null),[n,o]=i.useState([]),{setCurrentUser:a,currentUser:l}=H(),[v,g]=i.useState(!1),[w,m]=i.useState(!1),[f,S]=i.useState(null),[d,j]=i.useState(null),{isMobile:p}=Se(),[x,c]=i.useState("list");i.useEffect(()=>{(async()=>{try{const N=A(B,"users"),R=(await z(N)).docs.map(L=>({id:L.id,name:L.data().name,wallet:L.data().wallet}));o(R),console.log("Fetched users:",R)}catch(N){console.error("Error fetching users:",N)}})()},[]),i.useEffect(()=>{(async()=>{if(!s){j(null);return}try{const N=await qe(J(B,"privateChats",s));if(N.exists()){const E=N.data();j(E),console.log("Fetched chat data:",E)}else console.error("Chat document not found:",s),j(null)}catch(N){console.error("Error fetching chat data:",N),j(null)}})()},[s]),i.useEffect(()=>{if(n.length>0&&t){const h=n.find(N=>N.wallet===t);console.log("Current User:",h),a(h)}},[n,t,a]);const u=h=>{r(h),p&&c("chat")},b=()=>{p&&(c("list"),r(null))},C=h=>{console.log("New chat created with ID:",h),r(h),p&&c("chat")},T=h=>{const N=n.find(E=>E.id===h);return N?N.wallet:""},I=()=>{const h=M();return h?h.name:"Chat"},M=()=>{if(console.log("Getting recipient user..."),console.log("Selected chat ID:",s),console.log("Current chat data:",d),console.log("Current address:",t),console.log("Available users:",n),!s||!d||!t||n.length===0)return console.log("Missing required data for recipient detection"),null;const h=n.find(R=>R.wallet===t);if(!h)return console.log("Current user not found in users list"),null;console.log("Current user found:",h);const N=d.pid.find(R=>R!==h.id);if(!N)return console.log("Other participant ID not found in chat data"),null;console.log("Other participant ID:",N);const E=n.find(R=>R.id===N);return console.log("Recipient user found:",E),E||null},k=h=>{if(console.log("Handle send transaction called with:",h),!h||!h.wallet||!h.name){console.error("Invalid recipient user:",h);return}S(N=>(console.log("Setting recipient from",N,"to",h),h)),m(N=>(console.log("Setting modal visibility from",N,"to true"),!0))},F=async h=>{if(console.log("Transaction sent:",h),m(!1),S(null),s&&l)try{await hs(h,s,l.id),console.log("Transaction message added to chat")}catch(N){console.error("Failed to add transaction message to chat:",N)}else console.error("Missing chat ID or current user for transaction message")},U=()=>{m(!1),S(null)};return i.useEffect(()=>{const h=M();console.log("Recipient user updated:",h)},[s,d,n,t]),p?e.jsxs("div",{className:"chat mobile-chat",children:[x==="list"?e.jsxs("div",{className:"mobile-chat-list",children:[e.jsx(_,{chatName:"Chats",onBack:b,showBackButton:!1,showProfilePic:!0}),e.jsx("div",{className:"mobile-chat-selector",children:e.jsx(de,{setSelectedChatId:u,users:n,getWalletById:T,selectedChatId:s})}),e.jsx("button",{className:"createChatButton mobile-create-chat",onClick:()=>g(!0),title:"Start new chat",children:e.jsx(le,{size:28})})]}):e.jsxs("div",{className:"mobile-chat-window",children:[e.jsx(_,{chatName:I(),onBack:b,showBackButton:!0}),s&&e.jsx(ue,{selectedChatId:s,onSendTransaction:k,recipientUser:M(),children:e.jsx(he,{selectedChatId:s,users:n,getWalletById:T,onSendTransaction:k,recipientUser:M()})})]}),v&&e.jsx(me,{onClose:()=>g(!1),onChatCreated:C}),w&&f&&e.jsx(fe,{onClose:U,recipientUser:f,onTransactionSent:F})]}):e.jsxs("div",{className:"chat desktop-chat",children:[e.jsx(de,{setSelectedChatId:u,users:n,getWalletById:T,selectedChatId:s}),e.jsx("div",{className:"desktop-chat-area",children:s?e.jsxs(e.Fragment,{children:[e.jsx(_,{chatName:I(),onBack:b,showBackButton:!1}),e.jsx(ue,{selectedChatId:s,onSendTransaction:k,recipientUser:M(),children:e.jsx(he,{selectedChatId:s,users:n,getWalletById:T,onSendTransaction:k,recipientUser:M()})})]}):e.jsxs("div",{className:"desktop-chat-placeholder",children:[e.jsx("h2",{children:"Select a chat to start messaging"}),e.jsx("p",{children:"Choose a conversation from the sidebar or create a new one"})]})}),e.jsx("button",{className:"createChatButton desktop-create-chat",onClick:()=>g(!0),title:"Start new chat",children:e.jsx(le,{size:24})}),v&&e.jsx(me,{onClose:()=>g(!1),onChatCreated:C}),w&&f&&e.jsx(fe,{onClose:U,recipientUser:f,onTransactionSent:F})]})}function xs(){const{address:t}=D(),[s,r]=i.useState(null),n=ne(),o=async a=>{const l=A(B,"users"),v=P(l,$("wallet","==",a));try{const w=!(await z(v)).empty;console.log("User found:",w),r(w),n(w?"/chat":"/signup")}catch(g){console.error("Error checking user:",g),r(!1),n("/signup")}};return e.jsxs("div",{children:[e.jsxs("button",{className:"proceedButton",onClick:()=>{t?o(t):console.error("Address is undefined")},children:[e.jsx(Oe,{size:28}),e.jsx("span",{children:"Proceed"})]}),s!==null&&e.jsx("p",{children:s?"User exists":"User does not exist"})]})}function js(){const{address:t,isConnected:s}=D(),{disconnect:r}=ye(),n=async()=>{localStorage.removeItem("walletconnect"),localStorage.removeItem("walletConnected"),localStorage.removeItem("connectorId"),r()};return e.jsx("div",{className:"wallet-button",children:s&&t?e.jsxs("div",{className:"walletBubble",children:[e.jsxs("div",{className:"address",children:[t.slice(0,6),"...",t.slice(-4)]}),e.jsx("button",{onClick:n,children:e.jsx(te,{size:25})})]}):e.jsx("w3m-connect-button",{})})}function bs(){const{address:t,isConnected:s,connector:r}=D(),{connect:n,connectors:o}=ss();ye();const[a,l]=i.useState(s);ne();const{isMobile:v}=Se();return i.useEffect(()=>{if(localStorage.getItem("walletConnected")==="true"&&!s){console.log("Attempting to reconnect wallet automatically...");const w=localStorage.getItem("connectorId");if(console.log("Last used connector:",w),w){const m=o.find(f=>f.id===w);m&&(console.log("Reconnecting with saved connector:",w),n({connector:m}))}else{const m=o.find(f=>f.id==="injected");m&&(console.log("No saved connector, trying injected..."),n({connector:m}))}}},[n,o,s]),i.useEffect(()=>{console.log("Connection state changed:",s?"connected":"disconnected"),console.log("Current connector:",r==null?void 0:r.id),l(s),s&&!a&&console.log("Wallet newly connected:",t),!s&&a&&console.log("Wallet disconnected")},[s,t,a,r]),i.useEffect(()=>{const g=()=>{a&&!s&&(console.log("Connection lost while page was inactive, updating UI"),l(!1))};return window.addEventListener("focus",g),()=>{window.removeEventListener("focus",g)}},[a,s]),e.jsxs("div",{className:`homepage ${v?"mobile-homepage":"desktop-homepage"}`,children:[e.jsxs("div",{className:"title",children:[e.jsx("h1",{children:"Chat 3.0 is here."}),e.jsx("h2",{children:"Your personal web3 companion."})]}),e.jsx("div",{children:e.jsxs("div",{className:"login",children:[e.jsx("h3",{children:a?`Connected ${r!=null&&r.id?`(${r.id})`:""}`:"Connect your wallet"}),e.jsx(js,{}),a&&e.jsx(xs,{})]})})]})}function ws(){const{address:t}=D(),s=ne(),[r,n]=i.useState(""),[o,a]=i.useState(null),[l,v]=i.useState(!1),[g,w]=i.useState(!1),[m,f]=i.useState(!0);i.useEffect(()=>{(async()=>{if(t){f(!0);try{const x=A(B,"users"),c=P(x,$("wallet","==",t)),b=!(await z(c)).empty;w(b),b&&(console.log("User already exists, redirecting to chat"),s("/chat"))}catch(x){console.error("Error checking if user exists:",x)}finally{f(!1)}}})()},[t,s]);const S=async()=>{const p=A(B,"users"),x=P(p,Q("name"),G(10)),u=(await z(x)).docs.map(b=>({id:b.id,...b.data()}));a({users:u}),console.log("Fetched data:",u)};i.useEffect(()=>{S()},[]);const d=async()=>{if(!t||!r.trim()){console.error("Missing required data: address or name");return}if(g){console.log("User already exists, cannot register again");return}v(!0),console.log("Writing data:",t,r);try{const p=A(B,"users"),x=P(p,$("wallet","==",t));if(!(await z(x)).empty){console.log("User already exists, cannot register"),w(!0),v(!1),s("/chat");return}const u=V(P(p,$("wallet","==",t)),b=>{b.empty||(console.log("User successfully registered, redirecting to chat"),u(),s("/chat"))},b=>{console.error("Error in onSnapshot listener:",b),v(!1)});await se(p,{wallet:t,name:r.trim()}),console.log("Data written successfully"),setTimeout(()=>{u(),l&&(v(!1),console.log("Registration timeout, stopped listening"))},1e4)}catch(p){console.error("Error writing data:",p),v(!1)}},j=p=>{p.key==="Enter"&&!l&&!g&&r.trim()&&d()};return m?e.jsx("div",{className:"centered-signup",children:e.jsxs("div",{className:"welcomeText",children:[e.jsx("h1",{children:"Checking registration status..."}),e.jsx("h2",{children:"Please wait"})]})}):g?e.jsxs("div",{className:"centered-signup",children:[e.jsxs("div",{className:"welcomeText",children:[e.jsx("h1",{children:"Already Registered"}),e.jsx("h2",{children:"You're already signed up! Redirecting to chat..."})]}),e.jsxs("p",{children:["Wallet Address: ",t]})]}):e.jsxs("div",{className:"centered-signup",children:[e.jsxs("div",{className:"welcomeText",children:[e.jsx("h1",{children:"Welcome to Chat 3.0"}),e.jsx("h2",{children:"One last step to start chatting"})]}),e.jsxs("p",{children:["Wallet Address: ",t]}),e.jsxs("div",{className:"signupBox",children:[e.jsx("input",{type:"text",placeholder:"Enter name",value:r,onChange:p=>n(p.target.value),onKeyPress:j,disabled:l,maxLength:50}),e.jsx("button",{onClick:d,disabled:l||!r.trim(),children:l?"Registering...":"Register"})]}),l&&e.jsx("p",{style:{color:"#50b458",marginTop:"10px"},children:"Creating your account, please wait..."})]})}const ys=new $e,Z="02ee764d5cc25cff6387d6d3f7943fd6",X={name:"TokenChat",description:"Web3 Chat Application",url:"https://c4ctus96.github.io/tokenchat",icons:["https://avatars.githubusercontent.com/u/37784886"]},vs=[ae,we,be,je,xe,pe],ke=ts({chains:vs,transports:{[ae.id]:W("https://eth-mainnet.g.alchemy.com/v2/demo"),[we.id]:W("https://bsc-dataseed1.binance.org"),[be.id]:W("https://polygon-rpc.com"),[je.id]:W("https://arb-mainnet.g.alchemy.com/v2/demo"),[xe.id]:W("https://mainnet.optimism.io"),[pe.id]:W("https://mainnet.base.org")},connectors:[ns({projectId:Z,metadata:X,showQrModal:!1}),as({shimDisconnect:!0}),rs({appName:X.name,appLogoUrl:X.icons[0]}),os({options:{projectId:Z},socials:["google","x","github","discord","apple"],showWallets:!0,email:!0,walletFeatures:!1})]});cs({wagmiConfig:ke,projectId:Z,defaultChain:ae,themeMode:"dark",enableAnalytics:!0,enableOnramp:!1,themeVariables:{"--w3m-accent":"#50b458","--w3m-color-mix":"#210059","--w3m-color-mix-strength":30}});function Ns({children:t}){const{isConnected:s}=D();return s?e.jsx(e.Fragment,{children:t}):e.jsx(Ke,{to:"/"})}function Cs(){const{isConnected:t}=D();return i.useEffect(()=>{console.log("App initialized, connection status:",t),typeof window.ethereum>"u"&&console.log("MetaMask not detected, but WalletConnect can still be used")},[t]),null}function Ss(){return e.jsx(is,{config:ke,children:e.jsx(Ve,{client:ys,children:e.jsx(ds,{children:e.jsxs(Qe,{basename:"/tokenchat",children:[e.jsx(Cs,{}),e.jsxs(Ye,{children:[e.jsx(K,{path:"/",element:e.jsx(bs,{})}),e.jsx(K,{path:"/chat",element:e.jsx(Ns,{children:e.jsx(ps,{})})}),e.jsx(K,{path:"/signup",element:e.jsx(ws,{})})]})]})})})})}const ks=document.getElementById("root"),Es=_e(ks);Es.render(e.jsx(ge.StrictMode,{children:e.jsx(Ss,{})}));
//# sourceMappingURL=index-ge8fwJ6w.js.map
