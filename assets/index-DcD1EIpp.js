import{aH as e,aI as V,aJ as Y,aK as $,aE as d,aL as v,aM as N,aN as D,aO as J,aP as L,aQ as S,aR as q,aS as A,aT as B,aU as H,aV as U,aW as _,aX as G,aY as X,aZ as O,a_ as W,aC as M,a$ as Z,b0 as ee,b1 as se,b2 as I,b3 as te,b4 as ne}from"./react-DvB1B-f3.js";import{u as C,a as T,b as oe,c as ae,w as re,i as ce,d as ie,e as le,f as de,W as ue}from"./web3-DKmkEmjZ.js";import"./walletconnect-CjcQPAoj.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const c of document.querySelectorAll('link[rel="modulepreload"]'))n(c);new MutationObserver(c=>{for(const a of c)if(a.type==="childList")for(const l of a.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&n(l)}).observe(document,{childList:!0,subtree:!0});function o(c){const a={};return c.integrity&&(a.integrity=c.integrity),c.referrerPolicy&&(a.referrerPolicy=c.referrerPolicy),c.crossOrigin==="use-credentials"?a.credentials="include":c.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function n(c){if(c.ep)return;c.ep=!0;const a=o(c);fetch(c.href,a)}})();const F=({eth:s})=>e.jsx("div",{children:e.jsx("img",{src:`https://effigy.im/a/${s}.svg`,alt:"Profile picture",className:"profilePic"})});function he(){const{address:s}=C();return e.jsx("div",{className:"ChatSidebar",children:e.jsx("div",{className:"profilePicture",children:s&&e.jsx(F,{eth:s})})})}const me={apiKey:"AIzaSyBRDBbrJbmLwb3YTI_YBmMdTjLEd8KjS2E",authDomain:"tokenchat-b8673.firebaseapp.com",projectId:"tokenchat-b8673",storageBucket:"tokenchat-b8673.appspot.com",messagingSenderId:"593980787293",appId:"1:593980787293:web:7c58ff7656a3fa31b19bb4",measurementId:"G-RB9WJLVQC0"},K=V(me);Y(K);const b=$(K);function fe({setSelectedChatId:s,users:t,getWalletById:o}){const{address:n}=C(),[c,a]=d.useState([]),[l,h]=d.useState(null);d.useEffect(()=>{if(!n)return;(async()=>{try{const i=v(b,"privateChats"),E=(await N(i)).docs.map(y=>{const x=y.data();return{id:y.id,pid:x.pid||[]}});a(E)}catch(i){h("Failed to fetch data. Please check your internet connection."),console.error("Fetch error:",i)}})()},[n]);const u=t.find(m=>m.wallet===n),r=u?c.filter(m=>m.pid.includes(u.id)):[],f=m=>{const i=t.find(j=>j.id===m);return i?i.name:m},g=m=>u&&m.find(i=>i!==u.id)||"",p=m=>{const i=g(m);return f(i)},w=m=>{s(m)};return e.jsxs("div",{className:"chatSelector",children:[l&&e.jsx("p",{className:"error",children:l}),r.length>0?r.map(m=>e.jsxs("div",{className:"contactBox",onClick:()=>w(m.id),children:[e.jsx(F,{eth:o(g(m.pid))}),e.jsxs("div",{className:"contactTextBox",children:[e.jsx("h3",{children:p(m.pid)}),e.jsx("h3",{children:"latest message"})]})]},m.id)):e.jsx("p",{children:"No chatrooms available"})]})}const Q=d.createContext(void 0),ge=({children:s})=>{const[t,o]=d.useState(void 0);return e.jsx(Q.Provider,{value:{currentUser:t,setCurrentUser:o},children:s})},k=()=>{const s=d.useContext(Q);if(!s)throw new Error("useUser must be used within a UserProvider");return s},pe=async(s,t,o)=>{try{const n=v(b,"privateChats",o,"msg");await L(n,{txt:s,from:t,ts:new Date}),console.log("Message sent successfully")}catch(n){console.error("Error sending message:",n)}},xe=({selectedChatId:s})=>{const[t,o]=D.useState(""),{currentUser:n}=k(),c=h=>{o(h.target.value)},a=()=>{if(!s||!n||!t.trim()){console.error("Missing required data:",{selectedChatId:s,currentUser:n,inputValue:t});return}pe(t,n.id,s),o("")},l=h=>{h.key==="Enter"&&a()};return e.jsxs("div",{className:"chatBottomBar",children:[e.jsx("input",{type:"text",className:"messageInput",placeholder:"Type your message",value:t,onChange:c,onKeyDown:l}),e.jsx("button",{className:"sendMessageButton",onClick:a,disabled:!s||!n,title:"Send message",children:e.jsx(J,{size:20})})]})};function je({children:s,selectedChatId:t}){return e.jsxs("div",{className:"chatWindow",children:[e.jsx("div",{className:"chatContent",children:s})," ",e.jsx(xe,{selectedChatId:t})]})}const Ce=({text:s,timeStamp:t,from:o,own:n})=>e.jsx("div",{className:"messageBox",children:e.jsxs("div",{className:`message ${n?"own":""}`,children:[e.jsx("p",{className:"message-text",children:s}),e.jsx("p",{className:"message-timestamp",children:new Date(t).toLocaleString()})]})});function ye({selectedChatId:s,users:t,getWalletById:o}){const[n,c]=d.useState([]),{address:a}=C(),{currentUser:l}=k(),h=d.useRef(null),u=()=>{var r;(r=h.current)==null||r.scrollIntoView({behavior:"smooth"})};return d.useEffect(()=>{u()},[n]),d.useEffect(()=>{if(!s)return;const r=v(b,"privateChats",s,"msg"),f=S(r,q("ts","asc")),g=A(f,p=>{const w=[];p.forEach(m=>{const i=m.data();i.txt&&i.ts&&i.from?w.push(i):console.log("Missing fields in document:",m.id)}),console.log("Real-time Messages Update:",w),c(w)},p=>{console.error("Error fetching messages:",p)});return()=>g()},[s]),e.jsxs("div",{className:"chatContent",children:[n.map((r,f)=>{const g=l!=null&&l.id?r.from===l.id:!1;return e.jsx(Ce,{text:r.txt,timeStamp:r.ts.toMillis(),from:r.from,own:g},f)}),e.jsx("div",{ref:h})," "]})}function we(){const{address:s}=C(),[t,o]=d.useState(null),[n,c]=d.useState([]),{setCurrentUser:a}=k();d.useEffect(()=>{(async()=>{const r=v(b,"users"),g=(await N(r)).docs.map(p=>({id:p.id,name:p.data().name,wallet:p.data().wallet}));c(g)})()},[]),d.useEffect(()=>{if(n.length>0&&s){const u=n.find(r=>r.wallet===s);console.log("Current User:",u),a(u)}},[n,s,a]);const l=u=>{o(u)},h=u=>{const r=n.find(f=>f.id===u);return r?r.wallet:""};return e.jsxs("div",{className:"chat",children:[e.jsx(he,{}),e.jsx(fe,{setSelectedChatId:l,users:n,getWalletById:h}),e.jsx(je,{selectedChatId:t||void 0,children:t&&e.jsx(ye,{selectedChatId:t,users:n,getWalletById:h})})]})}function ve(){const{address:s}=C(),[t,o]=d.useState(null),n=B(),c=async a=>{const l=v(b,"users"),h=S(l,U("wallet","==",a));try{const r=!(await N(h)).empty;console.log("User found:",r),o(r),n(r?"/chat":"/signup")}catch(u){console.error("Error checking user:",u),o(!1),n("/signup")}};return e.jsxs("div",{children:[e.jsxs("button",{className:"proceedButton",onClick:()=>{s?c(s):console.error("Address is undefined")},children:[e.jsx(H,{size:28}),e.jsx("span",{children:"Proceed"})]}),t!==null&&e.jsx("p",{children:t?"User exists":"User does not exist"})]})}function be(){const{address:s,isConnected:t}=C(),{disconnect:o}=T(),n=async()=>{localStorage.removeItem("walletconnect"),localStorage.removeItem("walletConnected"),localStorage.removeItem("connectorId"),o()};return e.jsx("div",{className:"wallet-button",children:t&&s?e.jsxs("div",{className:"walletBubble",children:[e.jsxs("div",{className:"address",children:[s.slice(0,6),"...",s.slice(-4)]}),e.jsx("button",{onClick:n,children:e.jsx(_,{size:25})})]}):e.jsx("w3m-connect-button",{})})}function Se(){const{address:s,isConnected:t,connector:o}=C(),{connect:n,connectors:c}=oe();T();const[a,l]=d.useState(t);return B(),d.useEffect(()=>{if(localStorage.getItem("walletConnected")==="true"&&!t){console.log("Attempting to reconnect wallet automatically...");const u=localStorage.getItem("connectorId");if(console.log("Last used connector:",u),u){const r=c.find(f=>f.id===u);r&&(console.log("Reconnecting with saved connector:",u),n({connector:r}))}else{const r=c.find(f=>f.id==="injected");r&&(console.log("No saved connector, trying injected..."),n({connector:r}))}}},[n,c,t]),d.useEffect(()=>{console.log("Connection state changed:",t?"connected":"disconnected"),console.log("Current connector:",o==null?void 0:o.id),l(t),t&&!a&&console.log("Wallet newly connected:",s),!t&&a&&console.log("Wallet disconnected")},[t,s,a,o]),d.useEffect(()=>{const h=()=>{a&&!t&&(console.log("Connection lost while page was inactive, updating UI"),l(!1))};return window.addEventListener("focus",h),()=>{window.removeEventListener("focus",h)}},[a,t]),e.jsxs("div",{className:"homepage",children:[e.jsxs("div",{className:"title",children:[e.jsx("h1",{children:"Chat 3.0 is here."}),e.jsx("h2",{children:"Your personal web3 companion."})]}),e.jsx("div",{children:e.jsxs("div",{className:"login",children:[e.jsx("h3",{children:a?`Connected ${o!=null&&o.id?`(${o.id})`:""}`:"Connect your wallet"}),e.jsx(be,{}),a&&e.jsx(ve,{})]})})]})}function Ne(){const{address:s}=C(),t=B(),[o,n]=d.useState(""),[c,a]=d.useState(null),[l,h]=d.useState(!1),[u,r]=d.useState(!1),[f,g]=d.useState(!0);d.useEffect(()=>{(async()=>{if(s){g(!0);try{const j=v(b,"users"),E=S(j,U("wallet","==",s)),x=!(await N(E)).empty;r(x),x&&(console.log("User already exists, redirecting to chat"),t("/chat"))}catch(j){console.error("Error checking if user exists:",j)}finally{g(!1)}}})()},[s,t]);const p=async()=>{const i=v(b,"users"),j=S(i,q("name"),G(10)),y=(await N(j)).docs.map(x=>({id:x.id,...x.data()}));a({users:y}),console.log("Fetched data:",y)};d.useEffect(()=>{p()},[]);const w=async()=>{if(!s||!o.trim()){console.error("Missing required data: address or name");return}if(u){console.log("User already exists, cannot register again");return}h(!0),console.log("Writing data:",s,o);try{const i=v(b,"users"),j=S(i,U("wallet","==",s));if(!(await N(j)).empty){console.log("User already exists, cannot register"),r(!0),h(!1),t("/chat");return}const y=A(S(i,U("wallet","==",s)),x=>{x.empty||(console.log("User successfully registered, redirecting to chat"),y(),t("/chat"))},x=>{console.error("Error in onSnapshot listener:",x),h(!1)});await L(i,{wallet:s,name:o.trim()}),console.log("Data written successfully"),setTimeout(()=>{y(),l&&(h(!1),console.log("Registration timeout, stopped listening"))},1e4)}catch(i){console.error("Error writing data:",i),h(!1)}},m=i=>{i.key==="Enter"&&!l&&!u&&o.trim()&&w()};return f?e.jsx("div",{className:"centered-signup",children:e.jsxs("div",{className:"welcomeText",children:[e.jsx("h1",{children:"Checking registration status..."}),e.jsx("h2",{children:"Please wait"})]})}):u?e.jsxs("div",{className:"centered-signup",children:[e.jsxs("div",{className:"welcomeText",children:[e.jsx("h1",{children:"Already Registered"}),e.jsx("h2",{children:"You're already signed up! Redirecting to chat..."})]}),e.jsxs("p",{children:["Wallet Address: ",s]})]}):e.jsxs("div",{className:"centered-signup",children:[e.jsxs("div",{className:"welcomeText",children:[e.jsx("h1",{children:"Welcome to Chat 3.0"}),e.jsx("h2",{children:"One last step to start chatting"})]}),e.jsxs("p",{children:["Wallet Address: ",s]}),e.jsxs("div",{className:"signupBox",children:[e.jsx("input",{type:"text",placeholder:"Enter name",value:o,onChange:i=>n(i.target.value),onKeyPress:m,disabled:l,maxLength:50}),e.jsx("button",{onClick:w,disabled:l||!o.trim(),children:l?"Registering...":"Register"})]}),l&&e.jsx("p",{style:{color:"#50b458",marginTop:"10px"},children:"Creating your account, please wait..."})]})}const Ee=new X,R="02ee764d5cc25cff6387d6d3f7943fd6",P={name:"TokenChat",description:"Web3 Chat Application",url:"https://c4ctus96.github.io/tokenchat",icons:["https://avatars.githubusercontent.com/u/37784886"]},Ue=[M,O],z=ae({chains:Ue,transports:{[M.id]:W("https://eth-mainnet.g.alchemy.com/v2/demo"),[O.id]:W("https://arb-mainnet.g.alchemy.com/v2/demo")},connectors:[re({projectId:R,metadata:P,showQrModal:!1}),ce({shimDisconnect:!0}),ie({appName:P.name,appLogoUrl:P.icons[0]}),le({options:{projectId:R},socials:["google","x","github","discord","apple"],showWallets:!0,email:!0,walletFeatures:!1})]});de({wagmiConfig:z,projectId:R,defaultChain:M,themeMode:"dark",enableAnalytics:!0,enableOnramp:!1,themeVariables:{"--w3m-accent":"#50b458","--w3m-color-mix":"#210059","--w3m-color-mix-strength":30}});function Ie({children:s}){const{isConnected:t}=C();return t?e.jsx(e.Fragment,{children:s}):e.jsx(te,{to:"/"})}function Pe(){const{isConnected:s}=C();return d.useEffect(()=>{console.log("App initialized, connection status:",s),typeof window.ethereum>"u"&&console.log("MetaMask not detected, but WalletConnect can still be used")},[s]),null}function Re(){return e.jsx(ue,{config:z,children:e.jsx(Z,{client:Ee,children:e.jsx(ge,{children:e.jsxs(ee,{basename:"/tokenchat",children:[e.jsx(Pe,{}),e.jsxs(se,{children:[e.jsx(I,{path:"/",element:e.jsx(Se,{})}),e.jsx(I,{path:"/chat",element:e.jsx(Ie,{children:e.jsx(we,{})})}),e.jsx(I,{path:"/signup",element:e.jsx(Ne,{})})]})]})})})})}const Be=document.getElementById("root"),Me=ne(Be);Me.render(e.jsx(D.StrictMode,{children:e.jsx(Re,{})}));
//# sourceMappingURL=index-DcD1EIpp.js.map
